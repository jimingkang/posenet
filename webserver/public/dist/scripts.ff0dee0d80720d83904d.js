!function(root,factory){"function"==typeof define&&define.amd?define("easyrtc_lang",factory):"object"==typeof module&&module.exports?module.exports=factory():root.easyrtc_lang=factory()}(this,function(undefined){"use strict";return{unableToEnterRoom:"Unable to enter room {0} because {1}",resolutionWarning:"Requested video size of {0}x{1} but got size of {2}x{3}",badUserName:"Illegal username {0}",localMediaError:"Error getting local media stream: {0}",miscSignalError:"Miscellaneous error from signalling server. It may be ignorable.",noServer:"Unable to reach the EasyRTC signalling server.",badsocket:"Socket.io connect event fired with bad websocket.",icf:"Internal communications failure",statsNotSupported:"call statistics not supported by this browser, try Chrome.",noWebrtcSupport:"Your browser doesn't appear to support WebRTC.",gumFailed:"Failed to get access to local media. Error code was {0}.",requireAudioOrVideo:"At least one of audio and video must be provided"}}),function(f){"object"==typeof exports&&"undefined"!=typeof module?module.exports=f():"function"==typeof define&&define.amd?define("webrtc-adapter",[],f):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).adapter=f()}(function(){return function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){return o(e[i][1][r]||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(require,module,exports){var adapter=(0,require("./adapter_factory.js").adapterFactory)({window:window});module.exports=adapter},{"./adapter_factory.js":2}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.adapterFactory=function(){var window=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).window,options=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},logging=utils.log,browserDetails=utils.detectBrowser(window),adapter={browserDetails:browserDetails,commonShim:commonShim,extractVersion:utils.extractVersion,disableLog:utils.disableLog,disableWarnings:utils.disableWarnings};switch(browserDetails.browser){case"chrome":if(!chromeShim||!chromeShim.shimPeerConnection||!options.shimChrome)return logging("Chrome shim is not included in this adapter release."),adapter;logging("adapter.js shimming chrome."),adapter.browserShim=chromeShim,chromeShim.shimGetUserMedia(window),chromeShim.shimMediaStream(window),chromeShim.shimPeerConnection(window),chromeShim.shimOnTrack(window),chromeShim.shimAddTrackRemoveTrack(window),chromeShim.shimGetSendersWithDtmf(window),chromeShim.shimGetStats(window),chromeShim.shimSenderReceiverGetStats(window),chromeShim.fixNegotiationNeeded(window),commonShim.shimRTCIceCandidate(window),commonShim.shimConnectionState(window),commonShim.shimMaxMessageSize(window),commonShim.shimSendThrowTypeError(window),commonShim.removeAllowExtmapMixed(window);break;case"firefox":if(!firefoxShim||!firefoxShim.shimPeerConnection||!options.shimFirefox)return logging("Firefox shim is not included in this adapter release."),adapter;logging("adapter.js shimming firefox."),adapter.browserShim=firefoxShim,firefoxShim.shimGetUserMedia(window),firefoxShim.shimPeerConnection(window),firefoxShim.shimOnTrack(window),firefoxShim.shimRemoveStream(window),firefoxShim.shimSenderGetStats(window),firefoxShim.shimReceiverGetStats(window),firefoxShim.shimRTCDataChannel(window),firefoxShim.shimAddTransceiver(window),firefoxShim.shimCreateOffer(window),firefoxShim.shimCreateAnswer(window),commonShim.shimRTCIceCandidate(window),commonShim.shimConnectionState(window),commonShim.shimMaxMessageSize(window),commonShim.shimSendThrowTypeError(window);break;case"edge":if(!edgeShim||!edgeShim.shimPeerConnection||!options.shimEdge)return logging("MS edge shim is not included in this adapter release."),adapter;logging("adapter.js shimming edge."),adapter.browserShim=edgeShim,edgeShim.shimGetUserMedia(window),edgeShim.shimGetDisplayMedia(window),edgeShim.shimPeerConnection(window),edgeShim.shimReplaceTrack(window),commonShim.shimMaxMessageSize(window),commonShim.shimSendThrowTypeError(window);break;case"safari":if(!safariShim||!options.shimSafari)return logging("Safari shim is not included in this adapter release."),adapter;logging("adapter.js shimming safari."),adapter.browserShim=safariShim,safariShim.shimRTCIceServerUrls(window),safariShim.shimCreateOfferLegacy(window),safariShim.shimCallbacksAPI(window),safariShim.shimLocalStreamsAPI(window),safariShim.shimRemoteStreamsAPI(window),safariShim.shimTrackEventTransceiver(window),safariShim.shimGetUserMedia(window),commonShim.shimRTCIceCandidate(window),commonShim.shimMaxMessageSize(window),commonShim.shimSendThrowTypeError(window),commonShim.removeAllowExtmapMixed(window);break;default:logging("Unsupported browser!")}return adapter};var utils=_interopRequireWildcard(require("./utils")),chromeShim=_interopRequireWildcard(require("./chrome/chrome_shim")),edgeShim=_interopRequireWildcard(require("./edge/edge_shim")),firefoxShim=_interopRequireWildcard(require("./firefox/firefox_shim")),safariShim=_interopRequireWildcard(require("./safari/safari_shim")),commonShim=_interopRequireWildcard(require("./common_shim"));function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj}},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0}),exports.shimGetDisplayMedia=exports.shimGetUserMedia=void 0;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_getusermedia=require("./getusermedia");Object.defineProperty(exports,"shimGetUserMedia",{enumerable:!0,get:function(){return _getusermedia.shimGetUserMedia}});var _getdisplaymedia=require("./getdisplaymedia");Object.defineProperty(exports,"shimGetDisplayMedia",{enumerable:!0,get:function(){return _getdisplaymedia.shimGetDisplayMedia}}),exports.shimMediaStream=function(window){window.MediaStream=window.MediaStream||window.webkitMediaStream},exports.shimOnTrack=function(window){if("object"!==(void 0===window?"undefined":_typeof(window))||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype)utils.wrapPeerConnectionEvent(window,"track",function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e});else{Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(f){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=f)},enumerable:!0,configurable:!0});var origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(){var _this=this;return this._ontrackpoly||(this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(te){var receiver;receiver=window.RTCPeerConnection.prototype.getReceivers?_this.getReceivers().find(function(r){return r.track&&r.track.id===te.track.id}):{track:te.track};var event=new Event("track");event.track=te.track,event.receiver=receiver,event.transceiver={receiver:receiver},event.streams=[e.stream],_this.dispatchEvent(event)}),e.stream.getTracks().forEach(function(track){var receiver;receiver=window.RTCPeerConnection.prototype.getReceivers?_this.getReceivers().find(function(r){return r.track&&r.track.id===track.id}):{track:track};var event=new Event("track");event.track=track,event.receiver=receiver,event.transceiver={receiver:receiver},event.streams=[e.stream],_this.dispatchEvent(event)})},this.addEventListener("addstream",this._ontrackpoly)),origSetRemoteDescription.apply(this,arguments)}}},exports.shimGetSendersWithDtmf=function(window){if("object"===(void 0===window?"undefined":_typeof(window))&&window.RTCPeerConnection&&!("getSenders"in window.RTCPeerConnection.prototype)&&"createDTMFSender"in window.RTCPeerConnection.prototype){var shimSenderWithDtmf=function(pc,track){return{track:track,get dtmf(){return void 0===this._dtmf&&(this._dtmf="audio"===track.kind?pc.createDTMFSender(track):null),this._dtmf},_pc:pc}};if(!window.RTCPeerConnection.prototype.getSenders){window.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var origAddTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addTrack=function(track,stream){var sender=origAddTrack.apply(this,arguments);return sender||(sender=shimSenderWithDtmf(this,track),this._senders.push(sender)),sender};var origRemoveTrack=window.RTCPeerConnection.prototype.removeTrack;window.RTCPeerConnection.prototype.removeTrack=function(sender){origRemoveTrack.apply(this,arguments);var idx=this._senders.indexOf(sender);-1!==idx&&this._senders.splice(idx,1)}}var origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function(stream){var _this2=this;this._senders=this._senders||[],origAddStream.apply(this,[stream]),stream.getTracks().forEach(function(track){_this2._senders.push(shimSenderWithDtmf(_this2,track))})};var origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function(stream){var _this3=this;this._senders=this._senders||[],origRemoveStream.apply(this,[stream]),stream.getTracks().forEach(function(track){var sender=_this3._senders.find(function(s){return s.track===track});sender&&_this3._senders.splice(_this3._senders.indexOf(sender),1)})}}else if("object"===(void 0===window?"undefined":_typeof(window))&&window.RTCPeerConnection&&"getSenders"in window.RTCPeerConnection.prototype&&"createDTMFSender"in window.RTCPeerConnection.prototype&&window.RTCRtpSender&&!("dtmf"in window.RTCRtpSender.prototype)){var origGetSenders=window.RTCPeerConnection.prototype.getSenders;window.RTCPeerConnection.prototype.getSenders=function(){var _this4=this,senders=origGetSenders.apply(this,[]);return senders.forEach(function(sender){return sender._pc=_this4}),senders},Object.defineProperty(window.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&(this._dtmf="audio"===this.track.kind?this._pc.createDTMFSender(this.track):null),this._dtmf}})}},exports.shimGetStats=function(window){if(window.RTCPeerConnection){var origGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function(){var _this5=this,_arguments=Array.prototype.slice.call(arguments),selector=_arguments[0],onSucc=_arguments[1],onErr=_arguments[2];if(arguments.length>0&&"function"==typeof selector)return origGetStats.apply(this,arguments);if(0===origGetStats.length&&(0===arguments.length||"function"!=typeof selector))return origGetStats.apply(this,[]);var fixChromeStats_=function(response){var standardReport={};return response.result().forEach(function(report){var standardStats={id:report.id,timestamp:report.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[report.type]||report.type};report.names().forEach(function(name){standardStats[name]=report.stat(name)}),standardReport[standardStats.id]=standardStats}),standardReport},makeMapStats=function(stats){return new Map(Object.keys(stats).map(function(key){return[key,stats[key]]}))};if(arguments.length>=2){var successCallbackWrapper_=function(response){onSucc(makeMapStats(fixChromeStats_(response)))};return origGetStats.apply(this,[successCallbackWrapper_,selector])}return new Promise(function(resolve,reject){origGetStats.apply(_this5,[function(response){resolve(makeMapStats(fixChromeStats_(response)))},reject])}).then(onSucc,onErr)}}},exports.shimSenderReceiverGetStats=function(window){if("object"===(void 0===window?"undefined":_typeof(window))&&window.RTCPeerConnection&&window.RTCRtpSender&&window.RTCRtpReceiver){if(!("getStats"in window.RTCRtpSender.prototype)){var origGetSenders=window.RTCPeerConnection.prototype.getSenders;origGetSenders&&(window.RTCPeerConnection.prototype.getSenders=function(){var _this6=this,senders=origGetSenders.apply(this,[]);return senders.forEach(function(sender){return sender._pc=_this6}),senders});var origAddTrack=window.RTCPeerConnection.prototype.addTrack;origAddTrack&&(window.RTCPeerConnection.prototype.addTrack=function(){var sender=origAddTrack.apply(this,arguments);return sender._pc=this,sender}),window.RTCRtpSender.prototype.getStats=function(){var sender=this;return this._pc.getStats().then(function(result){return utils.filterStats(result,sender.track,!0)})}}if(!("getStats"in window.RTCRtpReceiver.prototype)){var origGetReceivers=window.RTCPeerConnection.prototype.getReceivers;origGetReceivers&&(window.RTCPeerConnection.prototype.getReceivers=function(){var _this7=this,receivers=origGetReceivers.apply(this,[]);return receivers.forEach(function(receiver){return receiver._pc=_this7}),receivers}),utils.wrapPeerConnectionEvent(window,"track",function(e){return e.receiver._pc=e.srcElement,e}),window.RTCRtpReceiver.prototype.getStats=function(){var receiver=this;return this._pc.getStats().then(function(result){return utils.filterStats(result,receiver.track,!1)})}}if("getStats"in window.RTCRtpSender.prototype&&"getStats"in window.RTCRtpReceiver.prototype){var origGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof window.MediaStreamTrack){var track=arguments[0],sender=void 0,receiver=void 0,err=void 0;return this.getSenders().forEach(function(s){s.track===track&&(sender?err=!0:sender=s)}),this.getReceivers().forEach(function(r){return r.track===track&&(receiver?err=!0:receiver=r),r.track===track}),err||sender&&receiver?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):sender?sender.getStats():receiver?receiver.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return origGetStats.apply(this,arguments)}}}},exports.shimAddTrackRemoveTrackWithNative=shimAddTrackRemoveTrackWithNative,exports.shimAddTrackRemoveTrack=function(window){if(window.RTCPeerConnection){var browserDetails=utils.detectBrowser(window);if(window.RTCPeerConnection.prototype.addTrack&&browserDetails.version>=65)return shimAddTrackRemoveTrackWithNative(window);var origGetLocalStreams=window.RTCPeerConnection.prototype.getLocalStreams;window.RTCPeerConnection.prototype.getLocalStreams=function(){var _this11=this,nativeStreams=origGetLocalStreams.apply(this);return this._reverseStreams=this._reverseStreams||{},nativeStreams.map(function(stream){return _this11._reverseStreams[stream.id]})};var origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function(stream){var _this12=this;if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},stream.getTracks().forEach(function(track){if(_this12.getSenders().find(function(s){return s.track===track}))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[stream.id]){var newStream=new window.MediaStream(stream.getTracks());this._streams[stream.id]=newStream,this._reverseStreams[newStream.id]=stream,stream=newStream}origAddStream.apply(this,[stream])};var origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function(stream){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},origRemoveStream.apply(this,[this._streams[stream.id]||stream]),delete this._reverseStreams[this._streams[stream.id]?this._streams[stream.id].id:stream.id],delete this._streams[stream.id]},window.RTCPeerConnection.prototype.addTrack=function(track,stream){var _this13=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var streams=[].slice.call(arguments,1);if(1!==streams.length||!streams[0].getTracks().find(function(t){return t===track}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var alreadyExists=this.getSenders().find(function(s){return s.track===track});if(alreadyExists)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var oldStream=this._streams[stream.id];if(oldStream)oldStream.addTrack(track),Promise.resolve().then(function(){_this13.dispatchEvent(new Event("negotiationneeded"))});else{var newStream=new window.MediaStream([track]);this._streams[stream.id]=newStream,this._reverseStreams[newStream.id]=stream,this.addStream(newStream)}return this.getSenders().find(function(s){return s.track===track})},["createOffer","createAnswer"].forEach(function(method){var nativeMethod=window.RTCPeerConnection.prototype[method],methodObj=_defineProperty({},method,function(){var _this14=this,args=arguments,isLegacyCall=arguments.length&&"function"==typeof arguments[0];return isLegacyCall?nativeMethod.apply(this,[function(description){var desc=replaceInternalStreamId(_this14,description);args[0].apply(null,[desc])},function(err){args[1]&&args[1].apply(null,err)},arguments[2]]):nativeMethod.apply(this,arguments).then(function(description){return replaceInternalStreamId(_this14,description)})});window.RTCPeerConnection.prototype[method]=methodObj[method]});var origSetLocalDescription=window.RTCPeerConnection.prototype.setLocalDescription;window.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=replaceExternalStreamId(this,arguments[0]),origSetLocalDescription.apply(this,arguments)):origSetLocalDescription.apply(this,arguments)};var origLocalDescription=Object.getOwnPropertyDescriptor(window.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(window.RTCPeerConnection.prototype,"localDescription",{get:function(){var description=origLocalDescription.get.apply(this);return""===description.type?description:replaceInternalStreamId(this,description)}}),window.RTCPeerConnection.prototype.removeTrack=function(sender){var _this15=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!sender._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(sender._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var stream=void 0;Object.keys(this._streams).forEach(function(streamid){_this15._streams[streamid].getTracks().find(function(track){return sender.track===track})&&(stream=_this15._streams[streamid])}),stream&&(1===stream.getTracks().length?this.removeStream(this._reverseStreams[stream.id]):stream.removeTrack(sender.track),this.dispatchEvent(new Event("negotiationneeded")))}}function replaceInternalStreamId(pc,description){var sdp=description.sdp;return Object.keys(pc._reverseStreams||[]).forEach(function(internalId){var externalStream=pc._reverseStreams[internalId];sdp=sdp.replace(new RegExp(pc._streams[externalStream.id].id,"g"),externalStream.id)}),new RTCSessionDescription({type:description.type,sdp:sdp})}function replaceExternalStreamId(pc,description){var sdp=description.sdp;return Object.keys(pc._reverseStreams||[]).forEach(function(internalId){var externalStream=pc._reverseStreams[internalId],internalStream=pc._streams[externalStream.id];sdp=sdp.replace(new RegExp(externalStream.id,"g"),internalStream.id)}),new RTCSessionDescription({type:description.type,sdp:sdp})}},exports.shimPeerConnection=function(window){var browserDetails=utils.detectBrowser(window);if(!window.RTCPeerConnection&&window.webkitRTCPeerConnection&&(window.RTCPeerConnection=window.webkitRTCPeerConnection),window.RTCPeerConnection){browserDetails.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var nativeMethod=window.RTCPeerConnection.prototype[method],methodObj=_defineProperty({},method,function(){return arguments[0]=new("addIceCandidate"===method?window.RTCIceCandidate:window.RTCSessionDescription)(arguments[0]),nativeMethod.apply(this,arguments)});window.RTCPeerConnection.prototype[method]=methodObj[method]});var nativeAddIceCandidate=window.RTCPeerConnection.prototype.addIceCandidate;window.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?browserDetails.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():nativeAddIceCandidate.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}},exports.fixNegotiationNeeded=function(window){utils.wrapPeerConnectionEvent(window,"negotiationneeded",function(e){if("stable"===e.target.signalingState)return e})};var utils=function(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj}(require("../utils.js"));function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function shimAddTrackRemoveTrackWithNative(window){window.RTCPeerConnection.prototype.getLocalStreams=function(){var _this8=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(streamId){return _this8._shimmedLocalStreams[streamId][0]})};var origAddTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addTrack=function(track,stream){if(!stream)return origAddTrack.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var sender=origAddTrack.apply(this,arguments);return this._shimmedLocalStreams[stream.id]?-1===this._shimmedLocalStreams[stream.id].indexOf(sender)&&this._shimmedLocalStreams[stream.id].push(sender):this._shimmedLocalStreams[stream.id]=[stream,sender],sender};var origAddStream=window.RTCPeerConnection.prototype.addStream;window.RTCPeerConnection.prototype.addStream=function(stream){var _this9=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},stream.getTracks().forEach(function(track){if(_this9.getSenders().find(function(s){return s.track===track}))throw new DOMException("Track already exists.","InvalidAccessError")});var existingSenders=this.getSenders();origAddStream.apply(this,arguments);var newSenders=this.getSenders().filter(function(newSender){return-1===existingSenders.indexOf(newSender)});this._shimmedLocalStreams[stream.id]=[stream].concat(newSenders)};var origRemoveStream=window.RTCPeerConnection.prototype.removeStream;window.RTCPeerConnection.prototype.removeStream=function(stream){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[stream.id],origRemoveStream.apply(this,arguments)};var origRemoveTrack=window.RTCPeerConnection.prototype.removeTrack;window.RTCPeerConnection.prototype.removeTrack=function(sender){var _this10=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},sender&&Object.keys(this._shimmedLocalStreams).forEach(function(streamId){var idx=_this10._shimmedLocalStreams[streamId].indexOf(sender);-1!==idx&&_this10._shimmedLocalStreams[streamId].splice(idx,1),1===_this10._shimmedLocalStreams[streamId].length&&delete _this10._shimmedLocalStreams[streamId]}),origRemoveTrack.apply(this,arguments)}}},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0}),exports.shimGetDisplayMedia=function(window,getSourceId){window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices||window.navigator.mediaDevices&&("function"==typeof getSourceId?window.navigator.mediaDevices.getDisplayMedia=function(constraints){return getSourceId(constraints).then(function(sourceId){var widthSpecified=constraints.video&&constraints.video.width,heightSpecified=constraints.video&&constraints.video.height;return constraints.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:sourceId,maxFrameRate:constraints.video&&constraints.video.frameRate||3}},widthSpecified&&(constraints.video.mandatory.maxWidth=widthSpecified),heightSpecified&&(constraints.video.mandatory.maxHeight=heightSpecified),window.navigator.mediaDevices.getUserMedia(constraints)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}},{}],5:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.shimGetUserMedia=function(window){var navigator=window&&window.navigator;if(navigator.mediaDevices){var browserDetails=utils.detectBrowser(window),constraintsToChrome_=function(c){if("object"!==(void 0===c?"undefined":_typeof(c))||c.mandatory||c.optional)return c;var cc={};return Object.keys(c).forEach(function(key){if("require"!==key&&"advanced"!==key&&"mediaSource"!==key){var r="object"===_typeof(c[key])?c[key]:{ideal:c[key]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var oldname_=function(prefix,name){return prefix?prefix+name.charAt(0).toUpperCase()+name.slice(1):"deviceId"===name?"sourceId":name};if(void 0!==r.ideal){cc.optional=cc.optional||[];var oc={};"number"==typeof r.ideal?(oc[oldname_("min",key)]=r.ideal,cc.optional.push(oc),(oc={})[oldname_("max",key)]=r.ideal,cc.optional.push(oc)):(oc[oldname_("",key)]=r.ideal,cc.optional.push(oc))}void 0!==r.exact&&"number"!=typeof r.exact?(cc.mandatory=cc.mandatory||{},cc.mandatory[oldname_("",key)]=r.exact):["min","max"].forEach(function(mix){void 0!==r[mix]&&(cc.mandatory=cc.mandatory||{},cc.mandatory[oldname_(mix,key)]=r[mix])})}}),c.advanced&&(cc.optional=(cc.optional||[]).concat(c.advanced)),cc},shimConstraints_=function(constraints,func){if(browserDetails.version>=61)return func(constraints);if((constraints=JSON.parse(JSON.stringify(constraints)))&&"object"===_typeof(constraints.audio)){var remap=function(obj,a,b){a in obj&&!(b in obj)&&(obj[b]=obj[a],delete obj[a])};remap((constraints=JSON.parse(JSON.stringify(constraints))).audio,"autoGainControl","googAutoGainControl"),remap(constraints.audio,"noiseSuppression","googNoiseSuppression"),constraints.audio=constraintsToChrome_(constraints.audio)}if(constraints&&"object"===_typeof(constraints.video)){var face=constraints.video.facingMode;face=face&&("object"===(void 0===face?"undefined":_typeof(face))?face:{ideal:face});var getSupportedFacingModeLies=browserDetails.version<66;if(face&&("user"===face.exact||"environment"===face.exact||"user"===face.ideal||"environment"===face.ideal)&&(!navigator.mediaDevices.getSupportedConstraints||!navigator.mediaDevices.getSupportedConstraints().facingMode||getSupportedFacingModeLies)){delete constraints.video.facingMode;var matches=void 0;if("environment"===face.exact||"environment"===face.ideal?matches=["back","rear"]:"user"!==face.exact&&"user"!==face.ideal||(matches=["front"]),matches)return navigator.mediaDevices.enumerateDevices().then(function(devices){var dev=(devices=devices.filter(function(d){return"videoinput"===d.kind})).find(function(d){return matches.some(function(match){return d.label.toLowerCase().includes(match)})});return!dev&&devices.length&&matches.includes("back")&&(dev=devices[devices.length-1]),dev&&(constraints.video.deviceId=face.exact?{exact:dev.deviceId}:{ideal:dev.deviceId}),constraints.video=constraintsToChrome_(constraints.video),logging("chrome: "+JSON.stringify(constraints)),func(constraints)})}constraints.video=constraintsToChrome_(constraints.video)}return logging("chrome: "+JSON.stringify(constraints)),func(constraints)},shimError_=function(e){return browserDetails.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};if(navigator.getUserMedia=(function(constraints,onSuccess,onError){shimConstraints_(constraints,function(c){navigator.webkitGetUserMedia(c,onSuccess,function(e){onError&&onError(shimError_(e))})})}).bind(navigator),navigator.mediaDevices.getUserMedia){var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(cs){return shimConstraints_(cs,function(c){return origGetUserMedia(c).then(function(stream){if(c.audio&&!stream.getAudioTracks().length||c.video&&!stream.getVideoTracks().length)throw stream.getTracks().forEach(function(track){track.stop()}),new DOMException("","NotFoundError");return stream},function(e){return Promise.reject(shimError_(e))})})}}}};var utils=function(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj}(require("../utils.js")),logging=utils.log},{"../utils.js":15}],6:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.shimRTCIceCandidate=function(window){if(window.RTCIceCandidate&&!(window.RTCIceCandidate&&"foundation"in window.RTCIceCandidate.prototype)){var NativeRTCIceCandidate=window.RTCIceCandidate;window.RTCIceCandidate=function(args){if("object"===(void 0===args?"undefined":_typeof(args))&&args.candidate&&0===args.candidate.indexOf("a=")&&((args=JSON.parse(JSON.stringify(args))).candidate=args.candidate.substr(2)),args.candidate&&args.candidate.length){var nativeCandidate=new NativeRTCIceCandidate(args),parsedCandidate=_sdp2.default.parseCandidate(args.candidate),augmentedCandidate=Object.assign(nativeCandidate,parsedCandidate);return augmentedCandidate.toJSON=function(){return{candidate:augmentedCandidate.candidate,sdpMid:augmentedCandidate.sdpMid,sdpMLineIndex:augmentedCandidate.sdpMLineIndex,usernameFragment:augmentedCandidate.usernameFragment}},augmentedCandidate}return new NativeRTCIceCandidate(args)},window.RTCIceCandidate.prototype=NativeRTCIceCandidate.prototype,utils.wrapPeerConnectionEvent(window,"icecandidate",function(e){return e.candidate&&Object.defineProperty(e,"candidate",{value:new window.RTCIceCandidate(e.candidate),writable:"false"}),e})}},exports.shimMaxMessageSize=function(window){if(window.RTCPeerConnection){var browserDetails=utils.detectBrowser(window);"sctp"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var sctpInDescription=function(description){if(!description||!description.sdp)return!1;var sections=_sdp2.default.splitSections(description.sdp);return sections.shift(),sections.some(function(mediaSection){var mLine=_sdp2.default.parseMLine(mediaSection);return mLine&&"application"===mLine.kind&&-1!==mLine.protocol.indexOf("SCTP")})},getRemoteFirefoxVersion=function(description){var match=description.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===match||match.length<2)return-1;var version=parseInt(match[1],10);return version!=version?-1:version},getCanSendMaxMessageSize=function(remoteIsFirefox){var canSendMaxMessageSize=65536;return"firefox"===browserDetails.browser&&(canSendMaxMessageSize=browserDetails.version<57?-1===remoteIsFirefox?16384:2147483637:browserDetails.version<60?57===browserDetails.version?65535:65536:2147483637),canSendMaxMessageSize},getMaxMessageSize=function(description,remoteIsFirefox){var maxMessageSize=65536;"firefox"===browserDetails.browser&&57===browserDetails.version&&(maxMessageSize=65535);var match=_sdp2.default.matchPrefix(description.sdp,"a=max-message-size:");return match.length>0?maxMessageSize=parseInt(match[0].substr(19),10):"firefox"===browserDetails.browser&&-1!==remoteIsFirefox&&(maxMessageSize=2147483637),maxMessageSize},origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===browserDetails.browser&&browserDetails.version>=76){var _getConfiguration=this.getConfiguration(),sdpSemantics=_getConfiguration.sdpSemantics;"plan-b"===sdpSemantics&&Object.defineProperty(this,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(sctpInDescription(arguments[0])){var isFirefox=getRemoteFirefoxVersion(arguments[0]),canSendMMS=getCanSendMaxMessageSize(isFirefox),remoteMMS=getMaxMessageSize(arguments[0],isFirefox),maxMessageSize=void 0;maxMessageSize=0===canSendMMS&&0===remoteMMS?Number.POSITIVE_INFINITY:0===canSendMMS||0===remoteMMS?Math.max(canSendMMS,remoteMMS):Math.min(canSendMMS,remoteMMS);var sctp={};Object.defineProperty(sctp,"maxMessageSize",{get:function(){return maxMessageSize}}),this._sctp=sctp}return origSetRemoteDescription.apply(this,arguments)}}},exports.shimSendThrowTypeError=function(window){if(window.RTCPeerConnection&&"createDataChannel"in window.RTCPeerConnection.prototype){var origCreateDataChannel=window.RTCPeerConnection.prototype.createDataChannel;window.RTCPeerConnection.prototype.createDataChannel=function(){var dataChannel=origCreateDataChannel.apply(this,arguments);return wrapDcSend(dataChannel,this),dataChannel},utils.wrapPeerConnectionEvent(window,"datachannel",function(e){return wrapDcSend(e.channel,e.target),e})}function wrapDcSend(dc,pc){var origDataChannelSend=dc.send;dc.send=function(){var data=arguments[0],length=data.length||data.size||data.byteLength;if("open"===dc.readyState&&pc.sctp&&length>pc.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+pc.sctp.maxMessageSize+" bytes)");return origDataChannelSend.apply(dc,arguments)}}},exports.shimConnectionState=function(window){if(window.RTCPeerConnection&&!("connectionState"in window.RTCPeerConnection.prototype)){var proto=window.RTCPeerConnection.prototype;Object.defineProperty(proto,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(proto,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(cb){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),cb&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=cb)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(function(method){var origMethod=proto[method];proto[method]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(e){var pc=e.target;if(pc._lastConnectionState!==pc.connectionState){pc._lastConnectionState=pc.connectionState;var newEvent=new Event("connectionstatechange",e);pc.dispatchEvent(newEvent)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),origMethod.apply(this,arguments)}})}},exports.removeAllowExtmapMixed=function(window){if(window.RTCPeerConnection){var browserDetails=utils.detectBrowser(window);if(!("chrome"===browserDetails.browser&&browserDetails.version>=71)){var nativeSRD=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(desc){return desc&&desc.sdp&&-1!==desc.sdp.indexOf("\na=extmap-allow-mixed")&&(desc.sdp=desc.sdp.split("\n").filter(function(line){return"a=extmap-allow-mixed"!==line.trim()}).join("\n")),nativeSRD.apply(this,arguments)}}}};var obj,_sdp2=(obj=require("sdp"))&&obj.__esModule?obj:{default:obj},utils=function(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj}(require("./utils"))},{"./utils":15,sdp:17}],7:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0}),exports.shimGetDisplayMedia=exports.shimGetUserMedia=void 0;var _getusermedia=require("./getusermedia");Object.defineProperty(exports,"shimGetUserMedia",{enumerable:!0,get:function(){return _getusermedia.shimGetUserMedia}});var _getdisplaymedia=require("./getdisplaymedia");Object.defineProperty(exports,"shimGetDisplayMedia",{enumerable:!0,get:function(){return _getdisplaymedia.shimGetDisplayMedia}}),exports.shimPeerConnection=function(window){var browserDetails=utils.detectBrowser(window);if(window.RTCIceGatherer&&(window.RTCIceCandidate||(window.RTCIceCandidate=function(args){return args}),window.RTCSessionDescription||(window.RTCSessionDescription=function(args){return args}),browserDetails.version<15025)){var origMSTEnabled=Object.getOwnPropertyDescriptor(window.MediaStreamTrack.prototype,"enabled");Object.defineProperty(window.MediaStreamTrack.prototype,"enabled",{set:function(value){origMSTEnabled.set.call(this,value);var ev=new Event("enabled");ev.enabled=value,this.dispatchEvent(ev)}})}!window.RTCRtpSender||"dtmf"in window.RTCRtpSender.prototype||Object.defineProperty(window.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new window.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),window.RTCDtmfSender&&!window.RTCDTMFSender&&(window.RTCDTMFSender=window.RTCDtmfSender);var RTCPeerConnectionShim=(0,_rtcpeerconnectionShim2.default)(window,browserDetails.version);window.RTCPeerConnection=function(config){return config&&config.iceServers&&(config.iceServers=(0,_filtericeservers.filterIceServers)(config.iceServers,browserDetails.version),utils.log("ICE servers after filtering:",config.iceServers)),new RTCPeerConnectionShim(config)},window.RTCPeerConnection.prototype=RTCPeerConnectionShim.prototype},exports.shimReplaceTrack=function(window){!window.RTCRtpSender||"replaceTrack"in window.RTCRtpSender.prototype||(window.RTCRtpSender.prototype.replaceTrack=window.RTCRtpSender.prototype.setTrack)};var obj,utils=function(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj}(require("../utils")),_filtericeservers=require("./filtericeservers"),_rtcpeerconnectionShim2=(obj=require("rtcpeerconnection-shim"))&&obj.__esModule?obj:{default:obj}},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0}),exports.filterIceServers=function(iceServers,edgeVersion){var hasTurn=!1;return(iceServers=JSON.parse(JSON.stringify(iceServers))).filter(function(server){if(server&&(server.urls||server.url)){var urls=server.urls||server.url;server.url&&!server.urls&&utils.deprecated("RTCIceServer.url","RTCIceServer.urls");var isString="string"==typeof urls;return isString&&(urls=[urls]),urls=urls.filter(function(url){if(0===url.indexOf("stun:"))return!1;var validTurn=url.startsWith("turn")&&!url.startsWith("turn:[")&&url.includes("transport=udp");return validTurn&&!hasTurn?(hasTurn=!0,!0):validTurn&&!hasTurn}),delete server.url,server.urls=isString?urls[0]:urls,!!urls.length}})};var utils=function(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj}(require("../utils"))},{"../utils":15}],9:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0}),exports.shimGetDisplayMedia=function(window){"getDisplayMedia"in window.navigator&&window.navigator.mediaDevices&&(window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices||(window.navigator.mediaDevices.getDisplayMedia=window.navigator.getDisplayMedia.bind(window.navigator)))}},{}],10:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0}),exports.shimGetUserMedia=function(window){var navigator=window&&window.navigator,origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(c){return origGetUserMedia(c).catch(function(e){return Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}}(e))})}}},{}],11:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0}),exports.shimGetDisplayMedia=exports.shimGetUserMedia=void 0;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_getusermedia=require("./getusermedia");Object.defineProperty(exports,"shimGetUserMedia",{enumerable:!0,get:function(){return _getusermedia.shimGetUserMedia}});var _getdisplaymedia=require("./getdisplaymedia");Object.defineProperty(exports,"shimGetDisplayMedia",{enumerable:!0,get:function(){return _getdisplaymedia.shimGetDisplayMedia}}),exports.shimOnTrack=function(window){"object"===(void 0===window?"undefined":_typeof(window))&&window.RTCTrackEvent&&"receiver"in window.RTCTrackEvent.prototype&&!("transceiver"in window.RTCTrackEvent.prototype)&&Object.defineProperty(window.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},exports.shimPeerConnection=function(window){var browserDetails=utils.detectBrowser(window);if("object"===(void 0===window?"undefined":_typeof(window))&&(window.RTCPeerConnection||window.mozRTCPeerConnection)){if(!window.RTCPeerConnection&&window.mozRTCPeerConnection&&(window.RTCPeerConnection=window.mozRTCPeerConnection),browserDetails.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(method){var obj,key,value,nativeMethod=window.RTCPeerConnection.prototype[method],methodObj=(value=function(){return arguments[0]=new("addIceCandidate"===method?window.RTCIceCandidate:window.RTCSessionDescription)(arguments[0]),nativeMethod.apply(this,arguments)},(key=method)in(obj={})?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj);window.RTCPeerConnection.prototype[method]=methodObj[method]}),browserDetails.version<68){var nativeAddIceCandidate=window.RTCPeerConnection.prototype.addIceCandidate;window.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():nativeAddIceCandidate.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}var modernStatsTypes={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},nativeGetStats=window.RTCPeerConnection.prototype.getStats;window.RTCPeerConnection.prototype.getStats=function(){var _arguments=Array.prototype.slice.call(arguments),selector=_arguments[0],onSucc=_arguments[1],onErr=_arguments[2];return nativeGetStats.apply(this,[selector||null]).then(function(stats){if(browserDetails.version<53&&!onSucc)try{stats.forEach(function(stat){stat.type=modernStatsTypes[stat.type]||stat.type})}catch(e){if("TypeError"!==e.name)throw e;stats.forEach(function(stat,i){stats.set(i,Object.assign({},stat,{type:modernStatsTypes[stat.type]||stat.type}))})}return stats}).then(onSucc,onErr)}}},exports.shimSenderGetStats=function(window){if("object"===(void 0===window?"undefined":_typeof(window))&&window.RTCPeerConnection&&window.RTCRtpSender&&!(window.RTCRtpSender&&"getStats"in window.RTCRtpSender.prototype)){var origGetSenders=window.RTCPeerConnection.prototype.getSenders;origGetSenders&&(window.RTCPeerConnection.prototype.getSenders=function(){var _this=this,senders=origGetSenders.apply(this,[]);return senders.forEach(function(sender){return sender._pc=_this}),senders});var origAddTrack=window.RTCPeerConnection.prototype.addTrack;origAddTrack&&(window.RTCPeerConnection.prototype.addTrack=function(){var sender=origAddTrack.apply(this,arguments);return sender._pc=this,sender}),window.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}},exports.shimReceiverGetStats=function(window){if("object"===(void 0===window?"undefined":_typeof(window))&&window.RTCPeerConnection&&window.RTCRtpSender&&!(window.RTCRtpSender&&"getStats"in window.RTCRtpReceiver.prototype)){var origGetReceivers=window.RTCPeerConnection.prototype.getReceivers;origGetReceivers&&(window.RTCPeerConnection.prototype.getReceivers=function(){var _this2=this,receivers=origGetReceivers.apply(this,[]);return receivers.forEach(function(receiver){return receiver._pc=_this2}),receivers}),utils.wrapPeerConnectionEvent(window,"track",function(e){return e.receiver._pc=e.srcElement,e}),window.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},exports.shimRemoveStream=function(window){!window.RTCPeerConnection||"removeStream"in window.RTCPeerConnection.prototype||(window.RTCPeerConnection.prototype.removeStream=function(stream){var _this3=this;utils.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(sender){sender.track&&stream.getTracks().includes(sender.track)&&_this3.removeTrack(sender)})})},exports.shimRTCDataChannel=function(window){window.DataChannel&&!window.RTCDataChannel&&(window.RTCDataChannel=window.DataChannel)},exports.shimAddTransceiver=function(window){if("object"===(void 0===window?"undefined":_typeof(window))&&window.RTCPeerConnection){var origAddTransceiver=window.RTCPeerConnection.prototype.addTransceiver;origAddTransceiver&&(window.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];var initParameters=arguments[1],shouldPerformCheck=initParameters&&"sendEncodings"in initParameters;shouldPerformCheck&&initParameters.sendEncodings.forEach(function(encodingParam){if("rid"in encodingParam&&!/^[a-z0-9]{0,16}$/i.test(encodingParam.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in encodingParam&&!(parseFloat(encodingParam.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in encodingParam&&!(parseFloat(encodingParam.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});var transceiver=origAddTransceiver.apply(this,arguments);if(shouldPerformCheck){var sender=transceiver.sender,params=sender.getParameters();"encodings"in params||(params.encodings=initParameters.sendEncodings,this.setParametersPromises.push(sender.setParameters(params).catch(function(){})))}return transceiver})}},exports.shimCreateOffer=function(window){if("object"===(void 0===window?"undefined":_typeof(window))&&window.RTCPeerConnection){var origCreateOffer=window.RTCPeerConnection.prototype.createOffer;window.RTCPeerConnection.prototype.createOffer=function(){var _this4=this,_arguments2=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(function(){return origCreateOffer.apply(_this4,_arguments2)}).finally(function(){_this4.setParametersPromises=[]}):origCreateOffer.apply(this,arguments)}}},exports.shimCreateAnswer=function(window){if("object"===(void 0===window?"undefined":_typeof(window))&&window.RTCPeerConnection){var origCreateAnswer=window.RTCPeerConnection.prototype.createAnswer;window.RTCPeerConnection.prototype.createAnswer=function(){var _this5=this,_arguments3=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(function(){return origCreateAnswer.apply(_this5,_arguments3)}).finally(function(){_this5.setParametersPromises=[]}):origCreateAnswer.apply(this,arguments)}}};var utils=function(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj}(require("../utils"))},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0}),exports.shimGetDisplayMedia=function(window,preferredMediaSource){window.navigator.mediaDevices&&"getDisplayMedia"in window.navigator.mediaDevices||window.navigator.mediaDevices&&(window.navigator.mediaDevices.getDisplayMedia=function(constraints){if(!constraints||!constraints.video){var err=new DOMException("getDisplayMedia without video constraints is undefined");return err.name="NotFoundError",err.code=8,Promise.reject(err)}return!0===constraints.video?constraints.video={mediaSource:preferredMediaSource}:constraints.video.mediaSource=preferredMediaSource,window.navigator.mediaDevices.getUserMedia(constraints)})}},{}],13:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.shimGetUserMedia=function(window){var browserDetails=utils.detectBrowser(window),navigator=window&&window.navigator,MediaStreamTrack=window&&window.MediaStreamTrack;if(navigator.getUserMedia=function(constraints,onSuccess,onError){utils.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),navigator.mediaDevices.getUserMedia(constraints).then(onSuccess,onError)},!(browserDetails.version>55&&"autoGainControl"in navigator.mediaDevices.getSupportedConstraints())){var remap=function(obj,a,b){a in obj&&!(b in obj)&&(obj[b]=obj[a],delete obj[a])},nativeGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);if(navigator.mediaDevices.getUserMedia=function(c){return"object"===(void 0===c?"undefined":_typeof(c))&&"object"===_typeof(c.audio)&&(c=JSON.parse(JSON.stringify(c)),remap(c.audio,"autoGainControl","mozAutoGainControl"),remap(c.audio,"noiseSuppression","mozNoiseSuppression")),nativeGetUserMedia(c)},MediaStreamTrack&&MediaStreamTrack.prototype.getSettings){var nativeGetSettings=MediaStreamTrack.prototype.getSettings;MediaStreamTrack.prototype.getSettings=function(){var obj=nativeGetSettings.apply(this,arguments);return remap(obj,"mozAutoGainControl","autoGainControl"),remap(obj,"mozNoiseSuppression","noiseSuppression"),obj}}if(MediaStreamTrack&&MediaStreamTrack.prototype.applyConstraints){var nativeApplyConstraints=MediaStreamTrack.prototype.applyConstraints;MediaStreamTrack.prototype.applyConstraints=function(c){return"audio"===this.kind&&"object"===(void 0===c?"undefined":_typeof(c))&&(c=JSON.parse(JSON.stringify(c)),remap(c,"autoGainControl","mozAutoGainControl"),remap(c,"noiseSuppression","mozNoiseSuppression")),nativeApplyConstraints.apply(this,[c])}}}};var utils=function(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj}(require("../utils"))},{"../utils":15}],14:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.shimLocalStreamsAPI=function(window){if("object"===(void 0===window?"undefined":_typeof(window))&&window.RTCPeerConnection){if("getLocalStreams"in window.RTCPeerConnection.prototype||(window.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in window.RTCPeerConnection.prototype)){var _addTrack=window.RTCPeerConnection.prototype.addTrack;window.RTCPeerConnection.prototype.addStream=function(stream){var _this=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(stream)||this._localStreams.push(stream),stream.getAudioTracks().forEach(function(track){return _addTrack.call(_this,track,stream)}),stream.getVideoTracks().forEach(function(track){return _addTrack.call(_this,track,stream)})},window.RTCPeerConnection.prototype.addTrack=function(track){var stream=arguments[1];return stream&&(this._localStreams?this._localStreams.includes(stream)||this._localStreams.push(stream):this._localStreams=[stream]),_addTrack.apply(this,arguments)}}"removeStream"in window.RTCPeerConnection.prototype||(window.RTCPeerConnection.prototype.removeStream=function(stream){var _this2=this;this._localStreams||(this._localStreams=[]);var index=this._localStreams.indexOf(stream);if(-1!==index){this._localStreams.splice(index,1);var tracks=stream.getTracks();this.getSenders().forEach(function(sender){tracks.includes(sender.track)&&_this2.removeTrack(sender)})}})}},exports.shimRemoteStreamsAPI=function(window){if("object"===(void 0===window?"undefined":_typeof(window))&&window.RTCPeerConnection&&("getRemoteStreams"in window.RTCPeerConnection.prototype||(window.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in window.RTCPeerConnection.prototype))){Object.defineProperty(window.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(f){var _this3=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=f),this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(stream){if(_this3._remoteStreams||(_this3._remoteStreams=[]),!_this3._remoteStreams.includes(stream)){_this3._remoteStreams.push(stream);var event=new Event("addstream");event.stream=stream,_this3.dispatchEvent(event)}})})}});var origSetRemoteDescription=window.RTCPeerConnection.prototype.setRemoteDescription;window.RTCPeerConnection.prototype.setRemoteDescription=function(){var pc=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(stream){if(pc._remoteStreams||(pc._remoteStreams=[]),!(pc._remoteStreams.indexOf(stream)>=0)){pc._remoteStreams.push(stream);var event=new Event("addstream");event.stream=stream,pc.dispatchEvent(event)}})}),origSetRemoteDescription.apply(pc,arguments)}}},exports.shimCallbacksAPI=function(window){if("object"===(void 0===window?"undefined":_typeof(window))&&window.RTCPeerConnection){var prototype=window.RTCPeerConnection.prototype,origCreateOffer=prototype.createOffer,origCreateAnswer=prototype.createAnswer,setLocalDescription=prototype.setLocalDescription,setRemoteDescription=prototype.setRemoteDescription,addIceCandidate=prototype.addIceCandidate;prototype.createOffer=function(successCallback,failureCallback){var options=arguments.length>=2?arguments[2]:arguments[0],promise=origCreateOffer.apply(this,[options]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise},prototype.createAnswer=function(successCallback,failureCallback){var options=arguments.length>=2?arguments[2]:arguments[0],promise=origCreateAnswer.apply(this,[options]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise};var withCallback=function(description,successCallback,failureCallback){var promise=setLocalDescription.apply(this,[description]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise};prototype.setLocalDescription=withCallback,prototype.setRemoteDescription=withCallback=function(description,successCallback,failureCallback){var promise=setRemoteDescription.apply(this,[description]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise},prototype.addIceCandidate=withCallback=function(candidate,successCallback,failureCallback){var promise=addIceCandidate.apply(this,[candidate]);return failureCallback?(promise.then(successCallback,failureCallback),Promise.resolve()):promise}}},exports.shimGetUserMedia=function(window){var navigator=window&&window.navigator;if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var mediaDevices=navigator.mediaDevices,_getUserMedia=mediaDevices.getUserMedia.bind(mediaDevices);navigator.mediaDevices.getUserMedia=function(constraints){return _getUserMedia(shimConstraints(constraints))}}!navigator.getUserMedia&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&(navigator.getUserMedia=(function(constraints,cb,errcb){navigator.mediaDevices.getUserMedia(constraints).then(cb,errcb)}).bind(navigator))},exports.shimConstraints=shimConstraints,exports.shimRTCIceServerUrls=function(window){var OrigPeerConnection=window.RTCPeerConnection;window.RTCPeerConnection=function(pcConfig,pcConstraints){if(pcConfig&&pcConfig.iceServers){for(var newIceServers=[],i=0;i<pcConfig.iceServers.length;i++){var server=pcConfig.iceServers[i];!server.hasOwnProperty("urls")&&server.hasOwnProperty("url")?(utils.deprecated("RTCIceServer.url","RTCIceServer.urls"),(server=JSON.parse(JSON.stringify(server))).urls=server.url,delete server.url,newIceServers.push(server)):newIceServers.push(pcConfig.iceServers[i])}pcConfig.iceServers=newIceServers}return new OrigPeerConnection(pcConfig,pcConstraints)},window.RTCPeerConnection.prototype=OrigPeerConnection.prototype,"generateCertificate"in window.RTCPeerConnection&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return OrigPeerConnection.generateCertificate}})},exports.shimTrackEventTransceiver=function(window){"object"===(void 0===window?"undefined":_typeof(window))&&window.RTCTrackEvent&&"receiver"in window.RTCTrackEvent.prototype&&!("transceiver"in window.RTCTrackEvent.prototype)&&Object.defineProperty(window.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},exports.shimCreateOfferLegacy=function(window){var origCreateOffer=window.RTCPeerConnection.prototype.createOffer;window.RTCPeerConnection.prototype.createOffer=function(offerOptions){if(offerOptions){void 0!==offerOptions.offerToReceiveAudio&&(offerOptions.offerToReceiveAudio=!!offerOptions.offerToReceiveAudio);var audioTransceiver=this.getTransceivers().find(function(transceiver){return"audio"===transceiver.receiver.track.kind});!1===offerOptions.offerToReceiveAudio&&audioTransceiver?"sendrecv"===audioTransceiver.direction?audioTransceiver.setDirection?audioTransceiver.setDirection("sendonly"):audioTransceiver.direction="sendonly":"recvonly"===audioTransceiver.direction&&(audioTransceiver.setDirection?audioTransceiver.setDirection("inactive"):audioTransceiver.direction="inactive"):!0!==offerOptions.offerToReceiveAudio||audioTransceiver||this.addTransceiver("audio"),void 0!==offerOptions.offerToReceiveVideo&&(offerOptions.offerToReceiveVideo=!!offerOptions.offerToReceiveVideo);var videoTransceiver=this.getTransceivers().find(function(transceiver){return"video"===transceiver.receiver.track.kind});!1===offerOptions.offerToReceiveVideo&&videoTransceiver?"sendrecv"===videoTransceiver.direction?videoTransceiver.setDirection?videoTransceiver.setDirection("sendonly"):videoTransceiver.direction="sendonly":"recvonly"===videoTransceiver.direction&&(videoTransceiver.setDirection?videoTransceiver.setDirection("inactive"):videoTransceiver.direction="inactive"):!0!==offerOptions.offerToReceiveVideo||videoTransceiver||this.addTransceiver("video")}return origCreateOffer.apply(this,arguments)}};var utils=function(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj.default=obj,newObj}(require("../utils"));function shimConstraints(constraints){return constraints&&void 0!==constraints.video?Object.assign({},constraints,{video:utils.compactObject(constraints.video)}):constraints}},{"../utils":15}],15:[function(require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};exports.extractVersion=extractVersion,exports.wrapPeerConnectionEvent=function(window,eventNameToWrap,wrapper){if(window.RTCPeerConnection){var proto=window.RTCPeerConnection.prototype,nativeAddEventListener=proto.addEventListener;proto.addEventListener=function(nativeEventName,cb){if(nativeEventName!==eventNameToWrap)return nativeAddEventListener.apply(this,arguments);var wrappedCallback=function(e){var modifiedEvent=wrapper(e);modifiedEvent&&cb(modifiedEvent)};return this._eventMap=this._eventMap||{},this._eventMap[cb]=wrappedCallback,nativeAddEventListener.apply(this,[nativeEventName,wrappedCallback])};var nativeRemoveEventListener=proto.removeEventListener;proto.removeEventListener=function(nativeEventName,cb){if(nativeEventName!==eventNameToWrap||!this._eventMap||!this._eventMap[cb])return nativeRemoveEventListener.apply(this,arguments);var unwrappedCb=this._eventMap[cb];return delete this._eventMap[cb],nativeRemoveEventListener.apply(this,[nativeEventName,unwrappedCb])},Object.defineProperty(proto,"on"+eventNameToWrap,{get:function(){return this["_on"+eventNameToWrap]},set:function(cb){this["_on"+eventNameToWrap]&&(this.removeEventListener(eventNameToWrap,this["_on"+eventNameToWrap]),delete this["_on"+eventNameToWrap]),cb&&this.addEventListener(eventNameToWrap,this["_on"+eventNameToWrap]=cb)},enumerable:!0,configurable:!0})}},exports.disableLog=function(bool){return"boolean"!=typeof bool?new Error("Argument type: "+(void 0===bool?"undefined":_typeof(bool))+". Please use a boolean."):(logDisabled_=bool,bool?"adapter.js logging disabled":"adapter.js logging enabled")},exports.disableWarnings=function(bool){return"boolean"!=typeof bool?new Error("Argument type: "+(void 0===bool?"undefined":_typeof(bool))+". Please use a boolean."):(deprecationWarnings_=!bool,"adapter.js deprecation warnings "+(bool?"disabled":"enabled"))},exports.log=function(){if("object"===("undefined"==typeof window?"undefined":_typeof(window))){if(logDisabled_)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},exports.deprecated=function(oldMethod,newMethod){deprecationWarnings_&&console.warn(oldMethod+" is deprecated, please use "+newMethod+" instead.")},exports.detectBrowser=function(window){var navigator=window.navigator,result={browser:null,version:null};if(void 0===window||!window.navigator)return result.browser="Not a browser.",result;if(navigator.mozGetUserMedia)result.browser="firefox",result.version=extractVersion(navigator.userAgent,/Firefox\/(\d+)\./,1);else if(navigator.webkitGetUserMedia||!1===window.isSecureContext&&window.webkitRTCPeerConnection&&!window.RTCIceGatherer)result.browser="chrome",result.version=extractVersion(navigator.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))result.browser="edge",result.version=extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!window.RTCPeerConnection||!navigator.userAgent.match(/AppleWebKit\/(\d+)\./))return result.browser="Not a supported browser.",result;result.browser="safari",result.version=extractVersion(navigator.userAgent,/AppleWebKit\/(\d+)\./,1),result.supportsUnifiedPlan=window.RTCRtpTransceiver&&"currentDirection"in window.RTCRtpTransceiver.prototype}return result},exports.compactObject=function compactObject(data){return isObject(data)?Object.keys(data).reduce(function(accumulator,key){var isObj=isObject(data[key]),value=isObj?compactObject(data[key]):data[key],isEmptyObject=isObj&&!Object.keys(value).length;return void 0===value||isEmptyObject?accumulator:Object.assign(accumulator,function(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}({},key,value))},{}):data},exports.walkStats=walkStats,exports.filterStats=function(result,track,outbound){var streamStatsType=outbound?"outbound-rtp":"inbound-rtp",filteredResult=new Map;if(null===track)return filteredResult;var trackStats=[];return result.forEach(function(value){"track"===value.type&&value.trackIdentifier===track.id&&trackStats.push(value)}),trackStats.forEach(function(trackStat){result.forEach(function(stats){stats.type===streamStatsType&&stats.trackId===trackStat.id&&walkStats(result,stats,filteredResult)})}),filteredResult};var logDisabled_=!0,deprecationWarnings_=!0;function extractVersion(uastring,expr,pos){var match=uastring.match(expr);return match&&match.length>=pos&&parseInt(match[pos],10)}function isObject(val){return"[object Object]"===Object.prototype.toString.call(val)}function walkStats(stats,base,resultSet){base&&!resultSet.has(base.id)&&(resultSet.set(base.id,base),Object.keys(base).forEach(function(name){name.endsWith("Id")?walkStats(stats,stats.get(base[name]),resultSet):name.endsWith("Ids")&&base[name].forEach(function(id){walkStats(stats,stats.get(id),resultSet)})}))}},{}],16:[function(require,module,exports){var SDPUtils=require("sdp");function writeMediaSection(transceiver,caps,type,stream,dtlsRole){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);if(sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters()),sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),"offer"===type?"actpass":dtlsRole||"active"),sdp+="a=mid:"+transceiver.mid+"\r\n",sdp+=transceiver.rtpSender&&transceiver.rtpReceiver?"a=sendrecv\r\n":transceiver.rtpSender?"a=sendonly\r\n":transceiver.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",transceiver.rtpSender){var trackId=transceiver.rtpSender._initialTrackId||transceiver.rtpSender.track.id;transceiver.rtpSender._initialTrackId=trackId;var msid="msid:"+(stream?stream.id:"-")+" "+trackId+"\r\n";sdp+="a="+msid,sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid,transceiver.sendEncodingParameters[0].rtx&&(sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" "+msid,sdp+="a=ssrc-group:FID "+transceiver.sendEncodingParameters[0].ssrc+" "+transceiver.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n",transceiver.rtpSender&&transceiver.sendEncodingParameters[0].rtx&&(sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" cname:"+SDPUtils.localCName+"\r\n"),sdp}function getCommonCapabilities(localCapabilities,remoteCapabilities){var commonCapabilities={codecs:[],headerExtensions:[],fecMechanisms:[]},findCodecByPayloadType=function(pt,codecs){pt=parseInt(pt,10);for(var i=0;i<codecs.length;i++)if(codecs[i].payloadType===pt||codecs[i].preferredPayloadType===pt)return codecs[i]},rtxCapabilityMatches=function(lRtx,rRtx,lCodecs,rCodecs){var lCodec=findCodecByPayloadType(lRtx.parameters.apt,lCodecs),rCodec=findCodecByPayloadType(rRtx.parameters.apt,rCodecs);return lCodec&&rCodec&&lCodec.name.toLowerCase()===rCodec.name.toLowerCase()};return localCapabilities.codecs.forEach(function(lCodec){for(var i=0;i<remoteCapabilities.codecs.length;i++){var rCodec=remoteCapabilities.codecs[i];if(lCodec.name.toLowerCase()===rCodec.name.toLowerCase()&&lCodec.clockRate===rCodec.clockRate){if("rtx"===lCodec.name.toLowerCase()&&lCodec.parameters&&rCodec.parameters.apt&&!rtxCapabilityMatches(lCodec,rCodec,localCapabilities.codecs,remoteCapabilities.codecs))continue;(rCodec=JSON.parse(JSON.stringify(rCodec))).numChannels=Math.min(lCodec.numChannels,rCodec.numChannels),commonCapabilities.codecs.push(rCodec),rCodec.rtcpFeedback=rCodec.rtcpFeedback.filter(function(fb){for(var j=0;j<lCodec.rtcpFeedback.length;j++)if(lCodec.rtcpFeedback[j].type===fb.type&&lCodec.rtcpFeedback[j].parameter===fb.parameter)return!0;return!1});break}}}),localCapabilities.headerExtensions.forEach(function(lHeaderExtension){for(var i=0;i<remoteCapabilities.headerExtensions.length;i++){var rHeaderExtension=remoteCapabilities.headerExtensions[i];if(lHeaderExtension.uri===rHeaderExtension.uri){commonCapabilities.headerExtensions.push(rHeaderExtension);break}}}),commonCapabilities}function isActionAllowedInSignalingState(action,type,signalingState){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[type][action].indexOf(signalingState)}function maybeAddCandidate(iceTransport,candidate){var alreadyAdded=iceTransport.getRemoteCandidates().find(function(remoteCandidate){return candidate.foundation===remoteCandidate.foundation&&candidate.ip===remoteCandidate.ip&&candidate.port===remoteCandidate.port&&candidate.priority===remoteCandidate.priority&&candidate.protocol===remoteCandidate.protocol&&candidate.type===remoteCandidate.type});return alreadyAdded||iceTransport.addRemoteCandidate(candidate),!alreadyAdded}function makeError(name,description){var e=new Error(description);return e.name=name,e.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[name],e}module.exports=function(window,edgeVersion){function addTrackToStreamAndFireEvent(track,stream){stream.addTrack(track),stream.dispatchEvent(new window.MediaStreamTrackEvent("addtrack",{track:track}))}function fireAddTrack(pc,track,receiver,streams){var trackEvent=new Event("track");trackEvent.track=track,trackEvent.receiver=receiver,trackEvent.transceiver={receiver:receiver},trackEvent.streams=streams,window.setTimeout(function(){pc._dispatchEvent("track",trackEvent)})}var RTCPeerConnection=function(config){var pc=this,_eventTarget=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(method){pc[method]=_eventTarget[method].bind(_eventTarget)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",config=JSON.parse(JSON.stringify(config||{})),this.usingBundle="max-bundle"===config.bundlePolicy,"negotiate"===config.rtcpMuxPolicy)throw makeError("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(config.rtcpMuxPolicy||(config.rtcpMuxPolicy="require"),config.iceTransportPolicy){case"all":case"relay":break;default:config.iceTransportPolicy="all"}switch(config.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:config.bundlePolicy="balanced"}if(config.iceServers=function(iceServers,edgeVersion){var hasTurn=!1;return(iceServers=JSON.parse(JSON.stringify(iceServers))).filter(function(server){if(server&&(server.urls||server.url)){var urls=server.urls||server.url;server.url&&!server.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var isString="string"==typeof urls;return isString&&(urls=[urls]),urls=urls.filter(function(url){return 0!==url.indexOf("turn:")||-1===url.indexOf("transport=udp")||-1!==url.indexOf("turn:[")||hasTurn?0===url.indexOf("stun:")&&edgeVersion>=14393&&-1===url.indexOf("?transport=udp"):(hasTurn=!0,!0)}),delete server.url,server.urls=isString?urls[0]:urls,!!urls.length}})}(config.iceServers||[],edgeVersion),this._iceGatherers=[],config.iceCandidatePoolSize)for(var i=config.iceCandidatePoolSize;i>0;i--)this._iceGatherers.push(new window.RTCIceGatherer({iceServers:config.iceServers,gatherPolicy:config.iceTransportPolicy}));else config.iceCandidatePoolSize=0;this._config=config,this.transceivers=[],this._sdpSessionId=SDPUtils.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(RTCPeerConnection.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(RTCPeerConnection.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),RTCPeerConnection.prototype.onicecandidate=null,RTCPeerConnection.prototype.onaddstream=null,RTCPeerConnection.prototype.ontrack=null,RTCPeerConnection.prototype.onremovestream=null,RTCPeerConnection.prototype.onsignalingstatechange=null,RTCPeerConnection.prototype.oniceconnectionstatechange=null,RTCPeerConnection.prototype.onconnectionstatechange=null,RTCPeerConnection.prototype.onicegatheringstatechange=null,RTCPeerConnection.prototype.onnegotiationneeded=null,RTCPeerConnection.prototype.ondatachannel=null,RTCPeerConnection.prototype._dispatchEvent=function(name,event){this._isClosed||(this.dispatchEvent(event),"function"==typeof this["on"+name]&&this["on"+name](event))},RTCPeerConnection.prototype._emitGatheringStateChange=function(){var event=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",event)},RTCPeerConnection.prototype.getConfiguration=function(){return this._config},RTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},RTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams},RTCPeerConnection.prototype._createTransceiver=function(kind,doNotAdd){var transceiver={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:kind,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&this.transceivers.length>0)transceiver.iceTransport=this.transceivers[0].iceTransport,transceiver.dtlsTransport=this.transceivers[0].dtlsTransport;else{var transports=this._createIceAndDtlsTransports();transceiver.iceTransport=transports.iceTransport,transceiver.dtlsTransport=transports.dtlsTransport}return doNotAdd||this.transceivers.push(transceiver),transceiver},RTCPeerConnection.prototype.addTrack=function(track,stream){if(this._isClosed)throw makeError("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var transceiver;if(this.transceivers.find(function(s){return s.track===track}))throw makeError("InvalidAccessError","Track already exists.");for(var i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==track.kind||(transceiver=this.transceivers[i]);return transceiver||(transceiver=this._createTransceiver(track.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(stream)&&this.localStreams.push(stream),transceiver.track=track,transceiver.stream=stream,transceiver.rtpSender=new window.RTCRtpSender(track,transceiver.dtlsTransport),transceiver.rtpSender},RTCPeerConnection.prototype.addStream=function(stream){var pc=this;if(edgeVersion>=15025)stream.getTracks().forEach(function(track){pc.addTrack(track,stream)});else{var clonedStream=stream.clone();stream.getTracks().forEach(function(track,idx){var clonedTrack=clonedStream.getTracks()[idx];track.addEventListener("enabled",function(event){clonedTrack.enabled=event.enabled})}),clonedStream.getTracks().forEach(function(track){pc.addTrack(track,clonedStream)})}},RTCPeerConnection.prototype.removeTrack=function(sender){if(this._isClosed)throw makeError("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(sender instanceof window.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var transceiver=this.transceivers.find(function(t){return t.rtpSender===sender});if(!transceiver)throw makeError("InvalidAccessError","Sender was not created by this connection.");var stream=transceiver.stream;transceiver.rtpSender.stop(),transceiver.rtpSender=null,transceiver.track=null,transceiver.stream=null,-1===this.transceivers.map(function(t){return t.stream}).indexOf(stream)&&this.localStreams.indexOf(stream)>-1&&this.localStreams.splice(this.localStreams.indexOf(stream),1),this._maybeFireNegotiationNeeded()},RTCPeerConnection.prototype.removeStream=function(stream){var pc=this;stream.getTracks().forEach(function(track){var sender=pc.getSenders().find(function(s){return s.track===track});sender&&pc.removeTrack(sender)})},RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter(function(transceiver){return!!transceiver.rtpSender}).map(function(transceiver){return transceiver.rtpSender})},RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter(function(transceiver){return!!transceiver.rtpReceiver}).map(function(transceiver){return transceiver.rtpReceiver})},RTCPeerConnection.prototype._createIceGatherer=function(sdpMLineIndex,usingBundle){var pc=this;if(usingBundle&&sdpMLineIndex>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var iceGatherer=new window.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(iceGatherer,"state",{value:"new",writable:!0}),this.transceivers[sdpMLineIndex].bufferedCandidateEvents=[],this.transceivers[sdpMLineIndex].bufferCandidates=function(event){var end=!event.candidate||0===Object.keys(event.candidate).length;iceGatherer.state=end?"completed":"gathering",null!==pc.transceivers[sdpMLineIndex].bufferedCandidateEvents&&pc.transceivers[sdpMLineIndex].bufferedCandidateEvents.push(event)},iceGatherer.addEventListener("localcandidate",this.transceivers[sdpMLineIndex].bufferCandidates),iceGatherer},RTCPeerConnection.prototype._gather=function(mid,sdpMLineIndex){var pc=this,iceGatherer=this.transceivers[sdpMLineIndex].iceGatherer;if(!iceGatherer.onlocalcandidate){var bufferedCandidateEvents=this.transceivers[sdpMLineIndex].bufferedCandidateEvents;this.transceivers[sdpMLineIndex].bufferedCandidateEvents=null,iceGatherer.removeEventListener("localcandidate",this.transceivers[sdpMLineIndex].bufferCandidates),iceGatherer.onlocalcandidate=function(evt){if(!(pc.usingBundle&&sdpMLineIndex>0)){var event=new Event("icecandidate");event.candidate={sdpMid:mid,sdpMLineIndex:sdpMLineIndex};var cand=evt.candidate,end=!cand||0===Object.keys(cand).length;if(end)"new"!==iceGatherer.state&&"gathering"!==iceGatherer.state||(iceGatherer.state="completed");else{"new"===iceGatherer.state&&(iceGatherer.state="gathering"),cand.component=1,cand.ufrag=iceGatherer.getLocalParameters().usernameFragment;var serializedCandidate=SDPUtils.writeCandidate(cand);event.candidate=Object.assign(event.candidate,SDPUtils.parseCandidate(serializedCandidate)),event.candidate.candidate=serializedCandidate,event.candidate.toJSON=function(){return{candidate:event.candidate.candidate,sdpMid:event.candidate.sdpMid,sdpMLineIndex:event.candidate.sdpMLineIndex,usernameFragment:event.candidate.usernameFragment}}}var sections=SDPUtils.getMediaSections(pc._localDescription.sdp);sections[event.candidate.sdpMLineIndex]+=end?"a=end-of-candidates\r\n":"a="+event.candidate.candidate+"\r\n",pc._localDescription.sdp=SDPUtils.getDescription(pc._localDescription.sdp)+sections.join("");var complete=pc.transceivers.every(function(transceiver){return transceiver.iceGatherer&&"completed"===transceiver.iceGatherer.state});"gathering"!==pc.iceGatheringState&&(pc.iceGatheringState="gathering",pc._emitGatheringStateChange()),end||pc._dispatchEvent("icecandidate",event),complete&&(pc._dispatchEvent("icecandidate",new Event("icecandidate")),pc.iceGatheringState="complete",pc._emitGatheringStateChange())}},window.setTimeout(function(){bufferedCandidateEvents.forEach(function(e){iceGatherer.onlocalcandidate(e)})},0)}},RTCPeerConnection.prototype._createIceAndDtlsTransports=function(){var pc=this,iceTransport=new window.RTCIceTransport(null);iceTransport.onicestatechange=function(){pc._updateIceConnectionState(),pc._updateConnectionState()};var dtlsTransport=new window.RTCDtlsTransport(iceTransport);return dtlsTransport.ondtlsstatechange=function(){pc._updateConnectionState()},dtlsTransport.onerror=function(){Object.defineProperty(dtlsTransport,"state",{value:"failed",writable:!0}),pc._updateConnectionState()},{iceTransport:iceTransport,dtlsTransport:dtlsTransport}},RTCPeerConnection.prototype._disposeIceAndDtlsTransports=function(sdpMLineIndex){var iceGatherer=this.transceivers[sdpMLineIndex].iceGatherer;iceGatherer&&(delete iceGatherer.onlocalcandidate,delete this.transceivers[sdpMLineIndex].iceGatherer);var iceTransport=this.transceivers[sdpMLineIndex].iceTransport;iceTransport&&(delete iceTransport.onicestatechange,delete this.transceivers[sdpMLineIndex].iceTransport);var dtlsTransport=this.transceivers[sdpMLineIndex].dtlsTransport;dtlsTransport&&(delete dtlsTransport.ondtlsstatechange,delete dtlsTransport.onerror,delete this.transceivers[sdpMLineIndex].dtlsTransport)},RTCPeerConnection.prototype._transceive=function(transceiver,send,recv){var params=getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);send&&transceiver.rtpSender&&(params.encodings=transceiver.sendEncodingParameters,params.rtcp={cname:SDPUtils.localCName,compound:transceiver.rtcpParameters.compound},transceiver.recvEncodingParameters.length&&(params.rtcp.ssrc=transceiver.recvEncodingParameters[0].ssrc),transceiver.rtpSender.send(params)),recv&&transceiver.rtpReceiver&&params.codecs.length>0&&("video"===transceiver.kind&&transceiver.recvEncodingParameters&&edgeVersion<15019&&transceiver.recvEncodingParameters.forEach(function(p){delete p.rtx}),params.encodings=transceiver.recvEncodingParameters.length?transceiver.recvEncodingParameters:[{}],params.rtcp={compound:transceiver.rtcpParameters.compound},transceiver.rtcpParameters.cname&&(params.rtcp.cname=transceiver.rtcpParameters.cname),transceiver.sendEncodingParameters.length&&(params.rtcp.ssrc=transceiver.sendEncodingParameters[0].ssrc),transceiver.rtpReceiver.receive(params))},RTCPeerConnection.prototype.setLocalDescription=function(description){var sections,sessionpart,pc=this;if(-1===["offer","answer"].indexOf(description.type))return Promise.reject(makeError("TypeError",'Unsupported type "'+description.type+'"'));if(!isActionAllowedInSignalingState("setLocalDescription",description.type,pc.signalingState)||pc._isClosed)return Promise.reject(makeError("InvalidStateError","Can not set local "+description.type+" in state "+pc.signalingState));if("offer"===description.type)sections=SDPUtils.splitSections(description.sdp),sessionpart=sections.shift(),sections.forEach(function(mediaSection,sdpMLineIndex){var caps=SDPUtils.parseRtpParameters(mediaSection);pc.transceivers[sdpMLineIndex].localCapabilities=caps}),pc.transceivers.forEach(function(transceiver,sdpMLineIndex){pc._gather(transceiver.mid,sdpMLineIndex)});else if("answer"===description.type){sections=SDPUtils.splitSections(pc._remoteDescription.sdp),sessionpart=sections.shift();var isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0;sections.forEach(function(mediaSection,sdpMLineIndex){var transceiver=pc.transceivers[sdpMLineIndex],iceGatherer=transceiver.iceGatherer,iceTransport=transceiver.iceTransport,dtlsTransport=transceiver.dtlsTransport,localCapabilities=transceiver.localCapabilities,remoteCapabilities=transceiver.remoteCapabilities;if(!(SDPUtils.isRejected(mediaSection)&&0===SDPUtils.matchPrefix(mediaSection,"a=bundle-only").length||transceiver.rejected)){var remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart),remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);isIceLite&&(remoteDtlsParameters.role="server"),pc.usingBundle&&0!==sdpMLineIndex||(pc._gather(transceiver.mid,sdpMLineIndex),"new"===iceTransport.state&&iceTransport.start(iceGatherer,remoteIceParameters,isIceLite?"controlling":"controlled"),"new"===dtlsTransport.state&&dtlsTransport.start(remoteDtlsParameters));var params=getCommonCapabilities(localCapabilities,remoteCapabilities);pc._transceive(transceiver,params.codecs.length>0,!1)}})}return pc._localDescription={type:description.type,sdp:description.sdp},pc._updateSignalingState("offer"===description.type?"have-local-offer":"stable"),Promise.resolve()},RTCPeerConnection.prototype.setRemoteDescription=function(description){var pc=this;if(-1===["offer","answer"].indexOf(description.type))return Promise.reject(makeError("TypeError",'Unsupported type "'+description.type+'"'));if(!isActionAllowedInSignalingState("setRemoteDescription",description.type,pc.signalingState)||pc._isClosed)return Promise.reject(makeError("InvalidStateError","Can not set remote "+description.type+" in state "+pc.signalingState));var streams={};pc.remoteStreams.forEach(function(stream){streams[stream.id]=stream});var receiverList=[],sections=SDPUtils.splitSections(description.sdp),sessionpart=sections.shift(),isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0,usingBundle=SDPUtils.matchPrefix(sessionpart,"a=group:BUNDLE ").length>0;pc.usingBundle=usingBundle;var iceOptions=SDPUtils.matchPrefix(sessionpart,"a=ice-options:")[0];return pc.canTrickleIceCandidates=!!iceOptions&&iceOptions.substr(14).split(" ").indexOf("trickle")>=0,sections.forEach(function(mediaSection,sdpMLineIndex){var lines=SDPUtils.splitLines(mediaSection),kind=SDPUtils.getKind(mediaSection),rejected=SDPUtils.isRejected(mediaSection)&&0===SDPUtils.matchPrefix(mediaSection,"a=bundle-only").length,protocol=lines[0].substr(2).split(" ")[2],direction=SDPUtils.getDirection(mediaSection,sessionpart),remoteMsid=SDPUtils.parseMsid(mediaSection),mid=SDPUtils.getMid(mediaSection)||SDPUtils.generateIdentifier();if(rejected||"application"===kind&&("DTLS/SCTP"===protocol||"UDP/DTLS/SCTP"===protocol))pc.transceivers[sdpMLineIndex]={mid:mid,kind:kind,protocol:protocol,rejected:!0};else{var transceiver,iceGatherer,iceTransport,dtlsTransport,rtpReceiver,sendEncodingParameters,recvEncodingParameters,localCapabilities,track;!rejected&&pc.transceivers[sdpMLineIndex]&&pc.transceivers[sdpMLineIndex].rejected&&(pc.transceivers[sdpMLineIndex]=pc._createTransceiver(kind,!0));var remoteIceParameters,remoteDtlsParameters,remoteCapabilities=SDPUtils.parseRtpParameters(mediaSection);rejected||(remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart),(remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart)).role="client"),recvEncodingParameters=SDPUtils.parseRtpEncodingParameters(mediaSection);var rtcpParameters=SDPUtils.parseRtcpParameters(mediaSection),isComplete=SDPUtils.matchPrefix(mediaSection,"a=end-of-candidates",sessionpart).length>0,cands=SDPUtils.matchPrefix(mediaSection,"a=candidate:").map(function(cand){return SDPUtils.parseCandidate(cand)}).filter(function(cand){return 1===cand.component});if(("offer"===description.type||"answer"===description.type)&&!rejected&&usingBundle&&sdpMLineIndex>0&&pc.transceivers[sdpMLineIndex]&&(pc._disposeIceAndDtlsTransports(sdpMLineIndex),pc.transceivers[sdpMLineIndex].iceGatherer=pc.transceivers[0].iceGatherer,pc.transceivers[sdpMLineIndex].iceTransport=pc.transceivers[0].iceTransport,pc.transceivers[sdpMLineIndex].dtlsTransport=pc.transceivers[0].dtlsTransport,pc.transceivers[sdpMLineIndex].rtpSender&&pc.transceivers[sdpMLineIndex].rtpSender.setTransport(pc.transceivers[0].dtlsTransport),pc.transceivers[sdpMLineIndex].rtpReceiver&&pc.transceivers[sdpMLineIndex].rtpReceiver.setTransport(pc.transceivers[0].dtlsTransport)),"offer"!==description.type||rejected)"answer"!==description.type||rejected||(iceGatherer=(transceiver=pc.transceivers[sdpMLineIndex]).iceGatherer,iceTransport=transceiver.iceTransport,dtlsTransport=transceiver.dtlsTransport,rtpReceiver=transceiver.rtpReceiver,sendEncodingParameters=transceiver.sendEncodingParameters,localCapabilities=transceiver.localCapabilities,pc.transceivers[sdpMLineIndex].recvEncodingParameters=recvEncodingParameters,pc.transceivers[sdpMLineIndex].remoteCapabilities=remoteCapabilities,pc.transceivers[sdpMLineIndex].rtcpParameters=rtcpParameters,cands.length&&"new"===iceTransport.state&&(!isIceLite&&!isComplete||usingBundle&&0!==sdpMLineIndex?cands.forEach(function(candidate){maybeAddCandidate(transceiver.iceTransport,candidate)}):iceTransport.setRemoteCandidates(cands)),usingBundle&&0!==sdpMLineIndex||("new"===iceTransport.state&&iceTransport.start(iceGatherer,remoteIceParameters,"controlling"),"new"===dtlsTransport.state&&dtlsTransport.start(remoteDtlsParameters)),!getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities).codecs.filter(function(c){return"rtx"===c.name.toLowerCase()}).length&&transceiver.sendEncodingParameters[0].rtx&&delete transceiver.sendEncodingParameters[0].rtx,pc._transceive(transceiver,"sendrecv"===direction||"recvonly"===direction,"sendrecv"===direction||"sendonly"===direction),!rtpReceiver||"sendrecv"!==direction&&"sendonly"!==direction?delete transceiver.rtpReceiver:(track=rtpReceiver.track,remoteMsid?(streams[remoteMsid.stream]||(streams[remoteMsid.stream]=new window.MediaStream),addTrackToStreamAndFireEvent(track,streams[remoteMsid.stream]),receiverList.push([track,rtpReceiver,streams[remoteMsid.stream]])):(streams.default||(streams.default=new window.MediaStream),addTrackToStreamAndFireEvent(track,streams.default),receiverList.push([track,rtpReceiver,streams.default]))));else{(transceiver=pc.transceivers[sdpMLineIndex]||pc._createTransceiver(kind)).mid=mid,transceiver.iceGatherer||(transceiver.iceGatherer=pc._createIceGatherer(sdpMLineIndex,usingBundle)),cands.length&&"new"===transceiver.iceTransport.state&&(!isComplete||usingBundle&&0!==sdpMLineIndex?cands.forEach(function(candidate){maybeAddCandidate(transceiver.iceTransport,candidate)}):transceiver.iceTransport.setRemoteCandidates(cands)),localCapabilities=window.RTCRtpReceiver.getCapabilities(kind),edgeVersion<15019&&(localCapabilities.codecs=localCapabilities.codecs.filter(function(codec){return"rtx"!==codec.name})),sendEncodingParameters=transceiver.sendEncodingParameters||[{ssrc:1001*(2*sdpMLineIndex+2)}];var stream,isNewTrack=!1;"sendrecv"===direction||"sendonly"===direction?(isNewTrack=!transceiver.rtpReceiver,rtpReceiver=transceiver.rtpReceiver||new window.RTCRtpReceiver(transceiver.dtlsTransport,kind),isNewTrack&&(track=rtpReceiver.track,remoteMsid&&"-"===remoteMsid.stream||(remoteMsid?(streams[remoteMsid.stream]||(streams[remoteMsid.stream]=new window.MediaStream,Object.defineProperty(streams[remoteMsid.stream],"id",{get:function(){return remoteMsid.stream}})),Object.defineProperty(track,"id",{get:function(){return remoteMsid.track}}),stream=streams[remoteMsid.stream]):(streams.default||(streams.default=new window.MediaStream),stream=streams.default)),stream&&(addTrackToStreamAndFireEvent(track,stream),transceiver.associatedRemoteMediaStreams.push(stream)),receiverList.push([track,rtpReceiver,stream]))):transceiver.rtpReceiver&&transceiver.rtpReceiver.track&&(transceiver.associatedRemoteMediaStreams.forEach(function(s){var nativeTrack=s.getTracks().find(function(t){return t.id===transceiver.rtpReceiver.track.id});nativeTrack&&function(track,stream){stream.removeTrack(track),stream.dispatchEvent(new window.MediaStreamTrackEvent("removetrack",{track:track}))}(nativeTrack,s)}),transceiver.associatedRemoteMediaStreams=[]),transceiver.localCapabilities=localCapabilities,transceiver.remoteCapabilities=remoteCapabilities,transceiver.rtpReceiver=rtpReceiver,transceiver.rtcpParameters=rtcpParameters,transceiver.sendEncodingParameters=sendEncodingParameters,transceiver.recvEncodingParameters=recvEncodingParameters,pc._transceive(pc.transceivers[sdpMLineIndex],!1,isNewTrack)}}}),void 0===pc._dtlsRole&&(pc._dtlsRole="offer"===description.type?"active":"passive"),pc._remoteDescription={type:description.type,sdp:description.sdp},pc._updateSignalingState("offer"===description.type?"have-remote-offer":"stable"),Object.keys(streams).forEach(function(sid){var stream=streams[sid];if(stream.getTracks().length){if(-1===pc.remoteStreams.indexOf(stream)){pc.remoteStreams.push(stream);var event=new Event("addstream");event.stream=stream,window.setTimeout(function(){pc._dispatchEvent("addstream",event)})}receiverList.forEach(function(item){stream.id===item[2].id&&fireAddTrack(pc,item[0],item[1],[stream])})}}),receiverList.forEach(function(item){item[2]||fireAddTrack(pc,item[0],item[1],[])}),window.setTimeout(function(){pc&&pc.transceivers&&pc.transceivers.forEach(function(transceiver){transceiver.iceTransport&&"new"===transceiver.iceTransport.state&&transceiver.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),transceiver.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(transceiver){transceiver.iceTransport&&transceiver.iceTransport.stop(),transceiver.dtlsTransport&&transceiver.dtlsTransport.stop(),transceiver.rtpSender&&transceiver.rtpSender.stop(),transceiver.rtpReceiver&&transceiver.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},RTCPeerConnection.prototype._updateSignalingState=function(newState){this.signalingState=newState;var event=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",event)},RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var pc=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,window.setTimeout(function(){if(pc.needNegotiation){pc.needNegotiation=!1;var event=new Event("negotiationneeded");pc._dispatchEvent("negotiationneeded",event)}},0))},RTCPeerConnection.prototype._updateIceConnectionState=function(){var newState,states={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(transceiver){transceiver.iceTransport&&!transceiver.rejected&&states[transceiver.iceTransport.state]++}),newState="new",states.failed>0?newState="failed":states.checking>0?newState="checking":states.disconnected>0?newState="disconnected":states.new>0?newState="new":states.connected>0?newState="connected":states.completed>0&&(newState="completed"),newState!==this.iceConnectionState){this.iceConnectionState=newState;var event=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",event)}},RTCPeerConnection.prototype._updateConnectionState=function(){var newState,states={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(transceiver){transceiver.iceTransport&&transceiver.dtlsTransport&&!transceiver.rejected&&(states[transceiver.iceTransport.state]++,states[transceiver.dtlsTransport.state]++)}),states.connected+=states.completed,newState="new",states.failed>0?newState="failed":states.connecting>0?newState="connecting":states.disconnected>0?newState="disconnected":states.new>0?newState="new":states.connected>0&&(newState="connected"),newState!==this.connectionState){this.connectionState=newState;var event=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",event)}},RTCPeerConnection.prototype.createOffer=function(){var pc=this;if(pc._isClosed)return Promise.reject(makeError("InvalidStateError","Can not call createOffer after close"));var numAudioTracks=pc.transceivers.filter(function(t){return"audio"===t.kind}).length,numVideoTracks=pc.transceivers.filter(function(t){return"video"===t.kind}).length,offerOptions=arguments[0];if(offerOptions){if(offerOptions.mandatory||offerOptions.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==offerOptions.offerToReceiveAudio&&(numAudioTracks=!0===offerOptions.offerToReceiveAudio?1:!1===offerOptions.offerToReceiveAudio?0:offerOptions.offerToReceiveAudio),void 0!==offerOptions.offerToReceiveVideo&&(numVideoTracks=!0===offerOptions.offerToReceiveVideo?1:!1===offerOptions.offerToReceiveVideo?0:offerOptions.offerToReceiveVideo)}for(pc.transceivers.forEach(function(transceiver){"audio"===transceiver.kind?--numAudioTracks<0&&(transceiver.wantReceive=!1):"video"===transceiver.kind&&--numVideoTracks<0&&(transceiver.wantReceive=!1)});numAudioTracks>0||numVideoTracks>0;)numAudioTracks>0&&(pc._createTransceiver("audio"),numAudioTracks--),numVideoTracks>0&&(pc._createTransceiver("video"),numVideoTracks--);var sdp=SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,pc._sdpSessionVersion++);pc.transceivers.forEach(function(transceiver,sdpMLineIndex){var track=transceiver.track,kind=transceiver.kind,mid=transceiver.mid||SDPUtils.generateIdentifier();transceiver.mid=mid,transceiver.iceGatherer||(transceiver.iceGatherer=pc._createIceGatherer(sdpMLineIndex,pc.usingBundle));var localCapabilities=window.RTCRtpSender.getCapabilities(kind);edgeVersion<15019&&(localCapabilities.codecs=localCapabilities.codecs.filter(function(codec){return"rtx"!==codec.name})),localCapabilities.codecs.forEach(function(codec){"H264"===codec.name&&void 0===codec.parameters["level-asymmetry-allowed"]&&(codec.parameters["level-asymmetry-allowed"]="1"),transceiver.remoteCapabilities&&transceiver.remoteCapabilities.codecs&&transceiver.remoteCapabilities.codecs.forEach(function(remoteCodec){codec.name.toLowerCase()===remoteCodec.name.toLowerCase()&&codec.clockRate===remoteCodec.clockRate&&(codec.preferredPayloadType=remoteCodec.payloadType)})}),localCapabilities.headerExtensions.forEach(function(hdrExt){(transceiver.remoteCapabilities&&transceiver.remoteCapabilities.headerExtensions||[]).forEach(function(rHdrExt){hdrExt.uri===rHdrExt.uri&&(hdrExt.id=rHdrExt.id)})});var sendEncodingParameters=transceiver.sendEncodingParameters||[{ssrc:1001*(2*sdpMLineIndex+1)}];track&&edgeVersion>=15019&&"video"===kind&&!sendEncodingParameters[0].rtx&&(sendEncodingParameters[0].rtx={ssrc:sendEncodingParameters[0].ssrc+1}),transceiver.wantReceive&&(transceiver.rtpReceiver=new window.RTCRtpReceiver(transceiver.dtlsTransport,kind)),transceiver.localCapabilities=localCapabilities,transceiver.sendEncodingParameters=sendEncodingParameters}),"max-compat"!==pc._config.bundlePolicy&&(sdp+="a=group:BUNDLE "+pc.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"),sdp+="a=ice-options:trickle\r\n",pc.transceivers.forEach(function(transceiver,sdpMLineIndex){sdp+=writeMediaSection(transceiver,transceiver.localCapabilities,"offer",transceiver.stream,pc._dtlsRole),sdp+="a=rtcp-rsize\r\n",!transceiver.iceGatherer||"new"===pc.iceGatheringState||0!==sdpMLineIndex&&pc.usingBundle||(transceiver.iceGatherer.getLocalCandidates().forEach(function(cand){cand.component=1,sdp+="a="+SDPUtils.writeCandidate(cand)+"\r\n"}),"completed"===transceiver.iceGatherer.state&&(sdp+="a=end-of-candidates\r\n"))});var desc=new window.RTCSessionDescription({type:"offer",sdp:sdp});return Promise.resolve(desc)},RTCPeerConnection.prototype.createAnswer=function(){var pc=this;if(pc._isClosed)return Promise.reject(makeError("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==pc.signalingState&&"have-local-pranswer"!==pc.signalingState)return Promise.reject(makeError("InvalidStateError","Can not call createAnswer in signalingState "+pc.signalingState));var sdp=SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,pc._sdpSessionVersion++);pc.usingBundle&&(sdp+="a=group:BUNDLE "+pc.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"),sdp+="a=ice-options:trickle\r\n";var mediaSectionsInOffer=SDPUtils.getMediaSections(pc._remoteDescription.sdp).length;pc.transceivers.forEach(function(transceiver,sdpMLineIndex){if(!(sdpMLineIndex+1>mediaSectionsInOffer)){if(transceiver.rejected)return"application"===transceiver.kind?sdp+="DTLS/SCTP"===transceiver.protocol?"m=application 0 DTLS/SCTP 5000\r\n":"m=application 0 "+transceiver.protocol+" webrtc-datachannel\r\n":"audio"===transceiver.kind?sdp+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===transceiver.kind&&(sdp+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(sdp+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+transceiver.mid+"\r\n");var localTrack;transceiver.stream&&("audio"===transceiver.kind?localTrack=transceiver.stream.getAudioTracks()[0]:"video"===transceiver.kind&&(localTrack=transceiver.stream.getVideoTracks()[0]),localTrack&&edgeVersion>=15019&&"video"===transceiver.kind&&!transceiver.sendEncodingParameters[0].rtx&&(transceiver.sendEncodingParameters[0].rtx={ssrc:transceiver.sendEncodingParameters[0].ssrc+1}));var commonCapabilities=getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);!commonCapabilities.codecs.filter(function(c){return"rtx"===c.name.toLowerCase()}).length&&transceiver.sendEncodingParameters[0].rtx&&delete transceiver.sendEncodingParameters[0].rtx,sdp+=writeMediaSection(transceiver,commonCapabilities,"answer",transceiver.stream,pc._dtlsRole),transceiver.rtcpParameters&&transceiver.rtcpParameters.reducedSize&&(sdp+="a=rtcp-rsize\r\n")}});var desc=new window.RTCSessionDescription({type:"answer",sdp:sdp});return Promise.resolve(desc)},RTCPeerConnection.prototype.addIceCandidate=function(candidate){var sections,pc=this;return candidate&&void 0===candidate.sdpMLineIndex&&!candidate.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(resolve,reject){if(!pc._remoteDescription)return reject(makeError("InvalidStateError","Can not add ICE candidate without a remote description"));if(candidate&&""!==candidate.candidate){var sdpMLineIndex=candidate.sdpMLineIndex;if(candidate.sdpMid)for(var i=0;i<pc.transceivers.length;i++)if(pc.transceivers[i].mid===candidate.sdpMid){sdpMLineIndex=i;break}var transceiver=pc.transceivers[sdpMLineIndex];if(!transceiver)return reject(makeError("OperationError","Can not add ICE candidate"));if(transceiver.rejected)return resolve();var cand=Object.keys(candidate.candidate).length>0?SDPUtils.parseCandidate(candidate.candidate):{};if("tcp"===cand.protocol&&(0===cand.port||9===cand.port))return resolve();if(cand.component&&1!==cand.component)return resolve();if((0===sdpMLineIndex||sdpMLineIndex>0&&transceiver.iceTransport!==pc.transceivers[0].iceTransport)&&!maybeAddCandidate(transceiver.iceTransport,cand))return reject(makeError("OperationError","Can not add ICE candidate"));var candidateString=candidate.candidate.trim();0===candidateString.indexOf("a=")&&(candidateString=candidateString.substr(2)),(sections=SDPUtils.getMediaSections(pc._remoteDescription.sdp))[sdpMLineIndex]+="a="+(cand.type?candidateString:"end-of-candidates")+"\r\n",pc._remoteDescription.sdp=SDPUtils.getDescription(pc._remoteDescription.sdp)+sections.join("")}else for(var j=0;j<pc.transceivers.length&&(pc.transceivers[j].rejected||(pc.transceivers[j].iceTransport.addRemoteCandidate({}),(sections=SDPUtils.getMediaSections(pc._remoteDescription.sdp))[j]+="a=end-of-candidates\r\n",pc._remoteDescription.sdp=SDPUtils.getDescription(pc._remoteDescription.sdp)+sections.join(""),!pc.usingBundle));j++);resolve()})},RTCPeerConnection.prototype.getStats=function(selector){if(selector&&selector instanceof window.MediaStreamTrack){var senderOrReceiver=null;if(this.transceivers.forEach(function(transceiver){transceiver.rtpSender&&transceiver.rtpSender.track===selector?senderOrReceiver=transceiver.rtpSender:transceiver.rtpReceiver&&transceiver.rtpReceiver.track===selector&&(senderOrReceiver=transceiver.rtpReceiver)}),!senderOrReceiver)throw makeError("InvalidAccessError","Invalid selector.");return senderOrReceiver.getStats()}var promises=[];return this.transceivers.forEach(function(transceiver){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(method){transceiver[method]&&promises.push(transceiver[method].getStats())})}),Promise.all(promises).then(function(allStats){var results=new Map;return allStats.forEach(function(stats){stats.forEach(function(stat){results.set(stat.id,stat)})}),results})},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(ortcObjectName){var obj=window[ortcObjectName];if(obj&&obj.prototype&&obj.prototype.getStats){var nativeGetstats=obj.prototype.getStats;obj.prototype.getStats=function(){return nativeGetstats.apply(this).then(function(nativeStats){var mapStats=new Map;return Object.keys(nativeStats).forEach(function(id){var stat;nativeStats[id].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(stat=nativeStats[id]).type]||stat.type,mapStats.set(id,nativeStats[id])}),mapStats})}}});var methods=["createOffer","createAnswer"];return methods.forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;return"function"==typeof args[0]||"function"==typeof args[1]?nativeMethod.apply(this,[arguments[2]]).then(function(description){"function"==typeof args[0]&&args[0].apply(null,[description])},function(error){"function"==typeof args[1]&&args[1].apply(null,[error])}):nativeMethod.apply(this,arguments)}}),(methods=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;return"function"==typeof args[1]||"function"==typeof args[2]?nativeMethod.apply(this,arguments).then(function(){"function"==typeof args[1]&&args[1].apply(null)},function(error){"function"==typeof args[2]&&args[2].apply(null,[error])}):nativeMethod.apply(this,arguments)}}),["getStats"].forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;return"function"==typeof args[1]?nativeMethod.apply(this,arguments).then(function(){"function"==typeof args[1]&&args[1].apply(null)}):nativeMethod.apply(this,arguments)}}),RTCPeerConnection}},{sdp:17}],17:[function(require,module,exports){var SDPUtils={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};SDPUtils.localCName=SDPUtils.generateIdentifier(),SDPUtils.splitLines=function(blob){return blob.trim().split("\n").map(function(line){return line.trim()})},SDPUtils.splitSections=function(blob){return blob.split("\nm=").map(function(part,index){return(index>0?"m="+part:part).trim()+"\r\n"})},SDPUtils.getDescription=function(blob){var sections=SDPUtils.splitSections(blob);return sections&&sections[0]},SDPUtils.getMediaSections=function(blob){var sections=SDPUtils.splitSections(blob);return sections.shift(),sections},SDPUtils.matchPrefix=function(blob,prefix){return SDPUtils.splitLines(blob).filter(function(line){return 0===line.indexOf(prefix)})},SDPUtils.parseCandidate=function(line){for(var parts,candidate={foundation:(parts=0===line.indexOf("a=candidate:")?line.substring(12).split(" "):line.substring(10).split(" "))[0],component:parseInt(parts[1],10),protocol:parts[2].toLowerCase(),priority:parseInt(parts[3],10),ip:parts[4],address:parts[4],port:parseInt(parts[5],10),type:parts[7]},i=8;i<parts.length;i+=2)switch(parts[i]){case"raddr":candidate.relatedAddress=parts[i+1];break;case"rport":candidate.relatedPort=parseInt(parts[i+1],10);break;case"tcptype":candidate.tcpType=parts[i+1];break;case"ufrag":candidate.ufrag=parts[i+1],candidate.usernameFragment=parts[i+1];break;default:candidate[parts[i]]=parts[i+1]}return candidate},SDPUtils.writeCandidate=function(candidate){var sdp=[];sdp.push(candidate.foundation),sdp.push(candidate.component),sdp.push(candidate.protocol.toUpperCase()),sdp.push(candidate.priority),sdp.push(candidate.address||candidate.ip),sdp.push(candidate.port);var type=candidate.type;return sdp.push("typ"),sdp.push(type),"host"!==type&&candidate.relatedAddress&&candidate.relatedPort&&(sdp.push("raddr"),sdp.push(candidate.relatedAddress),sdp.push("rport"),sdp.push(candidate.relatedPort)),candidate.tcpType&&"tcp"===candidate.protocol.toLowerCase()&&(sdp.push("tcptype"),sdp.push(candidate.tcpType)),(candidate.usernameFragment||candidate.ufrag)&&(sdp.push("ufrag"),sdp.push(candidate.usernameFragment||candidate.ufrag)),"candidate:"+sdp.join(" ")},SDPUtils.parseIceOptions=function(line){return line.substr(14).split(" ")},SDPUtils.parseRtpMap=function(line){var parts=line.substr(9).split(" "),parsed={payloadType:parseInt(parts.shift(),10)};return parts=parts[0].split("/"),parsed.name=parts[0],parsed.clockRate=parseInt(parts[1],10),parsed.channels=3===parts.length?parseInt(parts[2],10):1,parsed.numChannels=parsed.channels,parsed},SDPUtils.writeRtpMap=function(codec){var pt=codec.payloadType;void 0!==codec.preferredPayloadType&&(pt=codec.preferredPayloadType);var channels=codec.channels||codec.numChannels||1;return"a=rtpmap:"+pt+" "+codec.name+"/"+codec.clockRate+(1!==channels?"/"+channels:"")+"\r\n"},SDPUtils.parseExtmap=function(line){var parts=line.substr(9).split(" ");return{id:parseInt(parts[0],10),direction:parts[0].indexOf("/")>0?parts[0].split("/")[1]:"sendrecv",uri:parts[1]}},SDPUtils.writeExtmap=function(headerExtension){return"a=extmap:"+(headerExtension.id||headerExtension.preferredId)+(headerExtension.direction&&"sendrecv"!==headerExtension.direction?"/"+headerExtension.direction:"")+" "+headerExtension.uri+"\r\n"},SDPUtils.parseFmtp=function(line){for(var kv,parsed={},parts=line.substr(line.indexOf(" ")+1).split(";"),j=0;j<parts.length;j++)parsed[(kv=parts[j].trim().split("="))[0].trim()]=kv[1];return parsed},SDPUtils.writeFmtp=function(codec){var line="",pt=codec.payloadType;if(void 0!==codec.preferredPayloadType&&(pt=codec.preferredPayloadType),codec.parameters&&Object.keys(codec.parameters).length){var params=[];Object.keys(codec.parameters).forEach(function(param){params.push(codec.parameters[param]?param+"="+codec.parameters[param]:param)}),line+="a=fmtp:"+pt+" "+params.join(";")+"\r\n"}return line},SDPUtils.parseRtcpFb=function(line){var parts=line.substr(line.indexOf(" ")+1).split(" ");return{type:parts.shift(),parameter:parts.join(" ")}},SDPUtils.writeRtcpFb=function(codec){var lines="",pt=codec.payloadType;return void 0!==codec.preferredPayloadType&&(pt=codec.preferredPayloadType),codec.rtcpFeedback&&codec.rtcpFeedback.length&&codec.rtcpFeedback.forEach(function(fb){lines+="a=rtcp-fb:"+pt+" "+fb.type+(fb.parameter&&fb.parameter.length?" "+fb.parameter:"")+"\r\n"}),lines},SDPUtils.parseSsrcMedia=function(line){var sp=line.indexOf(" "),parts={ssrc:parseInt(line.substr(7,sp-7),10)},colon=line.indexOf(":",sp);return colon>-1?(parts.attribute=line.substr(sp+1,colon-sp-1),parts.value=line.substr(colon+1)):parts.attribute=line.substr(sp+1),parts},SDPUtils.parseSsrcGroup=function(line){var parts=line.substr(13).split(" ");return{semantics:parts.shift(),ssrcs:parts.map(function(ssrc){return parseInt(ssrc,10)})}},SDPUtils.getMid=function(mediaSection){var mid=SDPUtils.matchPrefix(mediaSection,"a=mid:")[0];if(mid)return mid.substr(6)},SDPUtils.parseFingerprint=function(line){var parts=line.substr(14).split(" ");return{algorithm:parts[0].toLowerCase(),value:parts[1]}},SDPUtils.getDtlsParameters=function(mediaSection,sessionpart){return{role:"auto",fingerprints:SDPUtils.matchPrefix(mediaSection+sessionpart,"a=fingerprint:").map(SDPUtils.parseFingerprint)}},SDPUtils.writeDtlsParameters=function(params,setupType){var sdp="a=setup:"+setupType+"\r\n";return params.fingerprints.forEach(function(fp){sdp+="a=fingerprint:"+fp.algorithm+" "+fp.value+"\r\n"}),sdp},SDPUtils.getIceParameters=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);return{usernameFragment:(lines=lines.concat(SDPUtils.splitLines(sessionpart))).filter(function(line){return 0===line.indexOf("a=ice-ufrag:")})[0].substr(12),password:lines.filter(function(line){return 0===line.indexOf("a=ice-pwd:")})[0].substr(10)}},SDPUtils.writeIceParameters=function(params){return"a=ice-ufrag:"+params.usernameFragment+"\r\na=ice-pwd:"+params.password+"\r\n"},SDPUtils.parseRtpParameters=function(mediaSection){for(var description={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},mline=SDPUtils.splitLines(mediaSection)[0].split(" "),i=3;i<mline.length;i++){var pt=mline[i],rtpmapline=SDPUtils.matchPrefix(mediaSection,"a=rtpmap:"+pt+" ")[0];if(rtpmapline){var codec=SDPUtils.parseRtpMap(rtpmapline),fmtps=SDPUtils.matchPrefix(mediaSection,"a=fmtp:"+pt+" ");switch(codec.parameters=fmtps.length?SDPUtils.parseFmtp(fmtps[0]):{},codec.rtcpFeedback=SDPUtils.matchPrefix(mediaSection,"a=rtcp-fb:"+pt+" ").map(SDPUtils.parseRtcpFb),description.codecs.push(codec),codec.name.toUpperCase()){case"RED":case"ULPFEC":description.fecMechanisms.push(codec.name.toUpperCase())}}}return SDPUtils.matchPrefix(mediaSection,"a=extmap:").forEach(function(line){description.headerExtensions.push(SDPUtils.parseExtmap(line))}),description},SDPUtils.writeRtpDescription=function(kind,caps){var sdp="";sdp+="m="+kind+" ",sdp+=caps.codecs.length>0?"9":"0",sdp+=" UDP/TLS/RTP/SAVPF ",sdp+=caps.codecs.map(function(codec){return void 0!==codec.preferredPayloadType?codec.preferredPayloadType:codec.payloadType}).join(" ")+"\r\n",sdp+="c=IN IP4 0.0.0.0\r\n",sdp+="a=rtcp:9 IN IP4 0.0.0.0\r\n",caps.codecs.forEach(function(codec){sdp+=SDPUtils.writeRtpMap(codec),sdp+=SDPUtils.writeFmtp(codec),sdp+=SDPUtils.writeRtcpFb(codec)});var maxptime=0;return caps.codecs.forEach(function(codec){codec.maxptime>maxptime&&(maxptime=codec.maxptime)}),maxptime>0&&(sdp+="a=maxptime:"+maxptime+"\r\n"),sdp+="a=rtcp-mux\r\n",caps.headerExtensions&&caps.headerExtensions.forEach(function(extension){sdp+=SDPUtils.writeExtmap(extension)}),sdp},SDPUtils.parseRtpEncodingParameters=function(mediaSection){var secondarySsrc,encodingParameters=[],description=SDPUtils.parseRtpParameters(mediaSection),hasRed=-1!==description.fecMechanisms.indexOf("RED"),hasUlpfec=-1!==description.fecMechanisms.indexOf("ULPFEC"),ssrcs=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(parts){return"cname"===parts.attribute}),primarySsrc=ssrcs.length>0&&ssrcs[0].ssrc,flows=SDPUtils.matchPrefix(mediaSection,"a=ssrc-group:FID").map(function(line){return line.substr(17).split(" ").map(function(part){return parseInt(part,10)})});flows.length>0&&flows[0].length>1&&flows[0][0]===primarySsrc&&(secondarySsrc=flows[0][1]),description.codecs.forEach(function(codec){if("RTX"===codec.name.toUpperCase()&&codec.parameters.apt){var encParam={ssrc:primarySsrc,codecPayloadType:parseInt(codec.parameters.apt,10)};primarySsrc&&secondarySsrc&&(encParam.rtx={ssrc:secondarySsrc}),encodingParameters.push(encParam),hasRed&&((encParam=JSON.parse(JSON.stringify(encParam))).fec={ssrc:primarySsrc,mechanism:hasUlpfec?"red+ulpfec":"red"},encodingParameters.push(encParam))}}),0===encodingParameters.length&&primarySsrc&&encodingParameters.push({ssrc:primarySsrc});var bandwidth=SDPUtils.matchPrefix(mediaSection,"b=");return bandwidth.length&&(bandwidth=0===bandwidth[0].indexOf("b=TIAS:")?parseInt(bandwidth[0].substr(7),10):0===bandwidth[0].indexOf("b=AS:")?1e3*parseInt(bandwidth[0].substr(5),10)*.95-16e3:void 0,encodingParameters.forEach(function(params){params.maxBitrate=bandwidth})),encodingParameters},SDPUtils.parseRtcpParameters=function(mediaSection){var rtcpParameters={},remoteSsrc=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(obj){return"cname"===obj.attribute})[0];remoteSsrc&&(rtcpParameters.cname=remoteSsrc.value,rtcpParameters.ssrc=remoteSsrc.ssrc);var rsize=SDPUtils.matchPrefix(mediaSection,"a=rtcp-rsize");rtcpParameters.reducedSize=rsize.length>0,rtcpParameters.compound=0===rsize.length;var mux=SDPUtils.matchPrefix(mediaSection,"a=rtcp-mux");return rtcpParameters.mux=mux.length>0,rtcpParameters},SDPUtils.parseMsid=function(mediaSection){var parts,spec=SDPUtils.matchPrefix(mediaSection,"a=msid:");if(1===spec.length)return{stream:(parts=spec[0].substr(7).split(" "))[0],track:parts[1]};var planB=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(msidParts){return"msid"===msidParts.attribute});return planB.length>0?{stream:(parts=planB[0].value.split(" "))[0],track:parts[1]}:void 0},SDPUtils.parseSctpDescription=function(mediaSection){var maxMessageSize,mline=SDPUtils.parseMLine(mediaSection),maxSizeLine=SDPUtils.matchPrefix(mediaSection,"a=max-message-size:");maxSizeLine.length>0&&(maxMessageSize=parseInt(maxSizeLine[0].substr(19),10)),isNaN(maxMessageSize)&&(maxMessageSize=65536);var sctpPort=SDPUtils.matchPrefix(mediaSection,"a=sctp-port:");if(sctpPort.length>0)return{port:parseInt(sctpPort[0].substr(12),10),protocol:mline.fmt,maxMessageSize:maxMessageSize};if(SDPUtils.matchPrefix(mediaSection,"a=sctpmap:").length>0){var parts=SDPUtils.matchPrefix(mediaSection,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(parts[0],10),protocol:parts[1],maxMessageSize:maxMessageSize}}},SDPUtils.writeSctpDescription=function(media,sctp){var output=[];return output="DTLS/SCTP"!==media.protocol?["m="+media.kind+" 9 "+media.protocol+" "+sctp.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+sctp.port+"\r\n"]:["m="+media.kind+" 9 "+media.protocol+" "+sctp.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+sctp.port+" "+sctp.protocol+" 65535\r\n"],void 0!==sctp.maxMessageSize&&output.push("a=max-message-size:"+sctp.maxMessageSize+"\r\n"),output.join("")},SDPUtils.generateSessionId=function(){return Math.random().toString().substr(2,21)},SDPUtils.writeSessionBoilerplate=function(sessId,sessVer,sessUser){var version=void 0!==sessVer?sessVer:2;return"v=0\r\no="+(sessUser||"thisisadapterortc")+" "+(sessId||SDPUtils.generateSessionId())+" "+version+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},SDPUtils.writeMediaSection=function(transceiver,caps,type,stream){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);if(sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters()),sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),"offer"===type?"actpass":"active"),sdp+="a=mid:"+transceiver.mid+"\r\n",sdp+=transceiver.direction?"a="+transceiver.direction+"\r\n":transceiver.rtpSender&&transceiver.rtpReceiver?"a=sendrecv\r\n":transceiver.rtpSender?"a=sendonly\r\n":transceiver.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",transceiver.rtpSender){var msid="msid:"+stream.id+" "+transceiver.rtpSender.track.id+"\r\n";sdp+="a="+msid,sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid,transceiver.sendEncodingParameters[0].rtx&&(sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" "+msid,sdp+="a=ssrc-group:FID "+transceiver.sendEncodingParameters[0].ssrc+" "+transceiver.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n",transceiver.rtpSender&&transceiver.sendEncodingParameters[0].rtx&&(sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" cname:"+SDPUtils.localCName+"\r\n"),sdp},SDPUtils.getDirection=function(mediaSection,sessionpart){for(var lines=SDPUtils.splitLines(mediaSection),i=0;i<lines.length;i++)switch(lines[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return lines[i].substr(2)}return sessionpart?SDPUtils.getDirection(sessionpart):"sendrecv"},SDPUtils.getKind=function(mediaSection){return SDPUtils.splitLines(mediaSection)[0].split(" ")[0].substr(2)},SDPUtils.isRejected=function(mediaSection){return"0"===mediaSection.split(" ",2)[1]},SDPUtils.parseMLine=function(mediaSection){var parts=SDPUtils.splitLines(mediaSection)[0].substr(2).split(" ");return{kind:parts[0],port:parseInt(parts[1],10),protocol:parts[2],fmt:parts.slice(3).join(" ")}},SDPUtils.parseOLine=function(mediaSection){var parts=SDPUtils.matchPrefix(mediaSection,"o=")[0].substr(2).split(" ");return{username:parts[0],sessionId:parts[1],sessionVersion:parseInt(parts[2],10),netType:parts[3],addressType:parts[4],address:parts[5]}},SDPUtils.isValidSDP=function(blob){if("string"!=typeof blob||0===blob.length)return!1;for(var lines=SDPUtils.splitLines(blob),i=0;i<lines.length;i++)if(lines[i].length<2||"="!==lines[i].charAt(1))return!1;return!0},"object"==typeof module&&(module.exports=SDPUtils)},{}]},{},[1])(1)}),function(root,factory){if("function"==typeof define&&define.amd)define("easyrtc",["easyrtc_lang","webrtc-adapter","socket.io"],factory);else if("object"==typeof module&&module.exports)module.exports=factory(require("easyrtc_lang"),require("webrtc-adapter"),require("socket.io"));else{if(void 0===window.io||!window.io)throw new Error("easyrtc requires socket.io");root.easyrtc=factory(window.easyrtc_lang,window.adapter,window.io)}}(this,function(easyrtc_lang,adapter,io,undefined){return new function(){var self=this,peerConns={},stillAliveTimer=null,stillAlivePeriod=0,missedAliveResponses=0;function stillAliveEmitter(){if(stillAlivePeriod){if(stillAliveTimer&&clearTimeout(stillAliveTimer),1===missedAliveResponses)return self.showError(self.errCodes.SYSTEM_ERR,"Timed out trying to talk to the server."),self.printpeerconns(),self.hangupAll(),void self.disconnect();stillAliveTimer=setTimeout(stillAliveEmitter,2e4),missedAliveResponses++,sendSignalling(null,"stillAlive",{},function(msgType,msgData){missedAliveResponses=0},function(){})}}function logDebug(message,obj){self.debugPrinter&&self.debugPrinter(message,obj)}function isEmptyObj(obj){if(null===obj||obj===undefined)return!0;var key;for(key in obj)if(obj.hasOwnProperty(key))return!1;return!0}var autoInitUserMedia=!0,sdpLocalFilter=null,sdpRemoteFilter=null,iceCandidateFilter=null,iceConnectionStateChangeListener=null,signalingStateChangeListener=null,connectionOptions={"connect timeout":1e4,"force new connection":!0};function stopStream(stream){var i,tracks;for(tracks=stream.getAudioTracks(),i=0;i<tracks.length;i++)try{tracks[i].stop()}catch(err){}for(tracks=stream.getVideoTracks(),i=0;i<tracks.length;i++)try{tracks[i].stop()}catch(err){}if("function"==typeof stream.stop)try{stream.stop()}catch(err){}}function addStreamToPeerConnection(stream,peerConnection){if(peerConnection.addStream)-1===peerConnection.getLocalStreams().indexOf(stream)&&peerConnection.addStream(stream);else{var i,existingTracks=peerConnection.getSenders(),tracks=stream.getAudioTracks();for(i=0;i<tracks.length;i++)-1===existingTracks.indexOf(tracks[i])&&peerConnection.addTrack(tracks[i]);for(tracks=stream.getVideoTracks(),i=0;i<tracks.length;i++)-1===existingTracks.indexOf(tracks[i])&&peerConnection.addTrack(tracks[i])}}function isSocketConnected(socket){return socket&&(socket.socket&&socket.socket.connected||socket.connected)}this.setSdpFilters=function(localFilter,remoteFilter){sdpLocalFilter=localFilter,sdpRemoteFilter=remoteFilter},this.setPeerClosedListener=function(handler){this.onPeerClosed=handler},this.setPeerOpenListener=function(handler){this.onPeerOpen=handler},this.setPeerFailingListener=function(failingHandler,recoveredHandler){this.onPeerFailing=failingHandler,this.onPeerRecovered=recoveredHandler},this.setIceCandidateFilter=function(filter){iceCandidateFilter=filter},this.setIceConnectionStateChangeListener=function(listener){iceConnectionStateChangeListener=listener},this.setSignalingStateChangeListener=function(listener){signalingStateChangeListener=listener},this.setAutoInitUserMedia=function(flag){autoInitUserMedia=!!flag},this.format=function(format,arg1,arg2,arg3){for(var formatted=arguments[0],i=1;i<arguments.length;i++){var regexp=new RegExp("\\{"+(i-1)+"\\}","gi");formatted=formatted.replace(regexp,arguments[i])}return formatted},this.renegotiate=function(otherUser){var peerConnObj=peerConns[otherUser];if(peerConnObj){var callFailureCB=peerConnObj.callFailureCB||self.showError,pc=peerConnObj.pc;peerConnObj.sendingOffer?logDebug("initiateSendOffer.setLocalAndSendMessage0.ignored",peerConnObj.sendingOffer):(peerConnObj.sendingOffer=!0,pc.createOffer({iceRestart:!0}).then(function(sessionDescription){peerConnObj.cancelled?logDebug("renegotiate.setLocalAndSendMessage0.ignored",peerConnObj.cancelled):(sdpLocalFilter&&(sessionDescription.sdp=sdpLocalFilter(sessionDescription.sdp)),pc.setLocalDescription(sessionDescription).then(function(){peerConnObj.sendingOffer=!1,sendSignalling(otherUser,"offer",sessionDescription,null,callFailureCB)},function(errorText){peerConnObj.sendingOffer=!1,callFailureCB(self.errCodes.CALL_ERR,errorText)}))}).catch(function(reason){peerConnObj.sendingOffer=!1,callFailureCB(self.errCodes.CALL_ERR,JSON.stringify(reason))}))}else logDebug("Attempt to renegotiate ice on nonexistant connection")};var haveAudioVideo={audio:!1,video:!1};this.getConstantString=function(key){return easyrtc_lang[key]?easyrtc_lang[key]:(self.showError(self.errCodes.DEVELOPER_ERR,"Could not find key='"+key+"' in easyrtc_lang"),key)};var allowedEvents={roomOccupant:!0,roomOccupants:!0},eventListeners={};function event(eventName,callingFunction){if("string"!=typeof eventName)throw self.showError(self.errCodes.DEVELOPER_ERR,callingFunction+" called without a string as the first argument"),"developer error";if(!allowedEvents[eventName])throw self.showError(self.errCodes.DEVELOPER_ERR,callingFunction+" called with a bad event name = "+eventName),"developer error"}this.addEventListener=function(eventName,eventListener){if(event(eventName,"addEventListener"),"function"!=typeof eventListener)throw self.showError(self.errCodes.DEVELOPER_ERR,"addEventListener called with a non-function for second argument"),"developer error";self.removeEventListener(eventName,eventListener),eventListeners[eventName]||(eventListeners[eventName]=[]),eventListeners[eventName][eventListeners[eventName].length]=eventListener},this.removeEventListener=function(eventName,eventListener){event(eventName,"removeEventListener");var listeners=eventListeners[eventName],i=0;if(listeners)for(i=0;i<listeners.length;i++)listeners[i]===eventListener&&(i<listeners.length-1&&(listeners[i]=listeners[listeners.length-1]),listeners.length=listeners.length-1)},this.emitEvent=function(eventName,eventData){event(eventName,"emitEvent");var listeners=eventListeners[eventName],i=0;if(listeners)for(i=0;i<listeners.length;i++)listeners[i](eventName,eventData)},this.errCodes={BAD_NAME:"BAD_NAME",CALL_ERR:"CALL_ERR",DEVELOPER_ERR:"DEVELOPER_ERR",SYSTEM_ERR:"SYSTEM_ERR",CONNECT_ERR:"CONNECT_ERR",MEDIA_ERR:"MEDIA_ERR",MEDIA_WARNING:"MEDIA_WARNING",INTERNAL_ERR:"INTERNAL_ERR",PEER_GONE:"PEER_GONE",ALREADY_CONNECTED:"ALREADY_CONNECTED",BAD_CREDENTIAL:"BAD_CREDENTIAL",ICECANDIDATE_ERR:"ICECANDIDATE_ERR",NOVIABLEICE:"NOVIABLEICE",SIGNAL_ERR:"SIGNAL_ERR"},this.apiVersion="1.1.1-beta",this.ackMessage={msgType:"ack"},this.usernameRegExp=/^(.){1,64}$/,this.cookieId="easyrtcsid",this.username=null,this.loggingOut=!1,this.disconnecting=!1;var namedLocalMediaStreams={},sessionFields=[],receivedMediaConstraints={};function getSourceList(callback,sourceType){navigator.mediaDevices.enumerateDevices().then(function(values){for(var results=[],i=0;i<values.length;i++){var source=values[i];source.kind===sourceType&&(source.id||(source.id=source.deviceId),results.push(source))}callback(results)}).catch(function(reason){logDebug("Unable to enumerate devices ("+reason+")")})}this.enableAudioReceive=function(value){adapter&&adapter.browserDetails&&"chrome"===adapter.browserDetails.browser&&adapter.browserDetails.version<65?(receivedMediaConstraints.mandatory=receivedMediaConstraints.mandatory||{},receivedMediaConstraints.mandatory.OfferToReceiveAudio=value):receivedMediaConstraints.offerToReceiveAudio=value},this.enableVideoReceive=function(value){adapter&&adapter.browserDetails&&"chrome"===adapter.browserDetails.browser&&adapter.browserDetails.version<65?(receivedMediaConstraints.mandatory=receivedMediaConstraints.mandatory||{},receivedMediaConstraints.mandatory.OfferToReceiveVideo=value):receivedMediaConstraints.offerToReceiveVideo=value},this.enableAudioReceive(!0),this.enableVideoReceive(!0),this.setAudioOutput=function(element,sinkId){void 0!==element.sinkId?element.setSinkId(sinkId).then(function(){logDebug("Success, audio output device attached: "+sinkId+" to element with "+element.title+" as source.")}).catch(function(error){var errorMessage=error;"SecurityError"===error.name&&(errorMessage="You need to use HTTPS for selecting audio output device: "+error),logDebug(errorMessage)}):logDebug("Browser does not support output device selection.")},this.getAudioSinkList=function(callback){getSourceList(callback,"audiooutput")},this.getAudioSourceList=function(callback){getSourceList(callback,"audioinput")},this.getVideoSourceList=function(callback){getSourceList(callback,"videoinput")};var dataChannelName="dc",oldConfig={},offersPending={},credential=null;self.audioEnabled=!0,self.videoEnabled=!0,this.debugPrinter=null,this.myEasyrtcid="",this.nativeVideoHeight=0,this.maxP2PMessageLength=1e3,this.nativeVideoWidth=0,this.roomJoin={},this.isNameValid=function(name){return self.usernameRegExp.test(name)},this.setCookieId=function(cookieId){self.cookieId=cookieId},this._desiredVideoProperties={},this.setVideoSource=function(videoSrcId){self._desiredVideoProperties.videoSrcId=videoSrcId},this.setScreenCapture=function(enableScreenCapture,mediaSourceId){if(enableScreenCapture){if(self._presetMediaConstraints={video:{mozMediaSource:"screen",chromeMediaSource:"screen",mediaSource:"screen",mediaSourceId:"screen:0",maxWidth:screen.width,maxHeight:screen.height,minWidth:screen.width,minHeight:screen.height,minFrameRate:1,maxFrameRate:15},audio:!1},mediaSourceId)if(adapter&&adapter.browserDetails&&"chrome"===adapter.browserDetails.browser){var mandatory=self._presetMediaConstraints.video;mandatory.chromeMediaSource="desktop",mandatory.chromeMediaSourceId=mediaSourceId,self._presetMediaConstraints.video={mandatory:mandatory,optional:[{googTemporalLayeredScreencast:!0}]}}else self._presetMediaConstraints.video.mediaSourceId=mediaSourceId}else delete self._presetMediaConstraints},this._desiredAudioProperties={},this.setAudioSource=function(audioSrcId){self._desiredAudioProperties.audioSrcId=audioSrcId},this.setVideoDims=function(width,height,frameRate){self._desiredVideoProperties.width=width,self._desiredVideoProperties.height=height,frameRate!==undefined&&(self._desiredVideoProperties.frameRate=frameRate)},self.getUserMediaConstraints=function(){var constraints={};return self._presetMediaConstraints?(constraints=self._presetMediaConstraints,delete self._presetMediaConstraints,constraints):(self.videoEnabled?adapter&&adapter.browserDetails&&("firefox"===adapter.browserDetails.browser||"edge"===adapter.browserDetails.browser)?(constraints.video={},self._desiredVideoProperties.width&&(constraints.video.width=self._desiredVideoProperties.width),self._desiredVideoProperties.height&&(constraints.video.height=self._desiredVideoProperties.height),self._desiredVideoProperties.frameRate&&(constraints.video.frameRate={minFrameRate:self._desiredVideoProperties.frameRate,maxFrameRate:self._desiredVideoProperties.frameRate}),self._desiredVideoProperties.videoSrcId&&(constraints.video.deviceId=self._desiredVideoProperties.videoSrcId)):(constraints.video={},self._desiredVideoProperties.width&&(constraints.video.width={max:self._desiredVideoProperties.width,min:self._desiredVideoProperties.width,ideal:self._desiredVideoProperties.width}),self._desiredVideoProperties.height&&(constraints.video.height={max:self._desiredVideoProperties.height,min:self._desiredVideoProperties.height,ideal:self._desiredVideoProperties.height}),self._desiredVideoProperties.frameRate&&(constraints.video.frameRate={max:self._desiredVideoProperties.frameRate,ideal:self._desiredVideoProperties.frameRate}),self._desiredVideoProperties.videoSrcId&&(constraints.video.deviceId=self._desiredVideoProperties.videoSrcId),0===Object.keys(constraints.video).length&&(constraints.video=!0)):constraints.video=!1,self.audioEnabled?(constraints.audio={},self._desiredAudioProperties.audioSrcId&&(constraints.audio.deviceId=self._desiredAudioProperties.audioSrcId)):constraints.audio=!1,constraints)},this.setApplicationName=function(name){self.applicationName=name},this.enableDebug=function(enable){self.debugPrinter=enable?function(message,obj){var now=(new Date).toISOString(),stackString=(new Error).stack,srcLine="location unknown";if(stackString){var stackFrameStrings=stackString.split("\n");srcLine="",stackFrameStrings.length>=5&&(srcLine=stackFrameStrings[4])}console.log("debug "+now+" : "+message+" ["+srcLine+"]"),void 0!==obj&&console.log("debug "+now+" : ",obj)}:null},this.supportsGetUserMedia=function(){return navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia},this.supportsPeerConnections=function(){return"undefined"!=typeof RTCPeerConnection},this.supportsDataChannels=function(){var hasCreateDataChannel=!1;if(self.supportsPeerConnections())try{var peer=new RTCPeerConnection({iceServers:[]},{});hasCreateDataChannel=void 0!==peer.createDataChannel,peer.close()}catch(err){}return hasCreateDataChannel},this.supportsStatistics=function(){var hasGetStats=!1;if(self.supportsPeerConnections())try{var peer=new RTCPeerConnection({iceServers:[]},{});hasGetStats=void 0!==peer.getStats,peer.close()}catch(err){}return hasGetStats},this.createRTCPeerConnection=function(pc_config,optionalStuff){if(self.supportsPeerConnections())return new RTCPeerConnection(pc_config,optionalStuff);throw"Your browser doesn't support webRTC (RTCPeerConnection)"},this.getDatachannelConstraints=function(){return{reliable:adapter&&adapter.browserDetails&&"chrome"!==adapter.browserDetails.browser&&adapter.browserDetails.version<31}},haveAudioVideo={audio:!1,video:!1};var dataEnabled=!1,serverPath=null,roomOccupantListener=null,onDataChannelOpen=null,onDataChannelClose=null,lastLoggedInList={},receivePeer={msgTypes:{}},receiveServerCB=null,updateConfigurationInfo=function(){};this.printpeerconns=function(){console.log("peerconns = ",peerConns)};var customErrorListener,acceptancePending={};function enqueueSendRoomApi(roomName){self._roomApiFieldTimer[roomName]&&clearTimeout(self._roomApiFieldTimer[roomName]),self._roomApiFieldTimer[roomName]=setTimeout(function(){var roomApiFields=self._roomApiFields[roomName];roomApiFields&&function(roomName,fields){var fieldAsString=JSON.stringify(fields);JSON.parse(fieldAsString),self.webSocket.json.emit("easyrtcCmd",{msgType:"setRoomApiField",msgData:{setRoomApiField:{roomName:roomName,field:fields}}},function(ackMsg){"error"===ackMsg.msgType&&self.showError(ackMsg.msgData.errorCode,ackMsg.msgData.errorText)})}(roomName,roomApiFields),self._roomApiFieldTimer[roomName]=null},10)}function enableMediaTracks(enable,tracks){var i;if(tracks)for(i=0;i<tracks.length;i++)tracks[i].enabled=enable}function getLocalMediaStreamByName(streamName){return streamName||(streamName="default"),namedLocalMediaStreams.hasOwnProperty(streamName)?namedLocalMediaStreams[streamName]:null}function buildMediaIds(){var streamName,mediaMap={};for(streamName in namedLocalMediaStreams)namedLocalMediaStreams.hasOwnProperty(streamName)&&(mediaMap[streamName]=namedLocalMediaStreams[streamName].id||"default");return mediaMap}function registerLocalMediaStreamByName(stream,streamName){var roomName;if(streamName||(streamName="default"),stream.streamName=streamName,namedLocalMediaStreams[streamName]=stream,"default"!==streamName){var mediaIds=buildMediaIds(),roomData=self.roomData;for(roomName in roomData)roomData.hasOwnProperty(roomName)&&self.setRoomApiField(roomName,"mediaIds",mediaIds)}}function getNameOfRemoteStream(easyrtcId,webrtcStreamId){var roomName,mediaIds,streamName;if(webrtcStreamId||(webrtcStreamId="default"),peerConns[easyrtcId]&&(streamName=peerConns[easyrtcId].remoteStreamIdToName[webrtcStreamId]))return streamName;for(roomName in self.roomData)if(self.roomData.hasOwnProperty(roomName)){if(!(mediaIds=self.getRoomApiField(roomName,easyrtcId,"mediaIds")))continue;for(streamName in mediaIds)if(mediaIds.hasOwnProperty(streamName)&&(mediaIds[streamName]===webrtcStreamId||0===webrtcStreamId.indexOf(mediaIds[streamName])||0===mediaIds[streamName].indexOf(webrtcStreamId)))return streamName;if(adapter&&adapter.browserDetails&&"firefox"===adapter.browserDetails.browser){if(mediaIds.default)return"default";for(var anyName in mediaIds)if(mediaIds.hasOwnProperty(anyName))return anyName}}return undefined}function closeLocalMediaStreamByName(streamName){streamName||(streamName="default");var stream=self.getLocalStream(streamName);if(stream){var id,roomName,streamId=stream.id||"default";if(namedLocalMediaStreams[streamName]){for(id in peerConns)if(peerConns.hasOwnProperty(id)){try{peerConns[id].pc.removeStream(stream)}catch(err){}self.sendPeerMessage(id,"__closingMediaStream",{streamId:streamId,streamName:streamName})}if(stopStream(namedLocalMediaStreams[streamName]),delete namedLocalMediaStreams[streamName],"default"!==streamName){var mediaIds=buildMediaIds();for(roomName in self.roomData)self.roomData.hasOwnProperty(roomName)&&self.setRoomApiField(roomName,"mediaIds",mediaIds)}}}}this.acceptCheck=function(caller,helper){helper(!0)},this.streamAcceptor=function(easyrtcid,stream){},this.onStreamClosed=function(easyrtcid){},this.callCancelled=function(easyrtcid){},this.getPeerConnectionByUserId=function(userId){return peerConns&&peerConns[userId]?peerConns[userId].pc:null},this.standardStatsFilter=adapter&&adapter.browserDetails&&"firefox"===adapter.browserDetails.browser?{"outboundrtp_audio.bytesSent":"audioBytesSent","outboundrtp_video.bytesSent":"videoBytesSent","inboundrtp_video.bytesReceived":"videoBytesReceived","inboundrtp_audio.bytesReceived":"audioBytesReceived","outboundrtp_audio.packetsSent":"audioPacketsSent","outboundrtp_video.packetsSent":"videoPacketsSent","inboundrtp_video.packetsReceived":"videoPacketsReceived","inboundrtp_audio.packetsReceived":"audioPacketsReceived","inboundrtp_video.packetsLost":"videoPacketsLost","inboundrtp_audio.packetsLost":"audioPacketsLost",firefoxRemoteAddress:"remoteAddress"}:[{googTransmitBitrate:"transmitBitRate",googActualEncBitrate:"encodeRate",googAvailableSendBandwidth:"availableSendRate"},{googCodecName:"audioCodec",googTypingNoiseState:"typingNoise",packetsSent:"audioPacketsSent",bytesSent:"audioBytesSent"},{googCodecName:"videoCodec",googFrameRateSent:"outFrameRate",packetsSent:"videoPacketsSent",bytesSent:"videoBytesSent"},{packetsLost:"videoPacketsLost",packetsReceived:"videoPacketsReceived",bytesReceived:"videoBytesReceived",googFrameRateOutput:"frameRateOut"},{packetsLost:"audioPacketsLost",packetsReceived:"audioPacketsReceived",bytesReceived:"audioBytesReceived",audioOutputLevel:"audioOutputLevel"},{googRemoteAddress:"remoteAddress",googActiveConnection:"activeConnection"},{audioInputLevel:"audioInputLevel"}],this.getPeerStatistics=function(easyrtcid,callback,filter){adapter&&adapter.browserDetails&&"firefox"===adapter.browserDetails.browser?function(peerId,callback,filter){peerConns[peerId]?peerConns[peerId].pc.getStats?peerConns[peerId].pc.getStats(null).then(function(stats){var srcKey,items={},candidates={},activeId=null;if(stats&&stats.forEach(function(entry){var majorKey,subKey;if(entry.type.match(/boundrtp/)){if(entry.id.match(/audio/))majorKey=entry.type+"_audio";else{if(!entry.id.match(/video/))return;majorKey=entry.type+"_video"}for(subKey in entry)entry.hasOwnProperty(subKey)&&(items[majorKey+"."+subKey]=entry[subKey])}else entry.hasOwnProperty("ipAddress")&&entry.id?candidates[entry.id]=entry.ipAddress+":"+entry.portNumber:entry.hasOwnProperty("selected")&&entry.hasOwnProperty("remoteCandidateId")&&entry.selected&&(activeId=entry.remoteCandidateId)}),activeId&&(items.firefoxRemoteAddress=candidates[activeId]),filter){var filteredItems={};for(srcKey in filter)filter.hasOwnProperty(srcKey)&&items.hasOwnProperty(srcKey)&&(filteredItems[filter[srcKey]]=items[srcKey]);callback(peerId,filteredItems)}else callback(peerId,items)},function(error){logDebug("unable to get statistics")}):callback(peerId,{statistics:self.getConstantString("statsNotSupported")}):callback(peerId,{connected:!1})}(easyrtcid,callback,filter):function(peerId,callback,filter){peerConns[peerId]?peerConns[peerId].pc.getStats?peerConns[peerId].pc.getStats().then(function(stats){var part,i,j,itemKeys,itemKey,names,partList,bestI,hasActive,curReceived,localAddress,remoteAddress,localStats={},parts=stats.result(),partNames=[],bestBytes=0,turnAddress=null;if(filter){for(i=0;i<parts.length;i++){for(partNames[i]={},names=parts[i].names(),j=0;j<names.length;j++)partNames[i][names[j]]=!0;partNames[i].googRemoteAddress&&partNames[i].googActiveConnection&&(!0!==(hasActive=parts[i].stat("googActiveConnection"))&&"true"!==hasActive||(curReceived=parseInt(parts[i].stat("bytesReceived"))+parseInt(parts[i].stat("bytesSent")))>bestBytes&&(bestI=i,bestBytes=curReceived))}for(i=0;i<parts.length;i++)partNames[i].googActiveConnection&&(i!==bestI?partNames[i]={}:(localAddress=parts[i].stat("googLocalAddress").split(":")[0],remoteAddress=parts[i].stat("googRemoteAddress").split(":")[0],self.isTurnServer(localAddress)?turnAddress=localAddress:self.isTurnServer(remoteAddress)&&(turnAddress=remoteAddress)));for(i=0;i<filter.length;i++){for(itemKeys=filter[i],partList=[],part=null,j=0;j<parts.length;j++){var fullMatch=!0;for(itemKey in itemKeys)if(itemKeys.hasOwnProperty(itemKey)&&!partNames[j][itemKey]){fullMatch=!1;break}fullMatch&&parts[j]&&partList.push(parts[j])}if(1===partList.length){for(j=0;j<partList.length;j++)if(part=partList[j])for(itemKey in itemKeys)itemKeys.hasOwnProperty(itemKey)&&(localStats[itemKeys[itemKey]]=part.stat(itemKey))}else if(partList.length>1){for(itemKey in itemKeys)itemKeys.hasOwnProperty(itemKey)&&(localStats[itemKeys[itemKey]]=[]);for(j=0;j<partList.length;j++)for(itemKey in part=partList[j],itemKeys)itemKeys.hasOwnProperty(itemKey)&&localStats[itemKeys[itemKey]].push(part.stat(itemKey))}}}else for(i=0;i<parts.length;i++)for(names=parts[i].names(),j=0;j<names.length;j++)localStats[parts[i].id+"."+(itemKey=names[j])]=parts[i].stat(itemKey);localStats.remoteAddress&&turnAddress&&(localStats.remoteAddress=turnAddress),callback(peerId,localStats)}):callback(peerId,{statistics:self.getConstantString("statsNotSupported")}):callback(peerId,{connected:!1})}(easyrtcid,callback,filter)},self._roomApiFieldTimer={},this.setRoomApiField=function(roomName,fieldName,fieldValue){if(self._roomApiFields||(self._roomApiFields={}),fieldName||fieldValue){if(self._roomApiFields[roomName]||(self._roomApiFields[roomName]={}),fieldValue!==undefined&&null!==fieldValue){if("object"==typeof fieldValue)try{JSON.stringify(fieldValue)}catch(jsonError){return void self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.setRoomApiField passed bad object ")}self._roomApiFields[roomName][fieldName]={fieldName:fieldName,fieldValue:fieldValue}}else delete self._roomApiFields[roomName][fieldName];self.webSocketConnected&&enqueueSendRoomApi(roomName)}else clearTimeout(self._roomApiFieldTimer[roomName]),delete self._roomApiFields[roomName]},this.showError=function(messageCode,message){self.onError({errorCode:messageCode,errorText:message})},this.setErrorListener=function(handler){customErrorListener=handler},this.onError=function(errorObject){if(logDebug("saw error "+errorObject.errorText),customErrorListener)return logDebug("Using custom error handler"),void customErrorListener(errorObject);var errorBody,errorDiv=document.getElementById("easyrtcErrorDialog");if(!errorDiv){(errorDiv=document.createElement("div")).id="easyrtcErrorDialog";var title=document.createElement("div");title.innerHTML="Error messages",title.className="easyrtcErrorDialog_title",errorDiv.appendChild(title),(errorBody=document.createElement("div")).id="easyrtcErrorDialog_body",errorDiv.appendChild(errorBody);var clearButton=document.createElement("button");clearButton.appendChild(document.createTextNode("Okay")),clearButton.className="easyrtcErrorDialog_okayButton",clearButton.onclick=function(){errorBody.innerHTML="",errorDiv.style.display="none"},errorDiv.appendChild(clearButton),document.body.appendChild(errorDiv)}errorBody=document.getElementById("easyrtcErrorDialog_body");var messageNode=document.createElement("div");messageNode.className="easyrtcErrorDialog_element",messageNode.appendChild(document.createTextNode(errorObject.errorText)),errorBody.appendChild(messageNode),errorDiv.style.display="block"},this.createObjectURL=function(mediaStream){if(window.URL&&window.URL.createObjectURL)return window.URL.createObjectURL(mediaStream);if(window.webkitURL&&window.webkitURL.createObjectURL)return window.webkit.createObjectURL(mediaStream);throw logDebug("saw exception Your browsers does not support URL.createObjectURL."),"Your browsers does not support URL.createObjectURL."},this.cleanId=function(idString){var MAP={"&":"&amp;","<":"&lt;",">":"&gt;"};return idString?idString.replace(/[&<>]/g,function(c){return MAP[c]}):""},self.setRoomEntryListener=function(handler){self.roomEntryListener=handler},self.setRoomOccupantListener=function(listener){roomOccupantListener=listener},this.setDataChannelOpenListener=function(listener){onDataChannelOpen=listener},this.setDataChannelCloseListener=function(listener){onDataChannelClose=listener},this.getConnectionCount=function(){var i,count=0;for(i in peerConns)peerConns.hasOwnProperty(i)&&self.getConnectStatus(i)===self.IS_CONNECTED&&count++;return count},this.setMaxP2PMessageLength=function(maxLength){this.maxP2PMessageLength=maxLength},this.enableAudio=function(enabled){self.audioEnabled=enabled},this.enableVideo=function(enabled){self.videoEnabled=enabled},this.enableDataChannels=function(enabled){dataEnabled=enabled},this.getLocalMediaIds=function(){return Object.keys(namedLocalMediaStreams)},this.register3rdPartyLocalMediaStream=function(stream,streamName){return registerLocalMediaStreamByName(stream,streamName)},this.getNameOfRemoteStream=function(easyrtcId,webrtcStream){return"string"==typeof webrtcStream?getNameOfRemoteStream(easyrtcId,webrtcStream):webrtcStream.id?getNameOfRemoteStream(easyrtcId,webrtcStream.id):void 0},this.closeLocalMediaStream=function(streamName){return closeLocalMediaStreamByName(streamName)},this.closeLocalStream=this.closeLocalMediaStream,this.enableCamera=function(enable,streamName){var stream=getLocalMediaStreamByName(streamName);stream&&stream.getVideoTracks&&enableMediaTracks(enable,stream.getVideoTracks())},this.enableMicrophone=function(enable,streamName){var stream=getLocalMediaStreamByName(streamName);stream&&stream.getAudioTracks&&enableMediaTracks(enable,stream.getAudioTracks())},this.muteVideoObject=function(videoObjectName,mute){var videoObject;if("string"==typeof videoObjectName){if(!(videoObject=document.getElementById(videoObjectName)))throw"Unknown video object "+videoObjectName}else{if(!videoObjectName)throw"muteVideoObject passed a null";videoObject=videoObjectName}videoObject.muted=!!mute},self.getLocalStreamAsUrl=function(streamName){var stream=getLocalMediaStreamByName(streamName);if(null===stream)throw"Developer error: attempt to get a MediaStream without invoking easyrtc.initMediaSource successfully";return self.createObjectURL(stream)},this.getLocalStream=function(streamName){return getLocalMediaStreamByName(streamName)||null},this.clearMediaStream=function(element){element&&element.pause&&element.pause(),void 0!==element.srcObject?element.srcObject=null:void 0!==element.mozSrcObject?element.mozSrcObject=null:void 0!==element.src&&(element.src="")},this.setVideoObjectSrc=function(element,stream){stream&&""!==stream?(element.autoplay=!0,void 0!==element.srcObject?element.srcObject=stream:void 0!==element.mozSrcObject?element.mozSrcObject=self.createObjectURL(stream):void 0!==element.src&&(element.src=self.createObjectURL(stream))):self.clearMediaStream(element)},this.buildLocalMediaStream=function(streamName,audioTracks,videoTracks){var i;if("string"!=typeof streamName)return self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.buildLocalMediaStream not supplied a stream name"),null;var streamToClone=null;for(var key in namedLocalMediaStreams)if(namedLocalMediaStreams.hasOwnProperty(key)&&(streamToClone=namedLocalMediaStreams[key]))break;if(!streamToClone)for(key in peerConns)if(peerConns.hasOwnProperty(key)){var remoteStreams=peerConns[key].pc.getRemoteStreams();remoteStreams&&remoteStreams.length>0&&(streamToClone=remoteStreams[0])}if(!streamToClone)return self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to create a mediastream without one to clone from"),null;var mediaClone=streamToClone.clone(),oldTracks=mediaClone.getTracks();if(audioTracks)for(i=0;i<audioTracks.length;i++)mediaClone.addTrack(audioTracks[i].clone());if(videoTracks)for(i=0;i<videoTracks.length;i++)mediaClone.addTrack(videoTracks[i].clone());for(i=0;i<oldTracks.length;i++)mediaClone.removeTrack(oldTracks[i]);return registerLocalMediaStreamByName(mediaClone,streamName),mediaClone},this.loadStylesheet=function(){var cssIndex,css,links=document.getElementsByTagName("link");for(cssIndex in links)if(links.hasOwnProperty(cssIndex)&&(css=links[cssIndex]).href&&css.href.match(/\/easyrtc.css/))return;var easySheet=document.createElement("link");easySheet.setAttribute("rel","stylesheet"),easySheet.setAttribute("type","text/css"),easySheet.setAttribute("href","/easyrtc/easyrtc.css");var headSection=document.getElementsByTagName("head")[0];headSection.insertBefore(easySheet,headSection.childNodes[0])},this.formatError=function(x){var name,result;if(null==x)return"null";if("string"==typeof x)return x;if(x.type&&x.description)return x.type+" : "+x.description;if("object"!=typeof x)return"Strange case";try{return JSON.stringify(x)}catch(oops){for(name in result="{",x)x.hasOwnProperty(name)&&"string"==typeof x[name]&&(result=result+name+"='"+x[name]+"' ");return result+"}"}},this.initMediaSource=function(successCallback,errorCallback,streamName){if(logDebug("about to request local media"),streamName||(streamName="default"),haveAudioVideo={audio:self.audioEnabled,video:self.videoEnabled},errorCallback||(errorCallback=function(errorCode,errorText){var message="easyrtc.initMediaSource: "+self.formatError(errorText);logDebug(message),self.showError(self.errCodes.MEDIA_ERR,message)}),self.supportsGetUserMedia())if(successCallback){var firstCallTime,mode=self.getUserMediaConstraints(),onUserMediaSuccess=function(stream){var videoObj,triesLeft,tryToGetSize;logDebug("getUserMedia success callback entered"),logDebug("successfully got local media"),stream.streamName=streamName,registerLocalMediaStreamByName(stream,streamName),haveAudioVideo.video?((videoObj=document.createElement("video")).style.display="none",document.body.appendChild(videoObj),videoObj.muted=!0,triesLeft=30,tryToGetSize=function(){videoObj.videoWidth>0||triesLeft<0?(self.nativeVideoWidth=videoObj.videoWidth,self.nativeVideoHeight=videoObj.videoHeight,!self._desiredVideoProperties.height||self.nativeVideoHeight===self._desiredVideoProperties.height&&self.nativeVideoWidth===self._desiredVideoProperties.width||self.showError(self.errCodes.MEDIA_WARNING,self.format(self.getConstantString("resolutionWarning"),self._desiredVideoProperties.width,self._desiredVideoProperties.height,self.nativeVideoWidth,self.nativeVideoHeight)),self.clearMediaStream(videoObj),videoObj.removeNode?videoObj.removeNode(!0):document.body.removeChild(videoObj),updateConfigurationInfo(),successCallback&&successCallback(stream)):(triesLeft-=1,setTimeout(tryToGetSize,300))},self.setVideoObjectSrc(videoObj,stream),tryToGetSize()):(updateConfigurationInfo(),successCallback&&successCallback(stream))},onUserMediaError=function(error){var errText;logDebug("getusermedia failed"),logDebug("failed to get local media"),errText="string"==typeof error?error:error.name?error.name:"Unknown",errorCallback&&(logDebug("invoking error callback",errText),errorCallback(self.errCodes.MEDIA_ERR,self.format(self.getConstantString("gumFailed"),errText))),closeLocalMediaStreamByName(streamName),haveAudioVideo={audio:!1,video:!1},updateConfigurationInfo()};self.audioEnabled||self.videoEnabled?(firstCallTime=getCurrentTime(),navigator.mediaDevices.getUserMedia(mode).then(onUserMediaSuccess).catch(function(err){getCurrentTime()<firstCallTime+1e3?(logDebug("Trying getUserMedia a second time"),navigator.mediaDevices.getUserMedia(mode).then(onUserMediaSuccess).catch(onUserMediaError)):onUserMediaError(err)})):onUserMediaError(self.getConstantString("requireAudioOrVideo"))}else self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.initMediaSource not supplied a successCallback");else errorCallback(self.errCodes.MEDIA_ERR,self.getConstantString("noWebrtcSupport"));function getCurrentTime(){return(new Date).getTime()}},this.setAcceptChecker=function(acceptCheck){self.acceptCheck=acceptCheck},this.setStreamAcceptor=function(acceptor){self.streamAcceptor=acceptor},self.setOnError=function(errListener){self.onError=errListener},this.setCallCancelled=function(callCancelled){self.callCancelled=callCancelled},this.setOnStreamClosed=function(onStreamClosed){self.onStreamClosed=onStreamClosed},this.setPeerListener=function(listener,msgType,source){msgType?(receivePeer.msgTypes[msgType]||(receivePeer.msgTypes[msgType]={sources:{}}),source?receivePeer.msgTypes[msgType].sources[source]={cb:listener}:receivePeer.msgTypes[msgType].cb=listener):receivePeer.cb=listener},this.receivePeerDistribute=function(easyrtcid,msg,targeting){var msgType=msg.msgType,msgData=msg.msgData;if(msgType){if(receivePeer.msgTypes[msgType]){if(receivePeer.msgTypes[msgType].sources[easyrtcid]&&receivePeer.msgTypes[msgType].sources[easyrtcid].cb)return void receivePeer.msgTypes[msgType].sources[easyrtcid].cb(easyrtcid,msgType,msgData,targeting);if(receivePeer.msgTypes[msgType].cb)return void receivePeer.msgTypes[msgType].cb(easyrtcid,msgType,msgData,targeting)}receivePeer.cb&&receivePeer.cb(easyrtcid,msgType,msgData,targeting)}else logDebug("received peer message without msgType",msg)},this.setServerListener=function(listener){receiveServerCB=listener},this.setSocketUrl=function(socketUrl,options){logDebug("WebRTC signaling server URL set to "+socketUrl),serverPath=socketUrl,options&&(connectionOptions=options)},this.setUsername=function(username){return self.myEasyrtcid?(self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.setUsername called after authentication"),!1):self.isNameValid(username)?(self.username=username,!0):(self.showError(self.errCodes.BAD_NAME,self.format(self.getConstantString("badUserName"),username)),!1)},this.usernameToIds=function(username,room){var id,roomName,results=[];for(roomName in lastLoggedInList)if(lastLoggedInList.hasOwnProperty(roomName)&&(!room||roomName===room))for(id in lastLoggedInList[roomName])lastLoggedInList[roomName].hasOwnProperty(id)&&lastLoggedInList[roomName][id].username===username&&results.push({easyrtcid:id,roomName:roomName});return results},this.getRoomApiField=function(roomName,easyrtcid,fieldName){return lastLoggedInList[roomName]&&lastLoggedInList[roomName][easyrtcid]&&lastLoggedInList[roomName][easyrtcid].apiField&&lastLoggedInList[roomName][easyrtcid].apiField[fieldName]?lastLoggedInList[roomName][easyrtcid].apiField[fieldName].fieldValue:undefined},this.setCredential=function(credentialParm){try{return JSON.stringify(credentialParm),credential=credentialParm,!0}catch(oops){throw self.showError(self.errCodes.BAD_CREDENTIAL,"easyrtc.setCredential passed a non-JSON-able object"),"easyrtc.setCredential passed a non-JSON-able object"}},this.setDisconnectListener=function(disconnectListener){self.disconnectListener=disconnectListener},this.idToName=function(easyrtcid){var roomName;for(roomName in lastLoggedInList)if(lastLoggedInList.hasOwnProperty(roomName)&&lastLoggedInList[roomName][easyrtcid]&&lastLoggedInList[roomName][easyrtcid].username)return lastLoggedInList[roomName][easyrtcid].username;return easyrtcid},this.webSocket=null;var pc_config={},pc_config_to_use=null,use_fresh_ice_each_peer=!1;function getRemoteStreamByName(peerConn,otherUser,streamName){var keyToMatch=null,remoteStreams=peerConn.pc.getRemoteStreams();if(streamName||(streamName="default"),"default"===streamName)return remoteStreams.length>0?remoteStreams[0]:null;for(var roomName in self.roomData)if(self.roomData.hasOwnProperty(roomName)){var mediaIds=self.getRoomApiField(roomName,otherUser,"mediaIds");if(keyToMatch=mediaIds?mediaIds[streamName]:null)break}keyToMatch||self.showError(self.errCodes.DEVELOPER_ERR,"remote peer does not have media stream called "+streamName);for(var i=0;i<remoteStreams.length;i++){var remoteId;if(remoteId=remoteStreams[i].id?remoteStreams[i].id:"default",!keyToMatch||remoteId===keyToMatch||0===remoteId.indexOf(keyToMatch))return remoteStreams[i]}return null}function _haveTracks(easyrtcid,checkAudio,streamName){var stream,tracks;if(easyrtcid){if(!peerConns[easyrtcid])return self.showError(self.errCodes.DEVELOPER_ERR,"haveTracks called about a peer you don't have a connection to"),!1;stream=getRemoteStreamByName(peerConns[easyrtcid],easyrtcid,streamName)}else stream=getLocalMediaStreamByName(streamName);if(!stream)return!1;try{tracks=checkAudio?stream.getAudioTracks():stream.getVideoTracks()}catch(oops){return!0}return!!tracks&&tracks.length>0}this.setUseFreshIceEachPeerConnection=function(value){use_fresh_ice_each_peer=value},this.getServerIce=function(){return pc_config},this.setIceUsedInCalls=function(ice){ice.iceServers?pc_config_to_use=ice:self.showError(self.errCodes.DEVELOPER_ERR,"Bad ice configuration passed to easyrtc.setIceUsedInCalls")},this.haveAudioTrack=function(easyrtcid,streamName){return _haveTracks(easyrtcid,!0,streamName)},this.haveVideoTrack=function(easyrtcid,streamName){return _haveTracks(easyrtcid,!1,streamName)},this.getRoomField=function(roomName,fieldName){var fields=self.getRoomFields(roomName);return fields&&fields[fieldName]?fields[fieldName].fieldValue:undefined};var fields=null,preallocatedSocketIo=null;function disconnectBody(){var roomName;if(self.loggingOut=!0,offersPending={},acceptancePending={},self.disconnecting=!0,stillAliveTimer&&(clearTimeout(stillAliveTimer),stillAliveTimer=null),self.webSocket&&(preallocatedSocketIo||self.webSocket.close()),self.webSocketConnected=!1,self.webSocket=0,self.hangupAll(),roomOccupantListener)for(roomName in lastLoggedInList)lastLoggedInList.hasOwnProperty(roomName)&&(roomOccupantListener(roomName,{},!1),self.setRoomApiField(roomName));lastLoggedInList={},self.emitEvent("roomOccupant",{}),self.roomData={},self.roomJoin={},self.loggingOut=!1,self.myEasyrtcid=null,self.disconnecting=!1,oldConfig={},self.disconnectListener&&self.disconnectListener()}function sendSignalling(destUser,msgType,msgData,successCallback,errorCallback){if(!self.webSocket)throw"Attempt to send message without a valid connection to the server.";var dataToShip={msgType:msgType};destUser&&(dataToShip.targetEasyrtcid=destUser),msgData&&(dataToShip.msgData=msgData),logDebug("sending socket message "+JSON.stringify(dataToShip)),self.webSocket.json.emit("easyrtcCmd",dataToShip,function(ackMsg){"error"!==ackMsg.msgType?(ackMsg.hasOwnProperty("msgData")||(ackMsg.msgData=null),successCallback&&successCallback(ackMsg.msgType,ackMsg.msgData)):errorCallback?errorCallback(ackMsg.msgData.errorCode,ackMsg.msgData.errorText):self.showError(ackMsg.msgData.errorCode,ackMsg.msgData.errorText)})}this.disconnect=function(){logDebug("attempt to disconnect from WebRTC signalling server"),self.disconnecting=!0,self.hangupAll(),self.loggingOut=!0,setTimeout(disconnectBody,250)};var sendByChunkUidCounter=0;function sendQueuedCandidates(peer,onSignalSuccess,onSignalFailure){var i;for(i=0;i<peerConns[peer].candidatesToSend.length;i++)sendSignalling(peer,"candidate",peerConns[peer].candidatesToSend[i],onSignalSuccess,onSignalFailure)}function emitOnStreamClosed(easyrtcid,stream){if(peerConns[easyrtcid]){var streamId=stream.id||"default",streamName=getNameOfRemoteStream(easyrtcid,streamId)||"default";peerConns[easyrtcid].liveRemoteStreams[streamName]&&(delete peerConns[easyrtcid].liveRemoteStreams[streamName],self.onStreamClosed&&self.onStreamClosed(easyrtcid,stream,streamName)),delete peerConns[easyrtcid].remoteStreamIdToName[streamId]}}function collectConfigurationInfo(){var i,p2pList={};for(i in peerConns)peerConns.hasOwnProperty(i)&&(p2pList[i]={connectTime:peerConns[i].connectTime,isInitiator:!!peerConns[i].isInitiator});var newConfig={userSettings:{sharingAudio:!!haveAudioVideo.audio,sharingVideo:!!haveAudioVideo.video,sharingData:!!dataEnabled,nativeVideoWidth:self.nativeVideoWidth,nativeVideoHeight:self.nativeVideoHeight,windowWidth:window.innerWidth,windowHeight:window.innerHeight,screenWidth:window.screen.width,screenHeight:window.screen.height,cookieEnabled:navigator.cookieEnabled,os:navigator.oscpu,language:navigator.language}};return isEmptyObj(p2pList)||(newConfig.p2pList=p2pList),newConfig}function processCandidate(candidate){self._candidates=self._candidates||[],self._candidates.push(function(text){var priority,s,pos=text.indexOf("candidate:")+"candidate:".length,fields=text.substr(pos).split(" ");return{component:fields[1],type:fields[7],foundation:fields[0],protocol:fields[2],address:fields[4],port:fields[5],priority:(priority=fields[3],s="",s+=priority>>24,s+=" | ",s+=priority>>8&65535,s+=" | ",s+=255&priority)}}(candidate))}function processAddedStream(otherUser,peerStream){if(peerConns[otherUser]&&!peerConns[otherUser].cancelled){var peerConn=peerConns[otherUser];peerConn.startedAV||(peerConn.startedAV=!0,peerConn.sharingAudio=haveAudioVideo.audio,peerConn.sharingVideo=haveAudioVideo.video,peerConn.connectTime=(new Date).getTime(),peerConn.callSuccessCB&&(peerConn.sharingAudio||peerConn.sharingVideo)&&peerConn.callSuccessCB(otherUser,"audiovideo"),(self.audioEnabled||self.videoEnabled)&&(newConfig=collectConfigurationInfo(),sendDeltas=function(){var alteredData=function findDeltas(oldVersion,newVersion){var i,added={},deleted={};for(i in newVersion)newVersion.hasOwnProperty(i)&&(null===oldVersion||void 0===oldVersion[i]?added[i]=newVersion[i]:"object"==typeof newVersion[i]?null!==findDeltas(oldVersion[i],newVersion[i])&&(added[i]=newVersion[i]):newVersion[i]!==oldVersion[i]&&(added[i]=newVersion[i]));for(i in oldVersion)newVersion.hasOwnProperty(i)&&void 0===newVersion[i]&&(deleted[i]=oldVersion[i]);return function(added,deleted){function objectNotEmpty(obj){var i;for(i in obj)if(obj.hasOwnProperty(i))return!0;return!1}var result={};return objectNotEmpty(added)&&(result.added=added),objectNotEmpty(deleted)&&(result.deleted=deleted),objectNotEmpty(result)?result:null}(added,deleted)}(oldConfig,newConfig);alteredData&&(logDebug("cfg="+JSON.stringify(alteredData.added)),self.webSocket&&sendSignalling(null,"setUserCfg",{setUserCfg:alteredData.added},null,null)),oldConfig=newConfig},oldConfig==={}?sendDeltas():setTimeout(sendDeltas,100)));var streamId=peerStream.id||"default",remoteName=getNameOfRemoteStream(otherUser,streamId)||"default";if(peerConn.liveRemoteStreams[remoteName])logDebug("remove stream "+remoteName+" already exist");else{peerConn.remoteStreamIdToName[streamId]=remoteName,peerConn.liveRemoteStreams[remoteName]=!0,peerStream.streamName=remoteName;var tracks=peerStream.getTracks();peerStream.addEventListener("removetrack",function(e){var trackIndex=tracks.indexOf(e.track);-1!==trackIndex&&tracks.splice(trackIndex,1),0===tracks.length&&emitOnStreamClosed(otherUser,peerStream)}),self.streamAcceptor&&(self.streamAcceptor(otherUser,peerStream,remoteName),self.sendDataWS(otherUser,"easyrtc_streamReceived",{streamName:remoteName},function(){}))}}var newConfig,sendDeltas}function buildPeerConnection(otherUser,isInitiator,failureCB,streamNames){var pc,message,newPeerConn,options,i,stream,iceConfig=pc_config_to_use||pc_config;logDebug("building peer connection to "+otherUser);try{if(!(pc=self.createRTCPeerConnection(iceConfig,((options=[]).push({DtlsSrtpKeyAgreement:"true"}),{optional:options}))))throw logDebug(message="Unable to create PeerConnection object, check your ice configuration("+JSON.stringify(iceConfig)+")"),Error(message);dataEnabled&&void 0===pc.createDataChannel&&(dataEnabled=!1),pc.onnegotiationneeded=function(event){logDebug("onnegotiationneeded",(event.currentTarget||event.target||pc).signalingState||"unknown"),peerConns[otherUser]&&peerConns[otherUser].enableNegotiateListener&&initiateSendOffer(otherUser)},pc.onsignalingstatechange=function(){var eventTarget=event.currentTarget||event.target||pc,signalingState=eventTarget.signalingState||"unknown";logDebug("onsignalingstatechange",signalingState),signalingStateChangeListener&&signalingStateChangeListener(otherUser,eventTarget,signalingState)},pc.oniceconnectionstatechange=function(event){var eventTarget=event.currentTarget||event.target||pc,connState=eventTarget.iceConnectionState||"unknown";switch(logDebug("onsignalingstatechange",connState),iceConnectionStateChangeListener&&iceConnectionStateChangeListener(otherUser,eventTarget,connState),connState){case"connected":self.onPeerOpen&&self.onPeerOpen(otherUser),peerConns[otherUser]&&peerConns[otherUser].callSuccessCB&&peerConns[otherUser].callSuccessCB(otherUser,"connection");break;case"failed":failureCB&&failureCB(self.errCodes.NOVIABLEICE,"No usable STUN/TURN path"),delete peerConns[otherUser];break;case"disconnected":self.onPeerFailing&&self.onPeerFailing(otherUser),peerConns[otherUser]&&(peerConns[otherUser].failing=Date.now());break;case"closed":self.onPeerClosed&&self.onPeerClosed(otherUser);break;case"completed":peerConns[otherUser]&&(peerConns[otherUser].failing&&self.onPeerRecovered&&self.onPeerRecovered(otherUser,peerConns[otherUser].failing,Date.now()),delete peerConns[otherUser].failing)}},pc.onconnection=function(){logDebug("onconnection called prematurely")},newPeerConn={pc:pc,candidatesToSend:[],startedAV:!1,connectionAccepted:!1,isInitiator:isInitiator,remoteStreamIdToName:{},streamsAddedAcks:{},liveRemoteStreams:{},supportHalfTrickleIce:!1},pc.onicecandidate=function(event){var candidateData;if((!peerConns[otherUser]||!peerConns[otherUser].cancelled)&&event.candidate&&peerConns[otherUser]){if(candidateData={type:"candidate",label:event.candidate.sdpMLineIndex,id:event.candidate.sdpMid,candidate:event.candidate.candidate},iceCandidateFilter&&!(candidateData=iceCandidateFilter(candidateData,!1)))return;processCandidate(event.candidate.candidate),peerConns[otherUser].connectionAccepted||peerConns[otherUser].supportHalfTrickleIce?sendSignalling(otherUser,"candidate",candidateData,null,function(){failureCB(self.errCodes.PEER_GONE,"Candidate disappeared")}):peerConns[otherUser].candidatesToSend.push(candidateData)}},pc.ontrack=function(event){logDebug("saw ontrack method invoked, which is expected"),function(otherUser,peerStreams){if(peerConns[otherUser]&&!peerConns[otherUser].cancelled){var peerConn=peerConns[otherUser];peerConn.trackTimers=peerConn.trackTimers||{};for(var i=0,l=peerStreams.length;i<l;i++){var peerStream=peerStreams[i],streamId=peerStream.id||"default";clearTimeout(peerConn.trackTimers[streamId]),peerConn.trackTimers[streamId]=setTimeout(processAddedStream.bind(null,otherUser,peerStream),100)}}}(otherUser,event.streams)},pc.onaddstream=function(event){logDebug("empty onaddstream method invoked, which is expected"),processAddedStream(otherUser,event.stream)},pc.onremovestream=function(event){logDebug("saw remove on remote media stream"),function(easyrtcid,stream){if(peerConns[easyrtcid]&&(emitOnStreamClosed(easyrtcid,stream),updateConfigurationInfo(),peerConns[easyrtcid].pc))try{peerConns[easyrtcid].pc.removeStream(stream)}catch(err){}}(otherUser,event.stream)},peerConns[otherUser]=newPeerConn}catch(error){return logDebug("buildPeerConnection error",error),failureCB(self.errCodes.SYSTEM_ERR,error.message),null}if(streamNames)for(i=0;i<streamNames.length;i++)(stream=getLocalMediaStreamByName(streamNames[i]))?addStreamToPeerConnection(stream,pc):logDebug("Developer error, attempt to access unknown local media stream "+streamNames[i]);else autoInitUserMedia&&(self.videoEnabled||self.audioEnabled)&&addStreamToPeerConnection(stream=self.getLocalStream(),pc);var pendingTransfer={};function dataChannelMessageHandler(event){if(logDebug("saw dataChannel.onmessage event: ",event.data),"dataChannelPrimed"===event.data)self.sendDataWS(otherUser,"dataChannelPrimed","");else{var msg;try{msg=JSON.parse(event.data)}catch(err){logDebug("Developer error, unable to parse event data")}if(msg)if(msg.transfer&&msg.transferId)if("start"===msg.transfer){logDebug("start transfer #"+msg.transferId);var parts=parseInt(msg.parts);pendingTransfer={chunks:[],parts:parts,transferId:msg.transferId}}else if("chunk"===msg.transfer)logDebug("got chunk for transfer #"+msg.transferId),"string"==typeof msg.data&&msg.data.length<=self.maxP2PMessageLength?pendingTransfer?msg.transferId!==pendingTransfer.transferId?logDebug("Developer error, invalid transfer id"):pendingTransfer.chunks.length+1>pendingTransfer.parts?logDebug("Developer error, received too many chunks"):pendingTransfer.chunks.push(msg.data):logDebug("Developer error, unexpected chunk"):logDebug("Developer error, invalid data");else if("end"===msg.transfer){if(logDebug("end of transfer #"+msg.transferId),pendingTransfer)if(msg.transferId!==pendingTransfer.transferId)logDebug("Developer error, invalid transfer id");else if(pendingTransfer.chunks.length!==pendingTransfer.parts)logDebug("Developer error, received wrong number of chunks");else{var chunkedMsg;try{chunkedMsg=JSON.parse(pendingTransfer.chunks.join(""))}catch(err){logDebug("Developer error, unable to parse message")}chunkedMsg&&self.receivePeerDistribute(otherUser,chunkedMsg,null)}else logDebug("Developer error, unexpected end of transfer");pendingTransfer={}}else logDebug("Developer error, got an unknown transfer message"+msg.transfer);else self.receivePeerDistribute(otherUser,msg,null)}}if(dataEnabled){if(self.setPeerListener(function(){peerConns[otherUser]?(peerConns[otherUser].dataChannelReady=!0,peerConns[otherUser].callSuccessCB&&peerConns[otherUser].callSuccessCB(otherUser,"datachannel"),onDataChannelOpen&&onDataChannelOpen(otherUser,!0),updateConfigurationInfo()):logDebug("failed to setup outgoing channel listener")},"dataChannelPrimed",otherUser),isInitiator)try{!function(otherUser){logDebug("saw initOutgoingChannel call");var dataChannel=pc.createDataChannel(dataChannelName,self.getDatachannelConstraints());peerConns[otherUser].dataChannelS=dataChannel,peerConns[otherUser].dataChannelR=dataChannel,dataChannel.onmessage=dataChannelMessageHandler,dataChannel.onopen=function(event){logDebug("saw dataChannel.onopen event"),peerConns[otherUser]&&dataChannel.send("dataChannelPrimed")},dataChannel.onclose=function(event){logDebug("saw dataChannelS.onclose event"),peerConns[otherUser]&&(peerConns[otherUser].dataChannelReady=!1,delete peerConns[otherUser].dataChannelS),onDataChannelClose&&onDataChannelClose(otherUser),updateConfigurationInfo()}}(otherUser)}catch(channelErrorEvent){logDebug("failed to init outgoing channel"),failureCB(self.errCodes.SYSTEM_ERR,self.formatError(channelErrorEvent))}isInitiator||function(otherUser){logDebug("initializing incoming channel handler for "+otherUser),peerConns[otherUser].pc.ondatachannel=function(event){logDebug("saw incoming data channel");var dataChannel=event.channel;peerConns[otherUser].dataChannelR=dataChannel,peerConns[otherUser].dataChannelS=dataChannel,peerConns[otherUser].dataChannelReady=!0,dataChannel.onmessage=dataChannelMessageHandler,dataChannel.onclose=function(event){logDebug("saw dataChannelR.onclose event"),peerConns[otherUser]&&(peerConns[otherUser].dataChannelReady=!1,delete peerConns[otherUser].dataChannelR),onDataChannelClose&&onDataChannelClose(otherUser),updateConfigurationInfo()},dataChannel.onopen=function(event){logDebug("saw dataChannel.onopen event"),peerConns[otherUser]&&dataChannel.send("dataChannelPrimed")}}}(otherUser)}return pc.onconnection=function(){logDebug("setup pc.onconnection ")},self.setPeerListener(function(easyrtcid,msgType,msgData,targeting){newPeerConn.streamsAddedAcks[msgData.streamName]&&(newPeerConn.streamsAddedAcks[msgData.streamName](easyrtcid,msgData.streamName),delete newPeerConn.streamsAddedAcks[msgData.streamName])},"easyrtc_streamReceived",otherUser),pc}function doAnswerBody(caller,msgData,streamNames){peerConns[caller]||buildPeerConnection(caller,!1,function(message){self.showError(self.errCodes.SYSTEM_ERR,message)},streamNames);var newPeerConn=peerConns[caller],pc=newPeerConn.pc;if(pc){var setLocalAndSendMessage1=function(sessionDescription){newPeerConn.cancelled||(sdpLocalFilter&&(sessionDescription.sdp=sdpLocalFilter(sessionDescription.sdp)),pc.setLocalDescription(sessionDescription).then(function(){function onSignalSuccess(){logDebug("sending success")}function onSignalFailure(errorCode,errorText){logDebug("sending error"),delete peerConns[caller],self.showError(errorCode,errorText)}logDebug("sending answer"),newPeerConn.pendingAwnser=!1,sendSignalling(caller,"answer",sessionDescription,onSignalSuccess,onSignalFailure),peerConns[caller].connectionAccepted=!0,sendQueuedCandidates(caller,onSignalSuccess,onSignalFailure),pc.connectDataConnection&&(logDebug("calling connectDataConnection(5002,5001)"),pc.connectDataConnection(5002,5001))},function(message){newPeerConn.pendingAwnser=!1,self.showError(self.errCodes.INTERNAL_ERR,"setLocalDescription: "+message)}))},sd=new RTCSessionDescription(msgData);if(!sd)throw"Could not create the RTCSessionDescription";logDebug("sdp ||  "+JSON.stringify(sd)),logDebug("about to call setRemoteDescription in doAnswer");try{sdpRemoteFilter&&(sd=new RTCSessionDescription({type:sd.type,sdp:sdpRemoteFilter(sd.sdp)})),logDebug("sdp ||  "+JSON.stringify(sd)),pc.setRemoteDescription(sd).then(function(){newPeerConn.cancelled?logDebug("invokeCreateAnswer.canceled",pc.signalingState):(newPeerConn.pendingAwnser&&logDebug("invokeCreateAnswer.pending",pc.signalingState),logDebug("invokeCreateAnswer",pc.signalingState),newPeerConn.pendingAwnser=!0,pc.createAnswer(receivedMediaConstraints).then(setLocalAndSendMessage1).catch(function(reason){newPeerConn.pendingAwnser=!1,self.showError(self.errCodes.INTERNAL_ERR,"create-answer: "+reason)}))},function(message){self.showError(self.errCodes.INTERNAL_ERR,"doAnswerBody setRemoteDescription failed: "+message)})}catch(srdError){logDebug("set remote description failed"),self.showError(self.errCodes.INTERNAL_ERR,"doAnswerBody setRemoteDescription error: "+srdError.message)}}else logDebug("buildPeerConnection failed. Call not answered")}function doAnswer(caller,msgData,streamNames){streamNames||!autoInitUserMedia||self.getLocalStream()||!self.videoEnabled&&!self.audioEnabled?use_fresh_ice_each_peer?self.getFreshIceConfig(function(succeeded){succeeded?doAnswerBody(caller,msgData,streamNames):self.showError(self.errCodes.CALL_ERR,"Failed to get fresh ice config")}):doAnswerBody(caller,msgData,streamNames):self.initMediaSource(function(){doAnswer(caller,msgData)},function(errorCode,error){self.showError(self.errCodes.MEDIA_ERR,self.format(self.getConstantString("localMediaError")))})}function callBody(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB,streamNames){if(acceptancePending[otherUser]=!0,!buildPeerConnection(otherUser,!0,callFailureCB,streamNames))throw logDebug("buildPeerConnection failed, call not completed"),"buildPeerConnection failed, call not completed";peerConns[otherUser].callSuccessCB=callSuccessCB,peerConns[otherUser].callFailureCB=callFailureCB,peerConns[otherUser].wasAcceptedCB=wasAcceptedCB,initiateSendOffer(otherUser)}function initiateSendOffer(otherUser){var peerConnObj=peerConns[otherUser];if(peerConnObj){var pc=peerConnObj.pc,callFailureCB=peerConnObj.callFailureCB||self.showError;peerConnObj.sendingOffer?logDebug("initiateSendOffer.setLocalAndSendMessage0.ignored",peerConnObj.sendingOffer):(peerConnObj.sendingOffer=!0,pc.createOffer(receivedMediaConstraints).then(function(sessionDescription){peerConnObj.cancelled?logDebug("initiateSendOffer.setLocalAndSendMessage0.ignored",peerConnObj.cancelled):(sdpLocalFilter&&(sessionDescription.sdp=sdpLocalFilter(sessionDescription.sdp)),pc.setLocalDescription(sessionDescription).then(function(){peerConnObj.sendingOffer=!1,sendSignalling(otherUser,"offer",sessionDescription,null,peerConnObj.callFailureCB)},function(errorText){peerConnObj.sendingOffer=!1,callFailureCB(self.errCodes.CALL_ERR,errorText)}))}).catch(function(errorObj){peerConnObj.sendingOffer=!1,callFailureCB(self.errCodes.CALL_ERR,JSON.stringify(errorObj))}))}else logDebug("message attempt to send offer for nonexistent peer connection "+otherUser)}this.sendDataP2P=function(destUser,msgType,msgData){var flattenedData=JSON.stringify({msgType:msgType,msgData:msgData});if(logDebug("sending p2p message to "+destUser+" with data="+JSON.stringify(flattenedData)),peerConns[destUser])if(peerConns[destUser].dataChannelS)if(peerConns[destUser].dataChannelReady)try{flattenedData.length>self.maxP2PMessageLength?function(destUser,msgData){var pos,len,message,endMessage,transferId=destUser+"-"+sendByChunkUidCounter++,numberOfChunks=Math.ceil(msgData.length/self.maxP2PMessageLength);for(endMessage={transfer:"end",transferId:transferId},peerConns[destUser].dataChannelS.send(JSON.stringify({transfer:"start",transferId:transferId,parts:numberOfChunks})),pos=0,len=msgData.length;pos<len;pos+=self.maxP2PMessageLength)message={transferId:transferId,data:msgData.substr(pos,self.maxP2PMessageLength),transfer:"chunk"},peerConns[destUser].dataChannelS.send(JSON.stringify(message));peerConns[destUser].dataChannelS.send(JSON.stringify(endMessage))}(destUser,flattenedData):peerConns[destUser].dataChannelS.send(flattenedData)}catch(sendDataErr){throw logDebug("sendDataP2P error: ",sendDataErr),sendDataErr}else self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to use data channel to "+destUser+" before it's ready to send.");else self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without establishing a data channel to "+destUser+" first.");else self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without a connection to "+destUser+" first.")},this.sendDataWS=function(destination,msgType,msgData,ackhandler){logDebug("sending client message via websockets to "+destination+" with data="+JSON.stringify(msgData)),ackhandler||(ackhandler=function(msg){"error"===msg.msgType&&self.showError(msg.msgData.errorCode,msg.msgData.errorText)});var outgoingMessage={msgType:msgType,msgData:msgData};if(destination&&("string"==typeof destination?outgoingMessage.targetEasyrtcid=destination:"object"==typeof destination&&(destination.targetEasyrtcid&&(outgoingMessage.targetEasyrtcid=destination.targetEasyrtcid),destination.targetRoom&&(outgoingMessage.targetRoom=destination.targetRoom),destination.targetGroup&&(outgoingMessage.targetGroup=destination.targetGroup))),!self.webSocket)throw logDebug("websocket failed because no connection to server"),"Attempt to send message without a valid connection to the server.";self.webSocket.json.emit("easyrtcMsg",outgoingMessage,ackhandler)},this.sendData=function(destUser,msgType,msgData,ackHandler){peerConns[destUser]&&peerConns[destUser].dataChannelReady?self.sendDataP2P(destUser,msgType,msgData):self.sendDataWS(destUser,msgType,msgData,ackHandler)},this.sendPeerMessage=function(destination,msgType,msgData,successCB,failureCB){destination||self.showError(self.errCodes.DEVELOPER_ERR,"destination was null in sendPeerMessage"),logDebug("sending peer message "+JSON.stringify(msgData)),self.sendDataWS(destination,msgType,msgData,function(response){"error"===response.msgType?failureCB&&failureCB(response.msgData.errorCode,response.msgData.errorText):successCB&&successCB(response.msgType,response.msgData?response.msgData:null)})},this.sendServerMessage=function(msgType,msgData,successCB,failureCB){logDebug("sending server message "+JSON.stringify({msgType:msgType,msgData:msgData})),self.sendDataWS(null,msgType,msgData,function(response){"error"===response.msgType?failureCB&&failureCB(response.msgData.errorCode,response.msgData.errorText):successCB&&successCB(response.msgType,response.msgData?response.msgData:null)})},this.getRoomList=function(callback,errorCallback){sendSignalling(null,"getRoomList",null,function(msgType,msgData){callback(msgData.roomList)},function(errorCode,errorText){errorCallback?errorCallback(errorCode,errorText):self.showError(errorCode,errorText)})},this.NOT_CONNECTED="not connected",this.BECOMING_CONNECTED="connection in progress to us.",this.IS_CONNECTED="is connected",this.getConnectStatus=function(otherUser){if(!peerConns.hasOwnProperty(otherUser))return self.NOT_CONNECTED;var peer=peerConns[otherUser];return!peer.sharingAudio&&!peer.sharingVideo||peer.startedAV?peer.sharingData&&!peer.dataChannelReady?self.BECOMING_CONNECTED:self.IS_CONNECTED:self.BECOMING_CONNECTED},this.call=function(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB,streamNames){if(streamNames)if("string"==typeof streamNames)streamNames=[streamNames];else if(void 0===streamNames.length)return void self.showError(self.errCodes.DEVELOPER_ERR,"easyrtc.call passed bad streamNames");if(logDebug("initiating peer to peer call to "+otherUser+" audio="+self.audioEnabled+" video="+self.videoEnabled+" data="+dataEnabled),self.supportsPeerConnections()){var message;if(!streamNames&&autoInitUserMedia&&!self.getLocalStream()&&(self.audioEnabled||self.videoEnabled))return void self.initMediaSource(function(){self.call(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB)},callFailureCB);if(!self.webSocket)throw logDebug(message="Attempt to make a call prior to connecting to service"),message;offersPending[otherUser]?(wasAcceptedCB(!0,otherUser),doAnswer(otherUser,offersPending[otherUser],streamNames),self.callCancelled(otherUser,!1)):void 0!==acceptancePending[otherUser]?(logDebug(message="Call already pending acceptance"),callFailureCB(self.errCodes.ALREADY_CONNECTED,message)):use_fresh_ice_each_peer?self.getFreshIceConfig(function(succeeded){succeeded?callBody(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB,streamNames):callFailureCB(self.errCodes.CALL_ERR,"Attempt to get fresh ice configuration failed")}):callBody(otherUser,callSuccessCB,callFailureCB,wasAcceptedCB,streamNames)}else callFailureCB(self.errCodes.CALL_ERR,self.getConstantString("noWebrtcSupport"))};var queuedMessages={};function clearQueuedMessages(caller){queuedMessages[caller]={candidates:[]}}function closePeer(otherUser){if(acceptancePending[otherUser]&&delete acceptancePending[otherUser],offersPending[otherUser]&&delete offersPending[otherUser],!peerConns[otherUser].cancelled&&peerConns[otherUser].pc)try{peerConns[otherUser].cancelled=!0;for(var remoteStreams=peerConns[otherUser].pc.getRemoteStreams(),i=0;i<remoteStreams.length;i++)(!0===(stream=remoteStreams[i]).active||!1===stream.ended||stream.getTracks().reduce(function(track){return track.enabled}))&&(emitOnStreamClosed(otherUser,remoteStreams[i]),stopStream(remoteStreams[i]));peerConns[otherUser].pc.close(),logDebug("peer closed")}catch(err){logDebug("peer "+otherUser+" close failed:"+err)}finally{self.onPeerClosed&&self.onPeerClosed(otherUser)}var stream}function hangupBody(otherUser){logDebug("Hanging up on "+otherUser),clearQueuedMessages(otherUser),peerConns[otherUser]&&(peerConns[otherUser].pc&&closePeer(otherUser),peerConns[otherUser]&&delete peerConns[otherUser],updateConfigurationInfo(),self.webSocket&&sendSignalling(otherUser,"hangup",null,function(){logDebug("hangup succeeds")},function(errorCode,errorText){logDebug("hangup failed:"+errorText),self.showError(errorCode,errorText)}))}function onRemoteHangup(otherUser){logDebug("Saw onRemote hangup event"),clearQueuedMessages(otherUser),peerConns[otherUser]?(peerConns[otherUser].pc?closePeer(otherUser):self.callCancelled&&self.callCancelled(otherUser,!0),peerConns[otherUser]&&delete peerConns[otherUser]):self.callCancelled&&self.callCancelled(otherUser,!0)}function isPeerInAnyRoom(id){var roomName;for(roomName in lastLoggedInList)if(lastLoggedInList.hasOwnProperty(roomName)&&lastLoggedInList[roomName][id])return!0;return!1}this.hangup=function(otherUser){hangupBody(otherUser),updateConfigurationInfo()},this.hangupAll=function(){var sawAConnection=!1;for(var otherUser in peerConns)peerConns.hasOwnProperty(otherUser)&&(sawAConnection=!0,hangupBody(otherUser));sawAConnection&&updateConfigurationInfo()},this.doesDataChannelWork=function(otherUser){return!!peerConns[otherUser]&&!!peerConns[otherUser].dataChannelReady},this.getRemoteStream=function(easyrtcid,remoteStreamName){if(peerConns[easyrtcid])return getRemoteStreamByName(peerConns[easyrtcid],easyrtcid,remoteStreamName);throw self.showError(self.errCodes.DEVELOPER_ERR,"attempt to get stream of uncalled party"),"Developer err: no such stream"},this.makeLocalStreamFromRemoteStream=function(easyrtcid,remoteStreamName,localStreamName){var remoteStream;if(!peerConns[easyrtcid].pc)throw"Developer err: no such peer ";if(!(remoteStream=getRemoteStreamByName(peerConns[easyrtcid],easyrtcid,remoteStreamName)))throw"Developer err: no such stream";registerLocalMediaStreamByName(remoteStream,localStreamName)},this.addStreamToCall=function(easyrtcId,streamName,receiptHandler){streamName||(streamName="default");var stream=getLocalMediaStreamByName(streamName);if(stream)if(peerConns[easyrtcId]&&peerConns[easyrtcId].pc){var pc=peerConns[easyrtcId].pc;peerConns[easyrtcId].enableNegotiateListener=!0,addStreamToPeerConnection(stream,pc),receiptHandler&&(peerConns[easyrtcId].streamsAddedAcks[streamName]=receiptHandler)}else logDebug("Can't add stream before a call has started.");else logDebug("attempt to add nonexistent stream "+streamName)},this.removeStreamFromCall=function(easyrtcId,streamName){streamName||(streamName="default");var stream=getLocalMediaStreamByName(streamName);if(stream)if(peerConns[easyrtcId]&&peerConns[easyrtcId].pc){var pc=peerConns[easyrtcId].pc;peerConns[easyrtcId].enableNegotiateListener=!0,pc.removeStream(stream)}else logDebug("Can't remove stream before a call has started.");else logDebug("attempt to remove nonexistent stream "+streamName)},this.dumpPeerConnectionInfo=function(){var i;for(var peer in peerConns)if(peerConns.hasOwnProperty(peer)){var pc=peerConns[peer].pc,remotes=pc.getRemoteStreams(),remoteIds=[];for(i=0;i<remotes.length;i++)remoteIds.push(remotes[i].id);var locals=pc.getLocalStreams(),localIds=[];for(i=0;i<locals.length;i++)localIds.push(locals[i].id);logDebug("For peer "+peer),logDebug("    "+JSON.stringify({local:localIds,remote:remoteIds}))}},this.isPeerInAnyRoom=function(easyrtcid){return isPeerInAnyRoom(easyrtcid)};var aggregatingTimers={};function processOccupantList(roomName,occupantList){var id,myInfo=null,reducedList={};for(id in occupantList)occupantList.hasOwnProperty(id)&&(id===self.myEasyrtcid?myInfo=occupantList[id]:reducedList[id]=occupantList[id]);!function(peersInRoom){var id;for(id in peerConns)peerConns.hasOwnProperty(id)&&void 0===peersInRoom[id]&&(isPeerInAnyRoom(id)||((peerConns[id].pc||peerConns[id].isInitiator)&&onRemoteHangup(id),delete offersPending[id],delete acceptancePending[id],clearQueuedMessages(id)));for(id in offersPending)offersPending.hasOwnProperty(id)&&!isPeerInAnyRoom(id)&&(onRemoteHangup(id),clearQueuedMessages(id),delete offersPending[id],delete acceptancePending[id]);for(id in acceptancePending)acceptancePending.hasOwnProperty(id)&&!isPeerInAnyRoom(id)&&(onRemoteHangup(id),clearQueuedMessages(id),delete acceptancePending[id])}(reducedList),function(key,callback,period){period||(period=100);var counter=0;aggregatingTimers[key]&&(clearTimeout(aggregatingTimers[key].timer),counter=aggregatingTimers[key].counter),counter>20?(delete aggregatingTimers[key],callback()):(aggregatingTimers[key]={counter:counter+1},aggregatingTimers[key].timer=setTimeout(function(){delete aggregatingTimers[key],callback()},period))}("roomOccupants&"+roomName,function(){roomOccupantListener&&roomOccupantListener(roomName,reducedList,myInfo),self.emitEvent("roomOccupants",{roomName:roomName,occupants:lastLoggedInList})},100)}function onChannelMsg(msg,ackAcceptorFunc){var targeting={};ackAcceptorFunc&&ackAcceptorFunc(self.ackMessage),msg.targetEasyrtcid&&(targeting.targetEasyrtcid=msg.targetEasyrtcid),msg.targetRoom&&(targeting.targetRoom=msg.targetRoom),msg.targetGroup&&(targeting.targetGroup=msg.targetGroup),msg.senderEasyrtcid?self.receivePeerDistribute(msg.senderEasyrtcid,msg,targeting):receiveServerCB?receiveServerCB(msg.msgType,msg.msgData,targeting):logDebug("Unhandled server message "+JSON.stringify(msg))}function processUrl(url){var ipAddress;0===url.indexOf("turn:")||0===url.indexOf("turns:")?(ipAddress=url.split(/[@:&]/g)[1],self._turnServers[ipAddress]=!0):0!==url.indexOf("stun:")&&0!==url.indexOf("stuns:")||(ipAddress=url.split(/[@:&]/g)[1],self._stunServers[ipAddress]=!0)}function processIceConfig(iceConfig){var i,j,item;for(pc_config={iceServers:[]},self._turnServers={},self._stunServers={},iceConfig&&iceConfig.iceServers&&void 0!==iceConfig.iceServers.length?pc_config={iceServers:iceConfig.iceServers}:self.showError(self.errCodes.DEVELOPER_ERR,"iceConfig received from server didn't have an array called iceServers, ignoring it"),i=0;i<iceConfig.iceServers.length;i++)if((item=iceConfig.iceServers[i]).urls&&item.urls.length){if("string"==typeof item.urls)processUrl(item.urls);else if(item.urls instanceof Array)for(j=0;j<item.urls.length;j++)processUrl(item.urls[j])}else item.url&&processUrl(item.url)}function processSessionData(sessionData){sessionData&&(sessionData.easyrtcsid&&(self.easyrtcsid=sessionData.easyrtcsid),sessionData.field&&(sessionFields=sessionData.field))}function processRoomData(roomData){var k,roomName,stuffToRemove,stuffToAdd,id,removeId;for(roomName in self.roomData=roomData,self.roomData)if(self.roomData.hasOwnProperty(roomName)){if("join"===roomData[roomName].roomStatus){self.roomJoin[roomName]||(self.roomJoin[roomName]=roomData[roomName]);var mediaIds=buildMediaIds();mediaIds!=={}&&self.setRoomApiField(roomName,"mediaIds",mediaIds)}else if("leave"===roomData[roomName].roomStatus){self.roomEntryListener&&self.roomEntryListener(!1,roomName),delete self.roomJoin[roomName],delete lastLoggedInList[roomName];continue}if(roomData[roomName].clientList)lastLoggedInList[roomName]=roomData[roomName].clientList;else if(roomData[roomName].clientListDelta){if(stuffToAdd=roomData[roomName].clientListDelta.updateClient)for(id in stuffToAdd)if(stuffToAdd.hasOwnProperty(id))for(k in lastLoggedInList[roomName]||(lastLoggedInList[roomName]=[]),lastLoggedInList[roomName][id]||(lastLoggedInList[roomName][id]=stuffToAdd[id]),stuffToAdd[id])"apiField"!==k&&"presence"!==k||(lastLoggedInList[roomName][id][k]=stuffToAdd[id][k]);if((stuffToRemove=roomData[roomName].clientListDelta.removeClient)&&lastLoggedInList[roomName])for(removeId in stuffToRemove)stuffToRemove.hasOwnProperty(removeId)&&delete lastLoggedInList[roomName][removeId]}self.roomJoin[roomName]&&roomData[roomName].field&&(fields.rooms[roomName]=roomData[roomName].field),"join"===roomData[roomName].roomStatus&&self.roomEntryListener&&self.roomEntryListener(!0,roomName),processOccupantList(roomName,lastLoggedInList[roomName])}self.emitEvent("roomOccupant",lastLoggedInList)}var processCandidateBody=function(caller,msgData){if(peerConns[caller]&&(!iceCandidateFilter||(msgData=iceCandidateFilter(msgData,!0)))){var candidate=new RTCIceCandidate({sdpMLineIndex:msgData.label,sdpMid:msgData.id,candidate:msgData.candidate});peerConns[caller].pc.addIceCandidate(candidate,function(){logDebug("iceAddSuccess: "+JSON.stringify(msgData)),processCandidate(msgData.candidate)},function(domError){self.showError(self.errCodes.ICECANDIDATE_ERR,"bad ice candidate ("+domError.name+"): "+JSON.stringify(msgData))})}},flushCachedCandidates=function(caller){var i;if(queuedMessages[caller]){for(i=0;i<queuedMessages[caller].candidates.length;i++)processCandidateBody(caller,queuedMessages[caller].candidates[i]);delete queuedMessages[caller]}},processOffer=function(caller,msgData){if(peerConns[caller])doAnswer(caller,msgData,[]);else{var helper=function(wasAccepted,streamNames){if(streamNames)if("string"==typeof streamNames)streamNames=[streamNames];else if(streamNames.length===undefined)return void self.showError(self.errCodes.DEVELOPER_ERR,"accept callback passed invalid streamNames");if(logDebug("offer accept="+wasAccepted),delete offersPending[caller],wasAccepted){if(!self.supportsPeerConnections())return void self.showError(self.errCodes.CALL_ERR,self.getConstantString("noWebrtcSupport"));doAnswer(caller,msgData,streamNames),flushCachedCandidates(caller)}else sendSignalling(caller,"reject",null,null,null),clearQueuedMessages(caller)};if(acceptancePending[caller]&&caller<self.myEasyrtcid)return delete acceptancePending[caller],queuedMessages[caller]&&delete queuedMessages[caller],peerConns[caller]&&(peerConns[caller].wasAcceptedCB&&peerConns[caller].wasAcceptedCB(!0,caller),delete peerConns[caller]),void helper(!0);offersPending[caller]=msgData,self.acceptCheck?self.acceptCheck(caller,helper):helper(!0)}};function onChannelCmd(msg,ackAcceptorFn){var caller=msg.senderEasyrtcid,msgType=msg.msgType,msgData=msg.msgData;switch(logDebug("received message of type "+msgType),void 0===queuedMessages[caller]&&clearQueuedMessages(caller),msgType){case"sessionData":processSessionData(msgData.sessionData);break;case"roomData":processRoomData(msgData.roomData);break;case"iceConfig":processIceConfig(msgData.iceConfig);break;case"forwardToUrl":msgData.newWindow?window.open(msgData.forwardToUrl.url):window.location.href=msgData.forwardToUrl.url;break;case"offer":processOffer(caller,msgData);break;case"reject":!function(caller){delete acceptancePending[caller],queuedMessages[caller]&&delete queuedMessages[caller],peerConns[caller]&&(peerConns[caller].wasAcceptedCB&&peerConns[caller].wasAcceptedCB(!1,caller),delete peerConns[caller])}(caller);break;case"answer":!function(caller,msgData){if(delete acceptancePending[caller],peerConns[caller]){var isInitialConnect=!peerConns[caller].connectionAccepted;isInitialConnect&&(peerConns[caller].connectionAccepted=!0,peerConns[caller].wasAcceptedCB&&peerConns[caller].wasAcceptedCB(!0,caller)),sendQueuedCandidates(caller,function(){},function(errorCode,errorText){peerConns[caller]&&delete peerConns[caller],self.showError(errorCode,errorText)});var sdp,pc=peerConns[caller].pc;try{sdp=sdpRemoteFilter?sdpRemoteFilter(msgData.sdp):msgData.sdp}catch(userError){self.showError(self.errCodes.DEVELOPER_ERR,"sdpRemoteFilter failed case: "+userError)}var sd=new RTCSessionDescription({type:msgData.type,sdp:sdp});if(!sd)throw"Could not create the RTCSessionDescription";logDebug("about to call initiating setRemoteDescription");try{sdpRemoteFilter&&(sd=new RTCSessionDescription({type:sd.type,sdp:sdpRemoteFilter(sd.sdp)})),logDebug("sdp ||  "+JSON.stringify(sd)),pc.setRemoteDescription(sd).then(function(){if(pc.connectDataConnection){logDebug("calling connectDataConnection(5001,5002)"),isInitialConnect&&pc.connectDataConnection(5001,5002);try{var streamName,acks=peerConns[caller].streamsAddedAcks||{};for(streamName in acks)acks.hasOwnProperty(streamName)&&acks[streamName](caller,streamName);peerConns[caller].streamsAddedAcks={}}catch(userError){self.showError(self.errCodes.DEVELOPER_ERR,"streamAdded receipt function failed")}}},function(message){logDebug("processAnswer setRemoteDescription failed: ",message)})}catch(smdException){logDebug("processAnswer setRemoteDescription error: ",smdException)}flushCachedCandidates(caller)}}(caller,msgData);break;case"candidate":!function(caller,msgData){peerConns[caller]&&peerConns[caller].pc?processCandidateBody(caller,msgData):(peerConns[caller]||(queuedMessages[caller]={candidates:[]}),queuedMessages[caller].candidates.push(msgData))}(caller,msgData);break;case"hangup":onRemoteHangup(caller),clearQueuedMessages(caller);break;case"error":self.showError(msgData.errorCode,msgData.errorText);break;default:return void self.showError(self.errCodes.DEVELOPER_ERR,"received unknown message type from server, msgType is "+msgType)}ackAcceptorFn&&ackAcceptorFn(self.ackMessage)}this.updatePresence=function(state,statusText){self.presenceShow=state,self.presenceStatus=statusText,self.webSocketConnected&&sendSignalling(null,"setPresence",{setPresence:{show:self.presenceShow,status:self.presenceStatus}},null)},this.getSessionFields=function(){return sessionFields},this.getSessionField=function(name){return sessionFields[name]?sessionFields[name].fieldValue:undefined},this.getRoomOccupantsAsArray=function(roomName){return lastLoggedInList[roomName]?Object.keys(lastLoggedInList[roomName]):null},this.getRoomOccupantsAsMap=function(roomName){return lastLoggedInList[roomName]},this.isTurnServer=function(ipAddress){return!!self._turnServers[ipAddress]},this.isStunServer=function(ipAddress){return!!self._stunServers[ipAddress]},this.getFreshIceConfig=function(callback){callback||(callback=function(){}),self.webSocket.json.emit("easyrtcCmd",{msgType:"getIceConfig",msgData:{}},function(ackMsg){"iceConfig"===ackMsg.msgType?(processIceConfig(ackMsg.msgData.iceConfig),callback(!0)):(self.showError(ackMsg.msgData.errorCode,ackMsg.msgData.errorText),callback(!1))})},this.joinRoom=function(roomName,roomParameters,successCB,failureCB){if(self.roomJoin[roomName])self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to join room "+roomName+" which you are already in.");else{var newRoomData={roomName:roomName};if(roomParameters){try{JSON.stringify(roomParameters)}catch(error){throw self.showError(self.errCodes.DEVELOPER_ERR,"non-jsonable parameter to easyrtc.joinRoom"),"Developer error, see application error messages"}var parameters={};for(var key in roomParameters)roomParameters.hasOwnProperty(key)&&(parameters[key]=roomParameters[key]);newRoomData.roomParameter=parameters}var roomData,msgData={roomJoin:{}};self.webSocket?(msgData.roomJoin[roomName]=newRoomData,sendSignalling(null,"roomJoin",msgData,function(msgType,msgData){roomData=msgData.roomData,self.roomJoin[roomName]=newRoomData,successCB&&successCB(roomName),processRoomData(roomData)},function(errorCode,errorText){failureCB?failureCB(errorCode,errorText,roomName):self.showError(errorCode,self.format(self.getConstantString("unableToEnterRoom"),roomName,errorText))})):self.roomJoin[roomName]=newRoomData}},this.leaveRoom=function(roomName,successCallback,failureCallback){var roomItem;self.roomJoin[roomName]&&(self.webSocket?(self.setRoomApiField(roomName),(roomItem={})[roomName]={roomName:roomName},sendSignalling(null,"roomLeave",{roomLeave:roomItem},function(msgType,msgData){processRoomData(msgData.roomData),successCallback&&successCallback(roomName)},function(errorCode,errorText){failureCallback&&failureCallback(errorCode,errorText,roomName)})):delete self.roomJoin[roomName])},this.getRoomsJoined=function(){var key,roomsIn={};for(key in self.roomJoin)self.roomJoin.hasOwnProperty(key)&&(roomsIn[key]=!0);return roomsIn},this.getRoomFields=function(roomName){return fields&&fields.rooms&&fields.rooms[roomName]?fields.rooms[roomName]:undefined},this.getApplicationFields=function(){return fields.application},this.getConnectionFields=function(){return fields.connection},this.useThisSocketConnection=function(alreadyAllocatedSocketIo){preallocatedSocketIo=alreadyAllocatedSocketIo},this.connect=function(applicationName,successCallback,errorCallback){io||self.showError(self.errCodes.DEVELOPER_ERR,"Your HTML has not included the socket.io.js library"),preallocatedSocketIo||!self.webSocket?(pc_config={},oldConfig={},queuedMessages={},self.applicationName=applicationName,fields={rooms:{},application:{},connection:{}},logDebug("attempt to connect to WebRTC signalling server with application name="+applicationName),null===errorCallback&&(errorCallback=function(errorCode,errorText){self.showError(errorCode,errorText)}),self.setPeerListener(function(easyrtcid,msgType,msgData,targeting){logDebug("received request to supportHalfIceTrickle"),peerConns[easyrtcid]&&(peerConns[easyrtcid].supportHalfTrickleIce=!0,flushCachedCandidates(easyrtcid),function checkIceGatheringState(otherPeer){logDebug("entered checkIceGatheringState"),peerConns[otherPeer]&&peerConns[otherPeer].pc&&peerConns[otherPeer].pc.iceGatheringState?"complete"===peerConns[otherPeer].pc.iceGatheringState?(self.sendPeerMessage(otherPeer,"iceGatheringDone",{}),logDebug("sent iceGatherDone message to ",otherPeer)):setTimeout(function(){checkIceGatheringState(otherPeer)},500):logDebug("checkIceGatherState: leaving")}(easyrtcid))},"supportHalfTrickleIce"),function(successCallback,errorCallback){var i;if(preallocatedSocketIo)self.webSocket=preallocatedSocketIo;else if(self.webSocket)for(i in self.websocketListeners)self.websocketListeners.hasOwnProperty(i)&&self.webSocket.removeEventListener(self.websocketListeners[i].event,self.websocketListeners[i].handler);else try{if(connectionOptions["force new connection"]=!0,self.webSocket=io.connect(serverPath,connectionOptions),!self.webSocket)throw"io.connect failed"}catch(socketErr){return self.webSocket=0,void errorCallback(self.errCodes.SYSTEM_ERROR,socketErr.toString())}function addSocketListener(event,handler){self.webSocket.on(event,handler),self.websocketListeners.push({event:event,handler:handler})}function handleErrorEvent(){self.myEasyrtcid&&isSocketConnected(self.webSocket)?self.showError(self.errCodes.SIGNAL_ERR,self.getConstantString("miscSignalError")):errorCallback(self.errCodes.CONNECT_ERR,self.getConstantString("noServer"))}function connectHandler(event){self.webSocket||self.showError(self.errCodes.CONNECT_ERR,self.getConstantString("badsocket")),self.webSocketConnected=!0,missedAliveResponses=0,logDebug("saw socket-server onconnect event"),self.webSocketConnected?function(successCallback,errorCallback){var cookies,target,i,easyrtcsid=null;if(self.cookieId&&document.cookie)for(cookies=document.cookie.split(/[; ]/g),target=self.cookieId+"=",i=0;i<cookies.length;i++)0===cookies[i].indexOf(target)&&(easyrtcsid=cookies[i].substring(target.length));var msgData={apiVersion:self.apiVersion,applicationName:self.applicationName,setUserCfg:collectConfigurationInfo()};self.roomJoin||(self.roomJoin={}),self.presenceShow&&(msgData.setPresence={show:self.presenceShow,status:self.presenceStatus}),self.username&&(msgData.username=self.username),self.roomJoin&&!isEmptyObj(self.roomJoin)&&(msgData.roomJoin=self.roomJoin),easyrtcsid&&(msgData.easyrtcsid=easyrtcsid),credential&&(msgData.credential=credential),self.webSocket.json.emit("easyrtcAuth",{msgType:"authenticate",msgData:msgData},function(msg){var room;if("error"===msg.msgType)errorCallback(msg.msgData.errorCode,msg.msgData.errorText),self.roomJoin={};else{if(function(msg){var msgData=msg.msgData;logDebug("entered process token"),msgData.easyrtcid&&(self.myEasyrtcid=msgData.easyrtcid),msgData.field&&(fields.connection=msgData.field),msgData.iceConfig&&processIceConfig(msgData.iceConfig),msgData.stillAliveInterval&&(stillAlivePeriod=msgData.stillAliveInterval)>0&&stillAliveEmitter(),msgData.sessionData&&processSessionData(msgData.sessionData),msgData.roomData&&processRoomData(msgData.roomData),msgData.application.field&&(fields.application=msgData.application.field)}(msg),self._roomApiFields)for(room in self._roomApiFields)self._roomApiFields.hasOwnProperty(room)&&enqueueSendRoomApi(room);successCallback&&successCallback(self.myEasyrtcid)}})}(successCallback,errorCallback):errorCallback(self.errCodes.SIGNAL_ERR,self.getConstantString("icf"))}self.websocketListeners=[],addSocketListener("close",function(event){logDebug("the web socket closed")}),addSocketListener("error",handleErrorEvent),addSocketListener(!1!==connectionOptions.reconnection?"reconnect_failed":"connect_error",handleErrorEvent),isSocketConnected(preallocatedSocketIo)?connectHandler():addSocketListener("connect",connectHandler),addSocketListener("easyrtcMsg",onChannelMsg),addSocketListener("easyrtcCmd",onChannelCmd),addSocketListener("disconnect",function(){self.webSocketConnected=!1,updateConfigurationInfo=function(){},oldConfig={},disconnectBody()})}(successCallback,errorCallback)):self.showError(self.errCodes.DEVELOPER_ERR,"Attempt to connect when already connected to socket server")}}}),function(root,factory){if("function"==typeof define&&define.amd)define("easyrtc_app",["easyrtc"],factory);else if("object"==typeof module&&module.exports)module.exports=factory(require("easyrtc"));else{if("object"!=typeof window.easyrtc||!window.easyrtc)throw new Error("easyrtc_app requires easyrtc");root.easyrtc=factory(window.easyrtc)}}(this,function(easyrtc,undefined){"use strict";var autoAddCloseButtons=!0;return easyrtc.dontAddCloseButtons=function(){autoAddCloseButtons=!1},easyrtc.easyApp=function(applicationName,monitorVideoId,videoIds,onReady,onFailure){var gotMediaCallback=null,gotConnectionCallback=null;function nextInitializationStep(){gotConnectionCallback&&gotConnectionCallback(!0,""),onReady(easyrtc.myEasyrtcid)}function postGetUserMedia(){gotMediaCallback&&gotMediaCallback(!0,null),null!==monitorVideoId&&easyrtc.setVideoObjectSrc(document.getElementById(monitorVideoId),easyrtc.getLocalStream()),easyrtc.connect(applicationName,nextInitializationStep,function(errorCode,errorText){gotConnectionCallback?gotConnectionCallback(!1,errorText):onFailure?onFailure(easyrtc.errCodes.CONNECT_ERR,errorText):easyrtc.showError(easyrtc.errCodes.CONNECT_ERR,errorText)})}!function(monitorVideoId,videoIds){var addControls,parentDiv,closeButton,i,videoIdsP=videoIds||[],numPEOPLE=videoIds.length,videoIdToCallerMap={},onCall=null,onHangup=null;function getCallerOfVideo(videoObject){return videoIdToCallerMap[videoObject.id]}function setCallerOfVideo(videoObject,callerEasyrtcId){videoIdToCallerMap[videoObject.id]=callerEasyrtcId}function videoIsFree(obj){var caller=getCallerOfVideo(obj);return""===caller||null===caller||caller===undefined}function getIthVideo(i){return videoIdsP[i]?document.getElementById(videoIdsP[i]):null}function showVideo(video,stream){easyrtc.setVideoObjectSrc(video,stream),video.style.visibility&&(video.style.visibility="hidden")}function hideVideo(video){easyrtc.setVideoObjectSrc(video,""),video.style.visibility="hidden"}if(!function(monitorVideoId,videoIds){var i;if(monitorVideoId&&!document.getElementById(monitorVideoId))return easyrtc.showError(easyrtc.errCodes.DEVELOPER_ERR,"The monitor video id passed to easyApp was bad, saw "+monitorVideoId),!1;for(i in videoIds)if(videoIds.hasOwnProperty(i)){var name=videoIds[i];if(!document.getElementById(name))return easyrtc.showError(easyrtc.errCodes.DEVELOPER_ERR,"The caller video id '"+name+"' passed to easyApp was bad."),!1}return!0}(monitorVideoId,videoIdsP))throw"bad video element id";if(monitorVideoId&&(document.getElementById(monitorVideoId).muted="muted"),easyrtc.addEventListener("roomOccupants",function(eventName,eventData){var i;for(i=0;i<numPEOPLE;i++){var video=getIthVideo(i);videoIsFree(video)||easyrtc.isPeerInAnyRoom(getCallerOfVideo(video))||(onHangup&&onHangup(getCallerOfVideo(video),i),setCallerOfVideo(video,null))}}),easyrtc.setOnCall=function(cb){onCall=cb},easyrtc.setOnHangup=function(cb){onHangup=cb},easyrtc.getIthCaller=function(i){return i<0||i>=videoIdsP.length?null:getCallerOfVideo(getIthVideo(i))},easyrtc.getSlotOfCaller=function(easyrtcid){var i;for(i=0;i<numPEOPLE;i++)if(easyrtc.getIthCaller(i)===easyrtcid)return i;return-1},easyrtc.setOnStreamClosed(function(caller){var i;for(i=0;i<numPEOPLE;i++){var video=getIthVideo(i);getCallerOfVideo(video)===caller&&(hideVideo(video),setCallerOfVideo(video,""),onHangup&&onHangup(caller,i))}}),easyrtc.setAcceptChecker(function(caller,helper){var i;for(i=0;i<numPEOPLE;i++)if(videoIsFree(getIthVideo(i)))return void helper(!0);helper(!1)}),easyrtc.setStreamAcceptor(function(caller,stream){var i,video;for(easyrtc.debugPrinter&&easyrtc.debugPrinter("stream acceptor called"),i=0;i<numPEOPLE;i++)if(getCallerOfVideo(video=getIthVideo(i))===caller)return showVideo(video,stream),void(onCall&&onCall(caller,i));for(i=0;i<numPEOPLE;i++)if(videoIsFree(video=getIthVideo(i)))return setCallerOfVideo(video,caller),onCall&&onCall(caller,i),void showVideo(video,stream);(video=getIthVideo(0))&&(easyrtc.hangup(getCallerOfVideo(video)),showVideo(video,stream),onCall&&onCall(caller,0)),setCallerOfVideo(video,caller)}),autoAddCloseButtons)for(addControls=function(video){parentDiv=video.parentNode,setCallerOfVideo(video,""),(closeButton=document.createElement("div")).className="easyrtc_closeButton",closeButton.onclick=function(){getCallerOfVideo(video)&&(easyrtc.hangup(getCallerOfVideo(video)),hideVideo(video),setCallerOfVideo(video,""))},parentDiv.appendChild(closeButton)},i=0;i<numPEOPLE;i++)addControls(getIthVideo(i));var monitorVideo=null;if(easyrtc.videoEnabled&&null!==monitorVideoId){if(!(monitorVideo=document.getElementById(monitorVideoId)))return void console.error("Programmer error: no object called "+monitorVideoId);monitorVideo.muted="muted",monitorVideo.defaultMuted=!0}}(monitorVideoId,videoIds),easyrtc.setGotMedia=function(gotMediaCB){gotMediaCallback=gotMediaCB},easyrtc.setPeerClosedListener(function(easyrtcid){setTimeout(function(){easyrtc.getSlotOfCaller(easyrtcid)>=0&&easyrtc.isPeerInAnyRoom(easyrtcid)&&easyrtc.call(easyrtcid,function(){},function(){},function(){})},1e3)}),easyrtc.setGotConnection=function(gotConnectionCB){gotConnectionCallback=gotConnectionCB},easyrtc.getLocalStream(null)?postGetUserMedia():easyrtc.initMediaSource(postGetUserMedia,function(errorCode,errorText){gotMediaCallback?gotMediaCallback(!1,errorText):onFailure?onFailure(easyrtc.errCodes.MEDIA_ERR,errorText):easyrtc.showError(easyrtc.errCodes.MEDIA_ERR,errorText)},null)},easyrtc});