import e from"../utils/css";import t from"./saveDialogue.html";import n from"../controllers/ControllerFactory";import o from"../controllers/Controller";import i from"../controllers/BooleanController";import r from"../controllers/FunctionController";import s from"../controllers/NumberControllerBox";import l from"../controllers/NumberControllerSlider";import a from"../controllers/ColorController";import d from"../utils/requestAnimationFrame";import c from"../dom/CenteredDiv";import u from"../dom/dom";import _ from"../utils/common";import f from"./style.scss";e.inject(f);var m="dg";var h=72;var p=20;var v="Default";var b=function(){try{return!!window.localStorage}catch(e){return false}}();var C;var g=true;var E;var S=false;var L=[];var w=function e(t){var n=this;var o=t||{};this.domElement=document.createElement("div");this.__ul=document.createElement("ul");this.domElement.appendChild(this.__ul);u.addClass(this.domElement,m);this.__folders={};this.__controllers=[];this.__rememberedObjects=[];this.__rememberedObjectIndecesToControllers=[];this.__listening=[];o=_.defaults(o,{closeOnTop:false,autoPlace:true,width:e.DEFAULT_WIDTH});o=_.defaults(o,{resizable:o.autoPlace,hideable:o.autoPlace});if(!_.isUndefined(o.load)){if(o.preset){o.load.preset=o.preset}}else{o.load={preset:v}}if(_.isUndefined(o.parent)&&o.hideable){L.push(this)}o.resizable=_.isUndefined(o.parent)&&o.resizable;if(o.autoPlace&&_.isUndefined(o.scrollable)){o.scrollable=true}var i=b&&localStorage.getItem(R(this,"isLocal"))==="true";var r;var s;Object.defineProperties(this,{parent:{get:function e(){return o.parent}},scrollable:{get:function e(){return o.scrollable}},autoPlace:{get:function e(){return o.autoPlace}},closeOnTop:{get:function e(){return o.closeOnTop}},preset:{get:function e(){if(n.parent){return n.getRoot().preset}return o.load.preset},set:function e(t){if(n.parent){n.getRoot().preset=t}else{o.load.preset=t}j(this);n.revert()}},width:{get:function e(){return o.width},set:function e(t){o.width=t;z(n,t)}},name:{get:function e(){return o.name},set:function e(t){o.name=t;if(s){s.innerHTML=o.name}}},closed:{get:function e(){return o.closed},set:function t(i){o.closed=i;if(o.closed){u.addClass(n.__ul,e.CLASS_CLOSED)}else{u.removeClass(n.__ul,e.CLASS_CLOSED)}this.onResize();if(n.__closeButton){n.__closeButton.innerHTML=i?e.TEXT_OPEN:e.TEXT_CLOSED}}},load:{get:function e(){return o.load}},useLocalStorage:{get:function e(){return i},set:function e(t){if(b){i=t;if(t){u.bind(window,"unload",r)}else{u.unbind(window,"unload",r)}localStorage.setItem(R(n,"isLocal"),t)}}}});if(_.isUndefined(o.parent)){this.closed=o.closed||false;u.addClass(this.domElement,e.CLASS_MAIN);u.makeSelectable(this.domElement,false);if(b){if(i){n.useLocalStorage=true;var l=localStorage.getItem(R(this,"gui"));if(l){o.load=JSON.parse(l)}}}this.__closeButton=document.createElement("div");this.__closeButton.innerHTML=e.TEXT_CLOSED;u.addClass(this.__closeButton,e.CLASS_CLOSE_BUTTON);if(o.closeOnTop){u.addClass(this.__closeButton,e.CLASS_CLOSE_TOP);this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])}else{u.addClass(this.__closeButton,e.CLASS_CLOSE_BOTTOM);this.domElement.appendChild(this.__closeButton)}u.bind(this.__closeButton,"click",function(){n.closed=!n.closed})}else{if(o.closed===undefined){o.closed=true}var a=document.createTextNode(o.name);u.addClass(a,"controller-name");s=y(n,a);var d=function e(t){t.preventDefault();n.closed=!n.closed;return false};u.addClass(this.__ul,e.CLASS_CLOSED);u.addClass(s,"title");u.bind(s,"click",d);if(!o.closed){this.closed=false}}if(o.autoPlace){if(_.isUndefined(o.parent)){if(g){E=document.createElement("div");u.addClass(E,m);u.addClass(E,e.CLASS_AUTO_PLACE_CONTAINER);document.body.appendChild(E);g=false}E.appendChild(this.domElement);u.addClass(this.domElement,e.CLASS_AUTO_PLACE)}if(!this.parent){z(n,o.width)}}this.__resizeHandler=function(){n.onResizeDebounced()};u.bind(window,"resize",this.__resizeHandler);u.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler);u.bind(this.__ul,"transitionend",this.__resizeHandler);u.bind(this.__ul,"oTransitionEnd",this.__resizeHandler);this.onResize();if(o.resizable){k(this)}r=function e(){if(b&&localStorage.getItem(R(n,"isLocal"))==="true"){localStorage.setItem(R(n,"gui"),JSON.stringify(n.getSaveObject()))}};this.saveToLocalStorageIfPossible=r;function c(){var e=n.getRoot();e.width+=1;_.defer(function(){e.width-=1})}if(!o.parent){c()}};w.toggleHide=function(){S=!S;_.each(L,function(e){e.domElement.style.display=S?"none":""})};w.CLASS_AUTO_PLACE="a";w.CLASS_AUTO_PLACE_CONTAINER="ac";w.CLASS_MAIN="main";w.CLASS_CONTROLLER_ROW="cr";w.CLASS_TOO_TALL="taller-than-window";w.CLASS_CLOSED="closed";w.CLASS_CLOSE_BUTTON="close-button";w.CLASS_CLOSE_TOP="close-top";w.CLASS_CLOSE_BOTTOM="close-bottom";w.CLASS_DRAG="drag";w.DEFAULT_WIDTH=245;w.TEXT_CLOSED="Close Controls";w.TEXT_OPEN="Open Controls";w._keydownHandler=function(e){if(document.activeElement.type!=="text"&&(e.which===h||e.keyCode===h)){w.toggleHide()}};u.bind(window,"keydown",w._keydownHandler,false);_.extend(w.prototype,{add:function e(t,n){return H(this,t,n,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function e(t,n){return H(this,t,n,{color:true})},remove:function e(t){this.__ul.removeChild(t.__li);this.__controllers.splice(this.__controllers.indexOf(t),1);var n=this;_.defer(function(){n.onResize()})},destroy:function e(){if(this.parent){throw new Error("Only the root GUI should be removed with .destroy(). "+"For subfolders, use gui.removeFolder(folder) instead.")}if(this.autoPlace){E.removeChild(this.domElement)}var t=this;_.each(this.__folders,function(e){t.removeFolder(e)});u.unbind(window,"keydown",w._keydownHandler,false);O(this)},addFolder:function e(t){if(this.__folders[t]!==undefined){throw new Error("You already have a folder in this GUI by the"+' name "'+t+'"')}var n={name:t,parent:this};n.autoPlace=this.autoPlace;if(this.load&&this.load.folders&&this.load.folders[t]){n.closed=this.load.folders[t].closed;n.load=this.load.folders[t]}var o=new w(n);this.__folders[t]=o;var i=y(this,o.domElement);u.addClass(i,"folder");return o},removeFolder:function e(t){this.__ul.removeChild(t.domElement.parentElement);delete this.__folders[t.name];if(this.load&&this.load.folders&&this.load.folders[t.name]){delete this.load.folders[t.name]}O(t);var n=this;_.each(t.__folders,function(e){t.removeFolder(e)});_.defer(function(){n.onResize()})},open:function e(){this.closed=false},close:function e(){this.closed=true},onResize:function e(){var t=this.getRoot();if(t.scrollable){var n=u.getOffset(t.__ul).top;var o=0;_.each(t.__ul.childNodes,function(e){if(!(t.autoPlace&&e===t.__save_row)){o+=u.getHeight(e)}});if(window.innerHeight-n-p<o){u.addClass(t.domElement,w.CLASS_TOO_TALL);t.__ul.style.height=window.innerHeight-n-p+"px"}else{u.removeClass(t.domElement,w.CLASS_TOO_TALL);t.__ul.style.height="auto"}}if(t.__resize_handle){_.defer(function(){t.__resize_handle.style.height=t.__ul.offsetHeight+"px"})}if(t.__closeButton){t.__closeButton.style.width=t.width+"px"}},onResizeDebounced:_.debounce(function(){this.onResize()},50),remember:function e(){if(_.isUndefined(C)){C=new c;C.domElement.innerHTML=t}if(this.parent){throw new Error("You can only call remember on a top level GUI.")}var n=this;_.each(Array.prototype.slice.call(arguments),function(e){if(n.__rememberedObjects.length===0){D(n)}if(n.__rememberedObjects.indexOf(e)===-1){n.__rememberedObjects.push(e)}});if(this.autoPlace){z(this,this.width)}},getRoot:function e(){var t=this;while(t.parent){t=t.parent}return t},getSaveObject:function e(){var t=this.load;t.closed=this.closed;if(this.__rememberedObjects.length>0){t.preset=this.preset;if(!t.remembered){t.remembered={}}t.remembered[this.preset]=P(this)}t.folders={};_.each(this.__folders,function(e,n){t.folders[n]=e.getSaveObject()});return t},save:function e(){if(!this.load.remembered){this.load.remembered={}}this.load.remembered[this.preset]=P(this);T(this,false);this.saveToLocalStorageIfPossible()},saveAs:function e(t){if(!this.load.remembered){this.load.remembered={};this.load.remembered[v]=P(this,true)}this.load.remembered[t]=P(this);this.preset=t;B(this,t,true);this.saveToLocalStorageIfPossible()},revert:function e(t){_.each(this.__controllers,function(e){if(!this.getRoot().load.remembered){e.setValue(e.initialValue)}else{x(t||this.getRoot(),e)}if(e.__onFinishChange){e.__onFinishChange.call(e,e.getValue())}},this);_.each(this.__folders,function(e){e.revert(e)});if(!t){T(this.getRoot(),false)}},listen:function e(t){var n=this.__listening.length===0;this.__listening.push(t);if(n){N(this.__listening)}},updateDisplay:function e(){_.each(this.__controllers,function(e){e.updateDisplay()});_.each(this.__folders,function(e){e.updateDisplay()})}});function y(e,t,n){var o=document.createElement("li");if(t){o.appendChild(t)}if(n){e.__ul.insertBefore(o,n)}else{e.__ul.appendChild(o)}e.onResize();return o}function O(e){u.unbind(window,"resize",e.__resizeHandler);if(e.saveToLocalStorageIfPossible){u.unbind(window,"unload",e.saveToLocalStorageIfPossible)}}function T(e,t){var n=e.__preset_select[e.__preset_select.selectedIndex];if(t){n.innerHTML=n.value+"*"}else{n.innerHTML=n.value}}function A(e,t,n){n.__li=t;n.__gui=e;_.extend(n,{options:function t(o){if(arguments.length>1){var i=n.__li.nextElementSibling;n.remove();return H(e,n.object,n.property,{before:i,factoryArgs:[_.toArray(arguments)]})}if(_.isArray(o)||_.isObject(o)){var r=n.__li.nextElementSibling;n.remove();return H(e,n.object,n.property,{before:r,factoryArgs:[o]})}},name:function e(t){n.__li.firstElementChild.firstElementChild.innerHTML=t;return n},listen:function e(){n.__gui.listen(n);return n},remove:function e(){n.__gui.remove(n);return n}});if(n instanceof l){var o=new s(n.object,n.property,{min:n.__min,max:n.__max,step:n.__step});_.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(e){var t=n[e];var i=o[e];n[e]=o[e]=function(){var e=Array.prototype.slice.call(arguments);i.apply(o,e);return t.apply(n,e)}});u.addClass(t,"has-slider");n.domElement.insertBefore(o.domElement,n.domElement.firstElementChild)}else if(n instanceof s){var d=function t(o){if(_.isNumber(n.__min)&&_.isNumber(n.__max)){var i=n.__li.firstElementChild.firstElementChild.innerHTML;var r=n.__gui.__listening.indexOf(n)>-1;n.remove();var s=H(e,n.object,n.property,{before:n.__li.nextElementSibling,factoryArgs:[n.__min,n.__max,n.__step]});s.name(i);if(r)s.listen();return s}return o};n.min=_.compose(d,n.min);n.max=_.compose(d,n.max)}else if(n instanceof i){u.bind(t,"click",function(){u.fakeEvent(n.__checkbox,"click")});u.bind(n.__checkbox,"click",function(e){e.stopPropagation()})}else if(n instanceof r){u.bind(t,"click",function(){u.fakeEvent(n.__button,"click")});u.bind(t,"mouseover",function(){u.addClass(n.__button,"hover")});u.bind(t,"mouseout",function(){u.removeClass(n.__button,"hover")})}else if(n instanceof a){u.addClass(t,"color");n.updateDisplay=_.compose(function(e){t.style.borderLeftColor=n.__color.toString();return e},n.updateDisplay);n.updateDisplay()}n.setValue=_.compose(function(t){if(e.getRoot().__preset_select&&n.isModified()){T(e.getRoot(),true)}return t},n.setValue)}function x(e,t){var n=e.getRoot();var o=n.__rememberedObjects.indexOf(t.object);if(o!==-1){var i=n.__rememberedObjectIndecesToControllers[o];if(i===undefined){i={};n.__rememberedObjectIndecesToControllers[o]=i}i[t.property]=t;if(n.load&&n.load.remembered){var r=n.load.remembered;var s;if(r[e.preset]){s=r[e.preset]}else if(r[v]){s=r[v]}else{return}if(s[o]&&s[o][t.property]!==undefined){var l=s[o][t.property];t.initialValue=l;t.setValue(l)}}}}function H(e,t,i,r){if(t[i]===undefined){throw new Error('Object "'+t+'" has no property "'+i+'"')}var s;if(r.color){s=new a(t,i)}else{var l=[t,i].concat(r.factoryArgs);s=n.apply(e,l)}if(r.before instanceof o){r.before=r.before.__li}x(e,s);u.addClass(s.domElement,"c");var d=document.createElement("span");u.addClass(d,"property-name");d.innerHTML=s.property;var c=document.createElement("div");c.appendChild(d);c.appendChild(s.domElement);var _=y(e,c,r.before);u.addClass(_,w.CLASS_CONTROLLER_ROW);if(s instanceof a){u.addClass(_,"color")}else{u.addClass(_,typeof s.getValue())}A(e,_,s);e.__controllers.push(s);return s}function R(e,t){return document.location.href+"."+t}function B(e,t,n){var o=document.createElement("option");o.innerHTML=t;o.value=t;e.__preset_select.appendChild(o);if(n){e.__preset_select.selectedIndex=e.__preset_select.length-1}}function I(e,t){t.style.display=e.useLocalStorage?"block":"none"}function D(e){var t=e.__save_row=document.createElement("li");u.addClass(e.domElement,"has-save");e.__ul.insertBefore(t,e.__ul.firstChild);u.addClass(t,"save-row");var n=document.createElement("span");n.innerHTML="&nbsp;";u.addClass(n,"button gears");var o=document.createElement("span");o.innerHTML="Save";u.addClass(o,"button");u.addClass(o,"save");var i=document.createElement("span");i.innerHTML="New";u.addClass(i,"button");u.addClass(i,"save-as");var r=document.createElement("span");r.innerHTML="Revert";u.addClass(r,"button");u.addClass(r,"revert");var s=e.__preset_select=document.createElement("select");if(e.load&&e.load.remembered){_.each(e.load.remembered,function(t,n){B(e,n,n===e.preset)})}else{B(e,v,false)}u.bind(s,"change",function(){for(var t=0;t<e.__preset_select.length;t++){e.__preset_select[t].innerHTML=e.__preset_select[t].value}e.preset=this.value});t.appendChild(s);t.appendChild(n);t.appendChild(o);t.appendChild(i);t.appendChild(r);if(b){var l=document.getElementById("dg-local-explain");var a=document.getElementById("dg-local-storage");var d=document.getElementById("dg-save-locally");d.style.display="block";if(localStorage.getItem(R(e,"isLocal"))==="true"){a.setAttribute("checked","checked")}I(e,l);u.bind(a,"change",function(){e.useLocalStorage=!e.useLocalStorage;I(e,l)})}var c=document.getElementById("dg-new-constructor");u.bind(c,"keydown",function(e){if(e.metaKey&&(e.which===67||e.keyCode===67)){C.hide()}});u.bind(n,"click",function(){c.innerHTML=JSON.stringify(e.getSaveObject(),undefined,2);C.show();c.focus();c.select()});u.bind(o,"click",function(){e.save()});u.bind(i,"click",function(){var t=prompt("Enter a new preset name.");if(t){e.saveAs(t)}});u.bind(r,"click",function(){e.revert()})}function k(e){var t;e.__resize_handle=document.createElement("div");_.extend(e.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});function n(n){n.preventDefault();e.width+=t-n.clientX;e.onResize();t=n.clientX;return false}function o(){u.removeClass(e.__closeButton,w.CLASS_DRAG);u.unbind(window,"mousemove",n);u.unbind(window,"mouseup",o)}function i(i){i.preventDefault();t=i.clientX;u.addClass(e.__closeButton,w.CLASS_DRAG);u.bind(window,"mousemove",n);u.bind(window,"mouseup",o);return false}u.bind(e.__resize_handle,"mousedown",i);u.bind(e.__closeButton,"mousedown",i);e.domElement.insertBefore(e.__resize_handle,e.domElement.firstElementChild)}function z(e,t){e.domElement.style.width=t+"px";if(e.__save_row&&e.autoPlace){e.__save_row.style.width=t+"px"}if(e.__closeButton){e.__closeButton.style.width=t+"px"}}function P(e,t){var n={};_.each(e.__rememberedObjects,function(o,i){var r={};var s=e.__rememberedObjectIndecesToControllers[i];_.each(s,function(e,n){r[n]=t?e.initialValue:e.getValue()});n[i]=r});return n}function j(e){for(var t=0;t<e.__preset_select.length;t++){if(e.__preset_select[t].value===e.preset){e.__preset_select.selectedIndex=t}}}function N(e){if(e.length!==0){d.call(window,function(){N(e)})}_.each(e,function(e){e.updateDisplay()})}export default w;