(function(e,t){if(typeof define==="function"&&define.amd){define("easyrtc_lang",t)}else if(typeof module==="object"&&module.exports){module.exports=t()}else{e.easyrtc_lang=t()}})(this,function(e){"use strict";return{unableToEnterRoom:"Unable to enter room {0} because {1}",resolutionWarning:"Requested video size of {0}x{1} but got size of {2}x{3}",badUserName:"Illegal username {0}",localMediaError:"Error getting local media stream: {0}",miscSignalError:"Miscellaneous error from signalling server. It may be ignorable.",noServer:"Unable to reach the EasyRTC signalling server.",badsocket:"Socket.io connect event fired with bad websocket.",icf:"Internal communications failure",statsNotSupported:"call statistics not supported by this browser, try Chrome.",noWebrtcSupport:"Your browser doesn't appear to support WebRTC.",gumFailed:"Failed to get access to local media. Error code was {0}.",requireAudioOrVideo:"At least one of audio and video must be provided"}});(function(e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e()}else if(typeof define==="function"&&define.amd){define("webrtc-adapter",[],e)}else{var t;if(typeof window!=="undefined"){t=window}else if(typeof global!=="undefined"){t=global}else if(typeof self!=="undefined"){t=self}else{t=this}t.adapter=e()}})(function(){var e,t,r;return function(){function e(t,r,n){function i(o,s){if(!r[o]){if(!t[o]){var c="function"==typeof require&&require;if(!s&&c)return c(o,!0);if(a)return a(o,!0);var d=new Error("Cannot find module '"+o+"'");throw d.code="MODULE_NOT_FOUND",d}var f=r[o]={exports:{}};t[o][0].call(f.exports,function(e){var r=t[o][1][e];return i(r||e)},f,f.exports,e,t,r,n)}return r[o].exports}for(var a="function"==typeof require&&require,o=0;o<n.length;o++){i(n[o])}return i}return e}()({1:[function(e,t,r){var n=e("./adapter_factory.js");var i=(0,n.adapterFactory)({window:window});t.exports=i},{"./adapter_factory.js":2}],2:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:true});r.adapterFactory=h;var n=e("./utils");var i=v(n);var a=e("./chrome/chrome_shim");var o=v(a);var s=e("./edge/edge_shim");var c=v(s);var d=e("./firefox/firefox_shim");var f=v(d);var u=e("./safari/safari_shim");var l=v(u);var p=e("./common_shim");var m=v(p);function v(e){if(e&&e.__esModule){return e}else{var t={};if(e!=null){for(var r in e){if(Object.prototype.hasOwnProperty.call(e,r))t[r]=e[r]}}t.default=e;return t}}function h(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},t=e.window;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{shimChrome:true,shimFirefox:true,shimEdge:true,shimSafari:true};var n=i.log;var a=i.detectBrowser(t);var s={browserDetails:a,commonShim:m,extractVersion:i.extractVersion,disableLog:i.disableLog,disableWarnings:i.disableWarnings};switch(a.browser){case"chrome":if(!o||!o.shimPeerConnection||!r.shimChrome){n("Chrome shim is not included in this adapter release.");return s}n("adapter.js shimming chrome.");s.browserShim=o;o.shimGetUserMedia(t);o.shimMediaStream(t);o.shimPeerConnection(t);o.shimOnTrack(t);o.shimAddTrackRemoveTrack(t);o.shimGetSendersWithDtmf(t);o.shimGetStats(t);o.shimSenderReceiverGetStats(t);o.fixNegotiationNeeded(t);m.shimRTCIceCandidate(t);m.shimConnectionState(t);m.shimMaxMessageSize(t);m.shimSendThrowTypeError(t);m.removeAllowExtmapMixed(t);break;case"firefox":if(!f||!f.shimPeerConnection||!r.shimFirefox){n("Firefox shim is not included in this adapter release.");return s}n("adapter.js shimming firefox.");s.browserShim=f;f.shimGetUserMedia(t);f.shimPeerConnection(t);f.shimOnTrack(t);f.shimRemoveStream(t);f.shimSenderGetStats(t);f.shimReceiverGetStats(t);f.shimRTCDataChannel(t);f.shimAddTransceiver(t);f.shimCreateOffer(t);f.shimCreateAnswer(t);m.shimRTCIceCandidate(t);m.shimConnectionState(t);m.shimMaxMessageSize(t);m.shimSendThrowTypeError(t);break;case"edge":if(!c||!c.shimPeerConnection||!r.shimEdge){n("MS edge shim is not included in this adapter release.");return s}n("adapter.js shimming edge.");s.browserShim=c;c.shimGetUserMedia(t);c.shimGetDisplayMedia(t);c.shimPeerConnection(t);c.shimReplaceTrack(t);m.shimMaxMessageSize(t);m.shimSendThrowTypeError(t);break;case"safari":if(!l||!r.shimSafari){n("Safari shim is not included in this adapter release.");return s}n("adapter.js shimming safari.");s.browserShim=l;l.shimRTCIceServerUrls(t);l.shimCreateOfferLegacy(t);l.shimCallbacksAPI(t);l.shimLocalStreamsAPI(t);l.shimRemoteStreamsAPI(t);l.shimTrackEventTransceiver(t);l.shimGetUserMedia(t);m.shimRTCIceCandidate(t);m.shimMaxMessageSize(t);m.shimSendThrowTypeError(t);m.removeAllowExtmapMixed(t);break;default:n("Unsupported browser!");break}return s}},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});r.shimGetDisplayMedia=r.shimGetUserMedia=undefined;var n=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol==="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:true,get:function e(){return i.shimGetUserMedia}});var a=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:true,get:function e(){return a.shimGetDisplayMedia}});r.shimMediaStream=f;r.shimOnTrack=u;r.shimGetSendersWithDtmf=l;r.shimGetStats=p;r.shimSenderReceiverGetStats=m;r.shimAddTrackRemoveTrackWithNative=v;r.shimAddTrackRemoveTrack=h;r.shimPeerConnection=g;r.fixNegotiationNeeded=y;var o=e("../utils.js");var s=c(o);function c(e){if(e&&e.__esModule){return e}else{var t={};if(e!=null){for(var r in e){if(Object.prototype.hasOwnProperty.call(e,r))t[r]=e[r]}}t.default=e;return t}}function d(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}function f(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function u(e){if((typeof e==="undefined"?"undefined":n(e))==="object"&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function e(){return this._ontrack},set:function e(t){if(this._ontrack){this.removeEventListener("track",this._ontrack)}this.addEventListener("track",this._ontrack=t)},enumerable:true,configurable:true});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function r(){var n=this;if(!this._ontrackpoly){this._ontrackpoly=function(t){t.stream.addEventListener("addtrack",function(r){var i=void 0;if(e.RTCPeerConnection.prototype.getReceivers){i=n.getReceivers().find(function(e){return e.track&&e.track.id===r.track.id})}else{i={track:r.track}}var a=new Event("track");a.track=r.track;a.receiver=i;a.transceiver={receiver:i};a.streams=[t.stream];n.dispatchEvent(a)});t.stream.getTracks().forEach(function(r){var i=void 0;if(e.RTCPeerConnection.prototype.getReceivers){i=n.getReceivers().find(function(e){return e.track&&e.track.id===r.id})}else{i={track:r}}var a=new Event("track");a.track=r;a.receiver=i;a.transceiver={receiver:i};a.streams=[t.stream];n.dispatchEvent(a)})};this.addEventListener("addstream",this._ontrackpoly)}return t.apply(this,arguments)}}else{s.wrapPeerConnectionEvent(e,"track",function(e){if(!e.transceiver){Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}})}return e})}}function l(e){if((typeof e==="undefined"?"undefined":n(e))==="object"&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function e(t,r){return{track:r,get dtmf(){if(this._dtmf===undefined){if(r.kind==="audio"){this._dtmf=t.createDTMFSender(r)}else{this._dtmf=null}}return this._dtmf},_pc:t}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function e(){this._senders=this._senders||[];return this._senders.slice()};var r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function e(n,i){var a=r.apply(this,arguments);if(!a){a=t(this,n);this._senders.push(a)}return a};var i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function e(t){i.apply(this,arguments);var r=this._senders.indexOf(t);if(r!==-1){this._senders.splice(r,1)}}}var a=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function e(r){var n=this;this._senders=this._senders||[];a.apply(this,[r]);r.getTracks().forEach(function(e){n._senders.push(t(n,e))})};var o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function e(t){var r=this;this._senders=this._senders||[];o.apply(this,[t]);t.getTracks().forEach(function(e){var t=r._senders.find(function(t){return t.track===e});if(t){r._senders.splice(r._senders.indexOf(t),1)}})}}else if((typeof e==="undefined"?"undefined":n(e))==="object"&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var s=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function e(){var t=this;var r=s.apply(this,[]);r.forEach(function(e){return e._pc=t});return r};Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function e(){if(this._dtmf===undefined){if(this.track.kind==="audio"){this._dtmf=this._pc.createDTMFSender(this.track)}else{this._dtmf=null}}return this._dtmf}})}}function p(e){if(!e.RTCPeerConnection){return}var t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function e(){var r=this;var n=Array.prototype.slice.call(arguments),i=n[0],a=n[1],o=n[2];if(arguments.length>0&&typeof i==="function"){return t.apply(this,arguments)}if(t.length===0&&(arguments.length===0||typeof i!=="function")){return t.apply(this,[])}var s=function e(t){var r={};var n=t.result();n.forEach(function(e){var t={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(r){t[r]=e.stat(r)});r[t.id]=t});return r};var c=function e(t){return new Map(Object.keys(t).map(function(e){return[e,t[e]]}))};if(arguments.length>=2){var d=function e(t){a(c(s(t)))};return t.apply(this,[d,i])}return new Promise(function(e,n){t.apply(r,[function(t){e(c(s(t)))},n])}).then(a,o)}}function m(e){if(!((typeof e==="undefined"?"undefined":n(e))==="object"&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver)){return}if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;if(t){e.RTCPeerConnection.prototype.getSenders=function e(){var r=this;var n=t.apply(this,[]);n.forEach(function(e){return e._pc=r});return n}}var r=e.RTCPeerConnection.prototype.addTrack;if(r){e.RTCPeerConnection.prototype.addTrack=function e(){var t=r.apply(this,arguments);t._pc=this;return t}}e.RTCRtpSender.prototype.getStats=function e(){var t=this;return this._pc.getStats().then(function(e){return s.filterStats(e,t.track,true)})}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var i=e.RTCPeerConnection.prototype.getReceivers;if(i){e.RTCPeerConnection.prototype.getReceivers=function e(){var t=this;var r=i.apply(this,[]);r.forEach(function(e){return e._pc=t});return r}}s.wrapPeerConnectionEvent(e,"track",function(e){e.receiver._pc=e.srcElement;return e});e.RTCRtpReceiver.prototype.getStats=function e(){var t=this;return this._pc.getStats().then(function(e){return s.filterStats(e,t.track,false)})}}if(!("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype)){return}var a=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function t(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){var r=arguments[0];var n=void 0;var i=void 0;var o=void 0;this.getSenders().forEach(function(e){if(e.track===r){if(n){o=true}else{n=e}}});this.getReceivers().forEach(function(e){if(e.track===r){if(i){o=true}else{i=e}}return e.track===r});if(o||n&&i){return Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError"))}else if(n){return n.getStats()}else if(i){return i.getStats()}return Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return a.apply(this,arguments)}}function v(e){e.RTCPeerConnection.prototype.getLocalStreams=function e(){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};return Object.keys(this._shimmedLocalStreams).map(function(e){return t._shimmedLocalStreams[e][0]})};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function e(r,n){if(!n){return t.apply(this,arguments)}this._shimmedLocalStreams=this._shimmedLocalStreams||{};var i=t.apply(this,arguments);if(!this._shimmedLocalStreams[n.id]){this._shimmedLocalStreams[n.id]=[n,i]}else if(this._shimmedLocalStreams[n.id].indexOf(i)===-1){this._shimmedLocalStreams[n.id].push(i)}return i};var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function e(t){var n=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};t.getTracks().forEach(function(e){var t=n.getSenders().find(function(t){return t.track===e});if(t){throw new DOMException("Track already exists.","InvalidAccessError")}});var i=this.getSenders();r.apply(this,arguments);var a=this.getSenders().filter(function(e){return i.indexOf(e)===-1});this._shimmedLocalStreams[t.id]=[t].concat(a)};var n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function e(t){this._shimmedLocalStreams=this._shimmedLocalStreams||{};delete this._shimmedLocalStreams[t.id];return n.apply(this,arguments)};var i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function e(t){var r=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};if(t){Object.keys(this._shimmedLocalStreams).forEach(function(e){var n=r._shimmedLocalStreams[e].indexOf(t);if(n!==-1){r._shimmedLocalStreams[e].splice(n,1)}if(r._shimmedLocalStreams[e].length===1){delete r._shimmedLocalStreams[e]}})}return i.apply(this,arguments)}}function h(e){if(!e.RTCPeerConnection){return}var t=s.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65){return v(e)}var r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function e(){var t=this;var n=r.apply(this);this._reverseStreams=this._reverseStreams||{};return n.map(function(e){return t._reverseStreams[e.id]})};var n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function t(r){var i=this;this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};r.getTracks().forEach(function(e){var t=i.getSenders().find(function(t){return t.track===e});if(t){throw new DOMException("Track already exists.","InvalidAccessError")}});if(!this._reverseStreams[r.id]){var a=new e.MediaStream(r.getTracks());this._streams[r.id]=a;this._reverseStreams[a.id]=r;r=a}n.apply(this,[r])};var i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function e(t){this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};i.apply(this,[this._streams[t.id]||t]);delete this._reverseStreams[this._streams[t.id]?this._streams[t.id].id:t.id];delete this._streams[t.id]};e.RTCPeerConnection.prototype.addTrack=function t(r,n){var i=this;if(this.signalingState==="closed"){throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError")}var a=[].slice.call(arguments,1);if(a.length!==1||!a[0].getTracks().find(function(e){return e===r})){throw new DOMException("The adapter.js addTrack polyfill only supports a single "+" stream which is associated with the specified track.","NotSupportedError")}var o=this.getSenders().find(function(e){return e.track===r});if(o){throw new DOMException("Track already exists.","InvalidAccessError")}this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};var s=this._streams[n.id];if(s){s.addTrack(r);Promise.resolve().then(function(){i.dispatchEvent(new Event("negotiationneeded"))})}else{var c=new e.MediaStream([r]);this._streams[n.id]=c;this._reverseStreams[c.id]=n;this.addStream(c)}return this.getSenders().find(function(e){return e.track===r})};function a(e,t){var r=t.sdp;Object.keys(e._reverseStreams||[]).forEach(function(t){var n=e._reverseStreams[t];var i=e._streams[n.id];r=r.replace(new RegExp(i.id,"g"),n.id)});return new RTCSessionDescription({type:t.type,sdp:r})}function o(e,t){var r=t.sdp;Object.keys(e._reverseStreams||[]).forEach(function(t){var n=e._reverseStreams[t];var i=e._streams[n.id];r=r.replace(new RegExp(n.id,"g"),i.id)});return new RTCSessionDescription({type:t.type,sdp:r})}["createOffer","createAnswer"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];var n=d({},t,function(){var e=this;var t=arguments;var n=arguments.length&&typeof arguments[0]==="function";if(n){return r.apply(this,[function(r){var n=a(e,r);t[0].apply(null,[n])},function(e){if(t[1]){t[1].apply(null,e)}},arguments[2]])}return r.apply(this,arguments).then(function(t){return a(e,t)})});e.RTCPeerConnection.prototype[t]=n[t]});var c=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function e(){if(!arguments.length||!arguments[0].type){return c.apply(this,arguments)}arguments[0]=o(this,arguments[0]);return c.apply(this,arguments)};var f=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function e(){var t=f.get.apply(this);if(t.type===""){return t}return a(this,t)}});e.RTCPeerConnection.prototype.removeTrack=function e(t){var r=this;if(this.signalingState==="closed"){throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError")}if(!t._pc){throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack "+"does not implement interface RTCRtpSender.","TypeError")}var n=t._pc===this;if(!n){throw new DOMException("Sender was not created by this connection.","InvalidAccessError")}this._streams=this._streams||{};var i=void 0;Object.keys(this._streams).forEach(function(e){var n=r._streams[e].getTracks().find(function(e){return t.track===e});if(n){i=r._streams[e]}});if(i){if(i.getTracks().length===1){this.removeStream(this._reverseStreams[i.id])}else{i.removeTrack(t.track)}this.dispatchEvent(new Event("negotiationneeded"))}}}function g(e){var t=s.detectBrowser(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection){e.RTCPeerConnection=e.webkitRTCPeerConnection}if(!e.RTCPeerConnection){return}if(t.version<53){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];var n=d({},t,function(){arguments[0]=new(t==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]);return r.apply(this,arguments)});e.RTCPeerConnection.prototype[t]=n[t]})}var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function e(){if(!arguments[0]){if(arguments[1]){arguments[1].apply(null)}return Promise.resolve()}if(t.version<78&&arguments[0]&&arguments[0].candidate===""){return Promise.resolve()}return r.apply(this,arguments)}}function y(e){s.wrapPeerConnectionEvent(e,"negotiationneeded",function(e){var t=e.target;if(t.signalingState!=="stable"){return}return e})}},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});r.shimGetDisplayMedia=n;function n(e,t){if(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices){return}if(!e.navigator.mediaDevices){return}if(typeof t!=="function"){console.error("shimGetDisplayMedia: getSourceId argument is not "+"a function");return}e.navigator.mediaDevices.getDisplayMedia=function r(n){return t(n).then(function(t){var r=n.video&&n.video.width;var i=n.video&&n.video.height;var a=n.video&&n.video.frameRate;n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:a||3}};if(r){n.video.mandatory.maxWidth=r}if(i){n.video.mandatory.maxHeight=i}return e.navigator.mediaDevices.getUserMedia(n)})}}},{}],5:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});var n=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol==="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=c;var i=e("../utils.js");var a=o(i);function o(e){if(e&&e.__esModule){return e}else{var t={};if(e!=null){for(var r in e){if(Object.prototype.hasOwnProperty.call(e,r))t[r]=e[r]}}t.default=e;return t}}var s=a.log;function c(e){var t=e&&e.navigator;if(!t.mediaDevices){return}var r=a.detectBrowser(e);var i=function e(t){if((typeof t==="undefined"?"undefined":n(t))!=="object"||t.mandatory||t.optional){return t}var r={};Object.keys(t).forEach(function(e){if(e==="require"||e==="advanced"||e==="mediaSource"){return}var i=n(t[e])==="object"?t[e]:{ideal:t[e]};if(i.exact!==undefined&&typeof i.exact==="number"){i.min=i.max=i.exact}var a=function e(t,r){if(t){return t+r.charAt(0).toUpperCase()+r.slice(1)}return r==="deviceId"?"sourceId":r};if(i.ideal!==undefined){r.optional=r.optional||[];var o={};if(typeof i.ideal==="number"){o[a("min",e)]=i.ideal;r.optional.push(o);o={};o[a("max",e)]=i.ideal;r.optional.push(o)}else{o[a("",e)]=i.ideal;r.optional.push(o)}}if(i.exact!==undefined&&typeof i.exact!=="number"){r.mandatory=r.mandatory||{};r.mandatory[a("",e)]=i.exact}else{["min","max"].forEach(function(t){if(i[t]!==undefined){r.mandatory=r.mandatory||{};r.mandatory[a(t,e)]=i[t]}})}});if(t.advanced){r.optional=(r.optional||[]).concat(t.advanced)}return r};var o=function e(a,o){if(r.version>=61){return o(a)}a=JSON.parse(JSON.stringify(a));if(a&&n(a.audio)==="object"){var c=function e(t,r,n){if(r in t&&!(n in t)){t[n]=t[r];delete t[r]}};a=JSON.parse(JSON.stringify(a));c(a.audio,"autoGainControl","googAutoGainControl");c(a.audio,"noiseSuppression","googNoiseSuppression");a.audio=i(a.audio)}if(a&&n(a.video)==="object"){var d=a.video.facingMode;d=d&&((typeof d==="undefined"?"undefined":n(d))==="object"?d:{ideal:d});var f=r.version<66;if(d&&(d.exact==="user"||d.exact==="environment"||d.ideal==="user"||d.ideal==="environment")&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!f)){delete a.video.facingMode;var u=void 0;if(d.exact==="environment"||d.ideal==="environment"){u=["back","rear"]}else if(d.exact==="user"||d.ideal==="user"){u=["front"]}if(u){return t.mediaDevices.enumerateDevices().then(function(e){e=e.filter(function(e){return e.kind==="videoinput"});var t=e.find(function(e){return u.some(function(t){return e.label.toLowerCase().includes(t)})});if(!t&&e.length&&u.includes("back")){t=e[e.length-1]}if(t){a.video.deviceId=d.exact?{exact:t.deviceId}:{ideal:t.deviceId}}a.video=i(a.video);s("chrome: "+JSON.stringify(a));return o(a)})}}a.video=i(a.video)}s("chrome: "+JSON.stringify(a));return o(a)};var c=function e(t){if(r.version>=64){return t}return{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[t.name]||t.name,message:t.message,constraint:t.constraint||t.constraintName,toString:function e(){return this.name+(this.message&&": ")+this.message}}};var d=function e(r,n,i){o(r,function(e){t.webkitGetUserMedia(e,n,function(e){if(i){i(c(e))}})})};t.getUserMedia=d.bind(t);if(t.mediaDevices.getUserMedia){var f=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return o(e,function(e){return f(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length){t.getTracks().forEach(function(e){e.stop()});throw new DOMException("","NotFoundError")}return t},function(e){return Promise.reject(c(e))})})}}}},{"../utils.js":15}],6:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});var n=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol==="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimRTCIceCandidate=f;r.shimMaxMessageSize=u;r.shimSendThrowTypeError=l;r.shimConnectionState=p;r.removeAllowExtmapMixed=m;var i=e("sdp");var a=d(i);var o=e("./utils");var s=c(o);function c(e){if(e&&e.__esModule){return e}else{var t={};if(e!=null){for(var r in e){if(Object.prototype.hasOwnProperty.call(e,r))t[r]=e[r]}}t.default=e;return t}}function d(e){return e&&e.__esModule?e:{default:e}}function f(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype){return}var t=e.RTCIceCandidate;e.RTCIceCandidate=function e(r){if((typeof r==="undefined"?"undefined":n(r))==="object"&&r.candidate&&r.candidate.indexOf("a=")===0){r=JSON.parse(JSON.stringify(r));r.candidate=r.candidate.substr(2)}if(r.candidate&&r.candidate.length){var i=new t(r);var o=a.default.parseCandidate(r.candidate);var s=Object.assign(i,o);s.toJSON=function e(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}};return s}return new t(r)};e.RTCIceCandidate.prototype=t.prototype;s.wrapPeerConnectionEvent(e,"icecandidate",function(t){if(t.candidate){Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"})}return t})}function u(e){if(!e.RTCPeerConnection){return}var t=s.detectBrowser(e);if(!("sctp"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function e(){return typeof this._sctp==="undefined"?null:this._sctp}})}var r=function e(t){if(!t||!t.sdp){return false}var r=a.default.splitSections(t.sdp);r.shift();return r.some(function(e){var t=a.default.parseMLine(e);return t&&t.kind==="application"&&t.protocol.indexOf("SCTP")!==-1})};var n=function e(t){var r=t.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(r===null||r.length<2){return-1}var n=parseInt(r[1],10);return n!==n?-1:n};var i=function e(r){var n=65536;if(t.browser==="firefox"){if(t.version<57){if(r===-1){n=16384}else{n=2147483637}}else if(t.version<60){n=t.version===57?65535:65536}else{n=2147483637}}return n};var o=function e(r,n){var i=65536;if(t.browser==="firefox"&&t.version===57){i=65535}var o=a.default.matchPrefix(r.sdp,"a=max-message-size:");if(o.length>0){i=parseInt(o[0].substr(19),10)}else if(t.browser==="firefox"&&n!==-1){i=2147483637}return i};var c=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function e(){this._sctp=null;if(t.browser==="chrome"&&t.version>=76){var a=this.getConfiguration(),s=a.sdpSemantics;if(s==="plan-b"){Object.defineProperty(this,"sctp",{get:function e(){return typeof this._sctp==="undefined"?null:this._sctp},enumerable:true,configurable:true})}}if(r(arguments[0])){var d=n(arguments[0]);var f=i(d);var u=o(arguments[0],d);var l=void 0;if(f===0&&u===0){l=Number.POSITIVE_INFINITY}else if(f===0||u===0){l=Math.max(f,u)}else{l=Math.min(f,u)}var p={};Object.defineProperty(p,"maxMessageSize",{get:function e(){return l}});this._sctp=p}return c.apply(this,arguments)}}function l(e){if(!(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype)){return}function t(e,t){var r=e.send;e.send=function n(){var i=arguments[0];var a=i.length||i.size||i.byteLength;if(e.readyState==="open"&&t.sctp&&a>t.sctp.maxMessageSize){throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)")}return r.apply(e,arguments)}}var r=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function e(){var n=r.apply(this,arguments);t(n,this);return n};s.wrapPeerConnectionEvent(e,"datachannel",function(e){t(e.channel,e.target);return e})}function p(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype){return}var t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get:function e(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:true,configurable:true});Object.defineProperty(t,"onconnectionstatechange",{get:function e(){return this._onconnectionstatechange||null},set:function e(t){if(this._onconnectionstatechange){this.removeEventListener("connectionstatechange",this._onconnectionstatechange);delete this._onconnectionstatechange}if(t){this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)}},enumerable:true,configurable:true});["setLocalDescription","setRemoteDescription"].forEach(function(e){var r=t[e];t[e]=function(){if(!this._connectionstatechangepoly){this._connectionstatechangepoly=function(e){var t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;var r=new Event("connectionstatechange",e);t.dispatchEvent(r)}return e};this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)}return r.apply(this,arguments)}})}function m(e){if(!e.RTCPeerConnection){return}var t=s.detectBrowser(e);if(t.browser==="chrome"&&t.version>=71){return}var r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function e(t){if(t&&t.sdp&&t.sdp.indexOf("\na=extmap-allow-mixed")!==-1){t.sdp=t.sdp.split("\n").filter(function(e){return e.trim()!=="a=extmap-allow-mixed"}).join("\n")}return r.apply(this,arguments)}}},{"./utils":15,sdp:17}],7:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});r.shimGetDisplayMedia=r.shimGetUserMedia=undefined;var n=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:true,get:function e(){return n.shimGetUserMedia}});var i=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:true,get:function e(){return i.shimGetDisplayMedia}});r.shimPeerConnection=l;r.shimReplaceTrack=p;var a=e("../utils");var o=u(a);var s=e("./filtericeservers");var c=e("rtcpeerconnection-shim");var d=f(c);function f(e){return e&&e.__esModule?e:{default:e}}function u(e){if(e&&e.__esModule){return e}else{var t={};if(e!=null){for(var r in e){if(Object.prototype.hasOwnProperty.call(e,r))t[r]=e[r]}}t.default=e;return t}}function l(e){var t=o.detectBrowser(e);if(e.RTCIceGatherer){if(!e.RTCIceCandidate){e.RTCIceCandidate=function e(t){return t}}if(!e.RTCSessionDescription){e.RTCSessionDescription=function e(t){return t}}if(t.version<15025){var r=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function e(t){r.set.call(this,t);var n=new Event("enabled");n.enabled=t;this.dispatchEvent(n)}})}}if(e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function t(){if(this._dtmf===undefined){if(this.track.kind==="audio"){this._dtmf=new e.RTCDtmfSender(this)}else if(this.track.kind==="video"){this._dtmf=null}}return this._dtmf}})}if(e.RTCDtmfSender&&!e.RTCDTMFSender){e.RTCDTMFSender=e.RTCDtmfSender}var n=(0,d.default)(e,t.version);e.RTCPeerConnection=function e(r){if(r&&r.iceServers){r.iceServers=(0,s.filterIceServers)(r.iceServers,t.version);o.log("ICE servers after filtering:",r.iceServers)}return new n(r)};e.RTCPeerConnection.prototype=n.prototype}function p(e){if(e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)){e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack}}},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});r.filterIceServers=o;var n=e("../utils");var i=a(n);function a(e){if(e&&e.__esModule){return e}else{var t={};if(e!=null){for(var r in e){if(Object.prototype.hasOwnProperty.call(e,r))t[r]=e[r]}}t.default=e;return t}}function o(e,t){var r=false;e=JSON.parse(JSON.stringify(e));return e.filter(function(e){if(e&&(e.urls||e.url)){var t=e.urls||e.url;if(e.url&&!e.urls){i.deprecated("RTCIceServer.url","RTCIceServer.urls")}var n=typeof t==="string";if(n){t=[t]}t=t.filter(function(e){if(e.indexOf("stun:")===0){return false}var t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");if(t&&!r){r=true;return true}return t&&!r});delete e.url;e.urls=n?t[0]:t;return!!t.length}})}},{"../utils":15}],9:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});r.shimGetDisplayMedia=n;function n(e){if(!("getDisplayMedia"in e.navigator)){return}if(!e.navigator.mediaDevices){return}if(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices){return}e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)}},{}],10:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});r.shimGetUserMedia=n;function n(e){var t=e&&e.navigator;var r=function e(t){return{name:{PermissionDeniedError:"NotAllowedError"}[t.name]||t.name,message:t.message,constraint:t.constraint,toString:function e(){return this.name}}};var n=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e).catch(function(e){return Promise.reject(r(e))})}}},{}],11:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});r.shimGetDisplayMedia=r.shimGetUserMedia=undefined;var n=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol==="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};var i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:true,get:function e(){return i.shimGetUserMedia}});var a=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:true,get:function e(){return a.shimGetDisplayMedia}});r.shimOnTrack=f;r.shimPeerConnection=u;r.shimSenderGetStats=l;r.shimReceiverGetStats=p;r.shimRemoveStream=m;r.shimRTCDataChannel=v;r.shimAddTransceiver=h;r.shimCreateOffer=g;r.shimCreateAnswer=y;var o=e("../utils");var s=c(o);function c(e){if(e&&e.__esModule){return e}else{var t={};if(e!=null){for(var r in e){if(Object.prototype.hasOwnProperty.call(e,r))t[r]=e[r]}}t.default=e;return t}}function d(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}function f(e){if((typeof e==="undefined"?"undefined":n(e))==="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)){Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function e(){return{receiver:this.receiver}}})}}function u(e){var t=s.detectBrowser(e);if((typeof e==="undefined"?"undefined":n(e))!=="object"||!(e.RTCPeerConnection||e.mozRTCPeerConnection)){return}if(!e.RTCPeerConnection&&e.mozRTCPeerConnection){e.RTCPeerConnection=e.mozRTCPeerConnection}if(t.version<53){["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){var r=e.RTCPeerConnection.prototype[t];var n=d({},t,function(){arguments[0]=new(t==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]);return r.apply(this,arguments)});e.RTCPeerConnection.prototype[t]=n[t]})}if(t.version<68){var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function e(){if(!arguments[0]){if(arguments[1]){arguments[1].apply(null)}return Promise.resolve()}if(arguments[0]&&arguments[0].candidate===""){return Promise.resolve()}return r.apply(this,arguments)}}var i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"};var a=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function e(){var r=Array.prototype.slice.call(arguments),n=r[0],o=r[1],s=r[2];return a.apply(this,[n||null]).then(function(e){if(t.version<53&&!o){try{e.forEach(function(e){e.type=i[e.type]||e.type})}catch(r){if(r.name!=="TypeError"){throw r}e.forEach(function(t,r){e.set(r,Object.assign({},t,{type:i[t.type]||t.type}))})}}return e}).then(o,s)}}function l(e){if(!((typeof e==="undefined"?"undefined":n(e))==="object"&&e.RTCPeerConnection&&e.RTCRtpSender)){return}if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype){return}var t=e.RTCPeerConnection.prototype.getSenders;if(t){e.RTCPeerConnection.prototype.getSenders=function e(){var r=this;var n=t.apply(this,[]);n.forEach(function(e){return e._pc=r});return n}}var r=e.RTCPeerConnection.prototype.addTrack;if(r){e.RTCPeerConnection.prototype.addTrack=function e(){var t=r.apply(this,arguments);t._pc=this;return t}}e.RTCRtpSender.prototype.getStats=function e(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function p(e){if(!((typeof e==="undefined"?"undefined":n(e))==="object"&&e.RTCPeerConnection&&e.RTCRtpSender)){return}if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype){return}var t=e.RTCPeerConnection.prototype.getReceivers;if(t){e.RTCPeerConnection.prototype.getReceivers=function e(){var r=this;var n=t.apply(this,[]);n.forEach(function(e){return e._pc=r});return n}}s.wrapPeerConnectionEvent(e,"track",function(e){e.receiver._pc=e.srcElement;return e});e.RTCRtpReceiver.prototype.getStats=function e(){return this._pc.getStats(this.track)}}function m(e){if(!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype){return}e.RTCPeerConnection.prototype.removeStream=function e(t){var r=this;s.deprecated("removeStream","removeTrack");this.getSenders().forEach(function(e){if(e.track&&t.getTracks().includes(e.track)){r.removeTrack(e)}})}}function v(e){if(e.DataChannel&&!e.RTCDataChannel){e.RTCDataChannel=e.DataChannel}}function h(e){if(!((typeof e==="undefined"?"undefined":n(e))==="object"&&e.RTCPeerConnection)){return}var t=e.RTCPeerConnection.prototype.addTransceiver;if(t){e.RTCPeerConnection.prototype.addTransceiver=function e(){this.setParametersPromises=[];var r=arguments[1];var n=r&&"sendEncodings"in r;if(n){r.sendEncodings.forEach(function(e){if("rid"in e){var t=/^[a-z0-9]{0,16}$/i;if(!t.test(e.rid)){throw new TypeError("Invalid RID value provided.")}}if("scaleResolutionDownBy"in e){if(!(parseFloat(e.scaleResolutionDownBy)>=1)){throw new RangeError("scale_resolution_down_by must be >= 1.0")}}if("maxFramerate"in e){if(!(parseFloat(e.maxFramerate)>=0)){throw new RangeError("max_framerate must be >= 0.0")}}})}var i=t.apply(this,arguments);if(n){var a=i.sender;var o=a.getParameters();if(!("encodings"in o)){o.encodings=r.sendEncodings;this.setParametersPromises.push(a.setParameters(o).catch(function(){}))}}return i}}}function g(e){if(!((typeof e==="undefined"?"undefined":n(e))==="object"&&e.RTCPeerConnection)){return}var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function e(){var r=this,n=arguments;if(this.setParametersPromises&&this.setParametersPromises.length){return Promise.all(this.setParametersPromises).then(function(){return t.apply(r,n)}).finally(function(){r.setParametersPromises=[]})}return t.apply(this,arguments)}}function y(e){if(!((typeof e==="undefined"?"undefined":n(e))==="object"&&e.RTCPeerConnection)){return}var t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function e(){var r=this,n=arguments;if(this.setParametersPromises&&this.setParametersPromises.length){return Promise.all(this.setParametersPromises).then(function(){return t.apply(r,n)}).finally(function(){r.setParametersPromises=[]})}return t.apply(this,arguments)}}},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});r.shimGetDisplayMedia=n;function n(e,t){if(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices){return}if(!e.navigator.mediaDevices){return}e.navigator.mediaDevices.getDisplayMedia=function r(n){if(!(n&&n.video)){var i=new DOMException("getDisplayMedia without video "+"constraints is undefined");i.name="NotFoundError";i.code=8;return Promise.reject(i)}if(n.video===true){n.video={mediaSource:t}}else{n.video.mediaSource=t}return e.navigator.mediaDevices.getUserMedia(n)}}},{}],13:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});var n=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol==="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimGetUserMedia=s;var i=e("../utils");var a=o(i);function o(e){if(e&&e.__esModule){return e}else{var t={};if(e!=null){for(var r in e){if(Object.prototype.hasOwnProperty.call(e,r))t[r]=e[r]}}t.default=e;return t}}function s(e){var t=a.detectBrowser(e);var r=e&&e.navigator;var i=e&&e.MediaStreamTrack;r.getUserMedia=function(e,t,n){a.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia");r.mediaDevices.getUserMedia(e).then(t,n)};if(!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){var o=function e(t,r,n){if(r in t&&!(n in t)){t[n]=t[r];delete t[r]}};var s=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(e){if((typeof e==="undefined"?"undefined":n(e))==="object"&&n(e.audio)==="object"){e=JSON.parse(JSON.stringify(e));o(e.audio,"autoGainControl","mozAutoGainControl");o(e.audio,"noiseSuppression","mozNoiseSuppression")}return s(e)};if(i&&i.prototype.getSettings){var c=i.prototype.getSettings;i.prototype.getSettings=function(){var e=c.apply(this,arguments);o(e,"mozAutoGainControl","autoGainControl");o(e,"mozNoiseSuppression","noiseSuppression");return e}}if(i&&i.prototype.applyConstraints){var d=i.prototype.applyConstraints;i.prototype.applyConstraints=function(e){if(this.kind==="audio"&&(typeof e==="undefined"?"undefined":n(e))==="object"){e=JSON.parse(JSON.stringify(e));o(e,"autoGainControl","mozAutoGainControl");o(e,"noiseSuppression","mozNoiseSuppression")}return d.apply(this,[e])}}}}},{"../utils":15}],14:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});var n=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol==="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.shimLocalStreamsAPI=s;r.shimRemoteStreamsAPI=c;r.shimCallbacksAPI=d;r.shimGetUserMedia=f;r.shimConstraints=u;r.shimRTCIceServerUrls=l;r.shimTrackEventTransceiver=p;r.shimCreateOfferLegacy=m;var i=e("../utils");var a=o(i);function o(e){if(e&&e.__esModule){return e}else{var t={};if(e!=null){for(var r in e){if(Object.prototype.hasOwnProperty.call(e,r))t[r]=e[r]}}t.default=e;return t}}function s(e){if((typeof e==="undefined"?"undefined":n(e))!=="object"||!e.RTCPeerConnection){return}if(!("getLocalStreams"in e.RTCPeerConnection.prototype)){e.RTCPeerConnection.prototype.getLocalStreams=function e(){if(!this._localStreams){this._localStreams=[]}return this._localStreams}}if(!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function e(r){var n=this;if(!this._localStreams){this._localStreams=[]}if(!this._localStreams.includes(r)){this._localStreams.push(r)}r.getAudioTracks().forEach(function(e){return t.call(n,e,r)});r.getVideoTracks().forEach(function(e){return t.call(n,e,r)})};e.RTCPeerConnection.prototype.addTrack=function e(r){var n=arguments[1];if(n){if(!this._localStreams){this._localStreams=[n]}else if(!this._localStreams.includes(n)){this._localStreams.push(n)}}return t.apply(this,arguments)}}if(!("removeStream"in e.RTCPeerConnection.prototype)){e.RTCPeerConnection.prototype.removeStream=function e(t){var r=this;if(!this._localStreams){this._localStreams=[]}var n=this._localStreams.indexOf(t);if(n===-1){return}this._localStreams.splice(n,1);var i=t.getTracks();this.getSenders().forEach(function(e){if(i.includes(e.track)){r.removeTrack(e)}})}}}function c(e){if((typeof e==="undefined"?"undefined":n(e))!=="object"||!e.RTCPeerConnection){return}if(!("getRemoteStreams"in e.RTCPeerConnection.prototype)){e.RTCPeerConnection.prototype.getRemoteStreams=function e(){return this._remoteStreams?this._remoteStreams:[]}}if(!("onaddstream"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function e(){return this._onaddstream},set:function e(t){var r=this;if(this._onaddstream){this.removeEventListener("addstream",this._onaddstream);this.removeEventListener("track",this._onaddstreampoly)}this.addEventListener("addstream",this._onaddstream=t);this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(e){if(!r._remoteStreams){r._remoteStreams=[]}if(r._remoteStreams.includes(e)){return}r._remoteStreams.push(e);var t=new Event("addstream");t.stream=e;r.dispatchEvent(t)})})}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function e(){var r=this;if(!this._onaddstreampoly){this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(e){if(!r._remoteStreams){r._remoteStreams=[]}if(r._remoteStreams.indexOf(e)>=0){return}r._remoteStreams.push(e);var t=new Event("addstream");t.stream=e;r.dispatchEvent(t)})})}return t.apply(r,arguments)}}}function d(e){if((typeof e==="undefined"?"undefined":n(e))!=="object"||!e.RTCPeerConnection){return}var t=e.RTCPeerConnection.prototype;var r=t.createOffer;var i=t.createAnswer;var a=t.setLocalDescription;var o=t.setRemoteDescription;var s=t.addIceCandidate;t.createOffer=function e(t,n){var i=arguments.length>=2?arguments[2]:arguments[0];var a=r.apply(this,[i]);if(!n){return a}a.then(t,n);return Promise.resolve()};t.createAnswer=function e(t,r){var n=arguments.length>=2?arguments[2]:arguments[0];var a=i.apply(this,[n]);if(!r){return a}a.then(t,r);return Promise.resolve()};var c=function e(t,r,n){var i=a.apply(this,[t]);if(!n){return i}i.then(r,n);return Promise.resolve()};t.setLocalDescription=c;c=function e(t,r,n){var i=o.apply(this,[t]);if(!n){return i}i.then(r,n);return Promise.resolve()};t.setRemoteDescription=c;c=function e(t,r,n){var i=s.apply(this,[t]);if(!n){return i}i.then(r,n);return Promise.resolve()};t.addIceCandidate=c}function f(e){var t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){var r=t.mediaDevices;var n=r.getUserMedia.bind(r);t.mediaDevices.getUserMedia=function(e){return n(u(e))}}if(!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia){t.getUserMedia=(function e(r,n,i){t.mediaDevices.getUserMedia(r).then(n,i)}).bind(t)}}function u(e){if(e&&e.video!==undefined){return Object.assign({},e,{video:a.compactObject(e.video)})}return e}function l(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function e(r,n){if(r&&r.iceServers){var i=[];for(var o=0;o<r.iceServers.length;o++){var s=r.iceServers[o];if(!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")){a.deprecated("RTCIceServer.url","RTCIceServer.urls");s=JSON.parse(JSON.stringify(s));s.urls=s.url;delete s.url;i.push(s)}else{i.push(r.iceServers[o])}}r.iceServers=i}return new t(r,n)};e.RTCPeerConnection.prototype=t.prototype;if("generateCertificate"in e.RTCPeerConnection){Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function e(){return t.generateCertificate}})}}function p(e){if((typeof e==="undefined"?"undefined":n(e))==="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)){Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function e(){return{receiver:this.receiver}}})}}function m(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function e(r){if(r){if(typeof r.offerToReceiveAudio!=="undefined"){r.offerToReceiveAudio=!!r.offerToReceiveAudio}var n=this.getTransceivers().find(function(e){return e.receiver.track.kind==="audio"});if(r.offerToReceiveAudio===false&&n){if(n.direction==="sendrecv"){if(n.setDirection){n.setDirection("sendonly")}else{n.direction="sendonly"}}else if(n.direction==="recvonly"){if(n.setDirection){n.setDirection("inactive")}else{n.direction="inactive"}}}else if(r.offerToReceiveAudio===true&&!n){this.addTransceiver("audio")}if(typeof r.offerToReceiveVideo!=="undefined"){r.offerToReceiveVideo=!!r.offerToReceiveVideo}var i=this.getTransceivers().find(function(e){return e.receiver.track.kind==="video"});if(r.offerToReceiveVideo===false&&i){if(i.direction==="sendrecv"){if(i.setDirection){i.setDirection("sendonly")}else{i.direction="sendonly"}}else if(i.direction==="recvonly"){if(i.setDirection){i.setDirection("inactive")}else{i.direction="inactive"}}}else if(r.offerToReceiveVideo===true&&!i){this.addTransceiver("video")}}return t.apply(this,arguments)}}},{"../utils":15}],15:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:true});var n=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol==="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.extractVersion=s;r.wrapPeerConnectionEvent=c;r.disableLog=d;r.disableWarnings=f;r.log=u;r.deprecated=l;r.detectBrowser=p;r.compactObject=v;r.walkStats=h;r.filterStats=g;function i(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}var a=true;var o=true;function s(e,t,r){var n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}function c(e,t,r){if(!e.RTCPeerConnection){return}var n=e.RTCPeerConnection.prototype;var i=n.addEventListener;n.addEventListener=function(e,n){if(e!==t){return i.apply(this,arguments)}var a=function e(t){var i=r(t);if(i){n(i)}};this._eventMap=this._eventMap||{};this._eventMap[n]=a;return i.apply(this,[e,a])};var a=n.removeEventListener;n.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r]){return a.apply(this,arguments)}var n=this._eventMap[r];delete this._eventMap[r];return a.apply(this,[e,n])};Object.defineProperty(n,"on"+t,{get:function e(){return this["_on"+t]},set:function e(r){if(this["_on"+t]){this.removeEventListener(t,this["_on"+t]);delete this["_on"+t]}if(r){this.addEventListener(t,this["_on"+t]=r)}},enumerable:true,configurable:true})}function d(e){if(typeof e!=="boolean"){return new Error("Argument type: "+(typeof e==="undefined"?"undefined":n(e))+". Please use a boolean.")}a=e;return e?"adapter.js logging disabled":"adapter.js logging enabled"}function f(e){if(typeof e!=="boolean"){return new Error("Argument type: "+(typeof e==="undefined"?"undefined":n(e))+". Please use a boolean.")}o=!e;return"adapter.js deprecation warnings "+(e?"disabled":"enabled")}function u(){if((typeof window==="undefined"?"undefined":n(window))==="object"){if(a){return}if(typeof console!=="undefined"&&typeof console.log==="function"){console.log.apply(console,arguments)}}}function l(e,t){if(!o){return}console.warn(e+" is deprecated, please use "+t+" instead.")}function p(e){var t=e.navigator;var r={browser:null,version:null};if(typeof e==="undefined"||!e.navigator){r.browser="Not a browser.";return r}if(t.mozGetUserMedia){r.browser="firefox";r.version=s(t.userAgent,/Firefox\/(\d+)\./,1)}else if(t.webkitGetUserMedia||e.isSecureContext===false&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer){r.browser="chrome";r.version=s(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2)}else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/)){r.browser="edge";r.version=s(t.userAgent,/Edge\/(\d+).(\d+)$/,2)}else if(e.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./)){r.browser="safari";r.version=s(t.userAgent,/AppleWebKit\/(\d+)\./,1);r.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}else{r.browser="Not a supported browser.";return r}return r}function m(e){return Object.prototype.toString.call(e)==="[object Object]"}function v(e){if(!m(e)){return e}return Object.keys(e).reduce(function(t,r){var n=m(e[r]);var a=n?v(e[r]):e[r];var o=n&&!Object.keys(a).length;if(a===undefined||o){return t}return Object.assign(t,i({},r,a))},{})}function h(e,t,r){if(!t||r.has(t.id)){return}r.set(t.id,t);Object.keys(t).forEach(function(n){if(n.endsWith("Id")){h(e,e.get(t[n]),r)}else if(n.endsWith("Ids")){t[n].forEach(function(t){h(e,e.get(t),r)})}})}function g(e,t,r){var n=r?"outbound-rtp":"inbound-rtp";var i=new Map;if(t===null){return i}var a=[];e.forEach(function(e){if(e.type==="track"&&e.trackIdentifier===t.id){a.push(e)}});a.forEach(function(t){e.forEach(function(r){if(r.type===n&&r.trackId===t.id){h(e,r,i)}})});return i}},{}],16:[function(e,t,r){var n=e("sdp");function i(e){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type}function a(e,t,r,i,a){var o=n.writeRtpDescription(e.kind,t);o+=n.writeIceParameters(e.iceGatherer.getLocalParameters());o+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),r==="offer"?"actpass":a||"active");o+="a=mid:"+e.mid+"\r\n";if(e.rtpSender&&e.rtpReceiver){o+="a=sendrecv\r\n"}else if(e.rtpSender){o+="a=sendonly\r\n"}else if(e.rtpReceiver){o+="a=recvonly\r\n"}else{o+="a=inactive\r\n"}if(e.rtpSender){var s=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=s;var c="msid:"+(i?i.id:"-")+" "+s+"\r\n";o+="a="+c;o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c;if(e.sendEncodingParameters[0].rtx){o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c;o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n";if(e.rtpSender&&e.sendEncodingParameters[0].rtx){o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"}return o}function o(e,t){var r=false;e=JSON.parse(JSON.stringify(e));return e.filter(function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;if(e.url&&!e.urls){console.warn("RTCIceServer.url is deprecated! Use urls instead.")}var i=typeof n==="string";if(i){n=[n]}n=n.filter(function(e){var n=e.indexOf("turn:")===0&&e.indexOf("transport=udp")!==-1&&e.indexOf("turn:[")===-1&&!r;if(n){r=true;return true}return e.indexOf("stun:")===0&&t>=14393&&e.indexOf("?transport=udp")===-1});delete e.url;e.urls=i?n[0]:n;return!!n.length}})}function s(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]};var n=function e(t,r){t=parseInt(t,10);for(var n=0;n<r.length;n++){if(r[n].payloadType===t||r[n].preferredPayloadType===t){return r[n]}}};var i=function e(t,r,i,a){var o=n(t.parameters.apt,i);var s=n(r.parameters.apt,a);return o&&s&&o.name.toLowerCase()===s.name.toLowerCase()};e.codecs.forEach(function(n){for(var a=0;a<t.codecs.length;a++){var o=t.codecs[a];if(n.name.toLowerCase()===o.name.toLowerCase()&&n.clockRate===o.clockRate){if(n.name.toLowerCase()==="rtx"&&n.parameters&&o.parameters.apt){if(!i(n,o,e.codecs,t.codecs)){continue}}o=JSON.parse(JSON.stringify(o));o.numChannels=Math.min(n.numChannels,o.numChannels);r.codecs.push(o);o.rtcpFeedback=o.rtcpFeedback.filter(function(e){for(var t=0;t<n.rtcpFeedback.length;t++){if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter){return true}}return false});break}}});e.headerExtensions.forEach(function(e){for(var n=0;n<t.headerExtensions.length;n++){var i=t.headerExtensions[n];if(e.uri===i.uri){r.headerExtensions.push(i);break}}});return r}function c(e,t,r){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)!==-1}function d(e,t){var r=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});if(!r){e.addRemoteCandidate(t)}return!r}function f(e,t){var r=new Error(t);r.name=e;r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:undefined,OperationError:undefined}[e];return r}t.exports=function(e,t){function r(t,r){r.addTrack(t);r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function u(t,r){r.removeTrack(t);r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}function l(t,r,n,i){var a=new Event("track");a.track=r;a.receiver=n;a.transceiver={receiver:n};a.streams=i;e.setTimeout(function(){t._dispatchEvent("track",a)})}var p=function r(i){var a=this;var s=document.createDocumentFragment();["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){a[e]=s[e].bind(s)});this.canTrickleIceCandidates=null;this.needNegotiation=false;this.localStreams=[];this.remoteStreams=[];this._localDescription=null;this._remoteDescription=null;this.signalingState="stable";this.iceConnectionState="new";this.connectionState="new";this.iceGatheringState="new";i=JSON.parse(JSON.stringify(i||{}));this.usingBundle=i.bundlePolicy==="max-bundle";if(i.rtcpMuxPolicy==="negotiate"){throw f("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported")}else if(!i.rtcpMuxPolicy){i.rtcpMuxPolicy="require"}switch(i.iceTransportPolicy){case"all":case"relay":break;default:i.iceTransportPolicy="all";break}switch(i.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:i.bundlePolicy="balanced";break}i.iceServers=o(i.iceServers||[],t);this._iceGatherers=[];if(i.iceCandidatePoolSize){for(var c=i.iceCandidatePoolSize;c>0;c--){this._iceGatherers.push(new e.RTCIceGatherer({iceServers:i.iceServers,gatherPolicy:i.iceTransportPolicy}))}}else{i.iceCandidatePoolSize=0}this._config=i;this.transceivers=[];this._sdpSessionId=n.generateSessionId();this._sdpSessionVersion=0;this._dtlsRole=undefined;this._isClosed=false};Object.defineProperty(p.prototype,"localDescription",{configurable:true,get:function e(){return this._localDescription}});Object.defineProperty(p.prototype,"remoteDescription",{configurable:true,get:function e(){return this._remoteDescription}});p.prototype.onicecandidate=null;p.prototype.onaddstream=null;p.prototype.ontrack=null;p.prototype.onremovestream=null;p.prototype.onsignalingstatechange=null;p.prototype.oniceconnectionstatechange=null;p.prototype.onconnectionstatechange=null;p.prototype.onicegatheringstatechange=null;p.prototype.onnegotiationneeded=null;p.prototype.ondatachannel=null;p.prototype._dispatchEvent=function(e,t){if(this._isClosed){return}this.dispatchEvent(t);if(typeof this["on"+e]==="function"){this["on"+e](t)}};p.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)};p.prototype.getConfiguration=function(){return this._config};p.prototype.getLocalStreams=function(){return this.localStreams};p.prototype.getRemoteStreams=function(){return this.remoteStreams};p.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0;var n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:true};if(this.usingBundle&&r){n.iceTransport=this.transceivers[0].iceTransport;n.dtlsTransport=this.transceivers[0].dtlsTransport}else{var i=this._createIceAndDtlsTransports();n.iceTransport=i.iceTransport;n.dtlsTransport=i.dtlsTransport}if(!t){this.transceivers.push(n)}return n};p.prototype.addTrack=function(t,r){if(this._isClosed){throw f("InvalidStateError","Attempted to call addTrack on a closed peerconnection.")}var n=this.transceivers.find(function(e){return e.track===t});if(n){throw f("InvalidAccessError","Track already exists.")}var i;for(var a=0;a<this.transceivers.length;a++){if(!this.transceivers[a].track&&this.transceivers[a].kind===t.kind){i=this.transceivers[a]}}if(!i){i=this._createTransceiver(t.kind)}this._maybeFireNegotiationNeeded();if(this.localStreams.indexOf(r)===-1){this.localStreams.push(r)}i.track=t;i.stream=r;i.rtpSender=new e.RTCRtpSender(t,i.dtlsTransport);return i.rtpSender};p.prototype.addStream=function(e){var r=this;if(t>=15025){e.getTracks().forEach(function(t){r.addTrack(t,e)})}else{var n=e.clone();e.getTracks().forEach(function(e,t){var r=n.getTracks()[t];e.addEventListener("enabled",function(e){r.enabled=e.enabled})});n.getTracks().forEach(function(e){r.addTrack(e,n)})}};p.prototype.removeTrack=function(t){if(this._isClosed){throw f("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.")}if(!(t instanceof e.RTCRtpSender)){throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack "+"does not implement interface RTCRtpSender.")}var r=this.transceivers.find(function(e){return e.rtpSender===t});if(!r){throw f("InvalidAccessError","Sender was not created by this connection.")}var n=r.stream;r.rtpSender.stop();r.rtpSender=null;r.track=null;r.stream=null;var i=this.transceivers.map(function(e){return e.stream});if(i.indexOf(n)===-1&&this.localStreams.indexOf(n)>-1){this.localStreams.splice(this.localStreams.indexOf(n),1)}this._maybeFireNegotiationNeeded()};p.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(e){var r=t.getSenders().find(function(t){return t.track===e});if(r){t.removeTrack(r)}})};p.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})};p.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})};p.prototype._createIceGatherer=function(t,r){var n=this;if(r&&t>0){return this.transceivers[0].iceGatherer}else if(this._iceGatherers.length){return this._iceGatherers.shift()}var i=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});Object.defineProperty(i,"state",{value:"new",writable:true});this.transceivers[t].bufferedCandidateEvents=[];this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||Object.keys(e.candidate).length===0;i.state=r?"completed":"gathering";if(n.transceivers[t].bufferedCandidateEvents!==null){n.transceivers[t].bufferedCandidateEvents.push(e)}};i.addEventListener("localcandidate",this.transceivers[t].bufferCandidates);return i};p.prototype._gather=function(t,r){var i=this;var a=this.transceivers[r].iceGatherer;if(a.onlocalcandidate){return}var o=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null;a.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates);a.onlocalcandidate=function(e){if(i.usingBundle&&r>0){return}var o=new Event("icecandidate");o.candidate={sdpMid:t,sdpMLineIndex:r};var s=e.candidate;var c=!s||Object.keys(s).length===0;if(c){if(a.state==="new"||a.state==="gathering"){a.state="completed"}}else{if(a.state==="new"){a.state="gathering"}s.component=1;s.ufrag=a.getLocalParameters().usernameFragment;var d=n.writeCandidate(s);o.candidate=Object.assign(o.candidate,n.parseCandidate(d));o.candidate.candidate=d;o.candidate.toJSON=function(){return{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex,usernameFragment:o.candidate.usernameFragment}}}var f=n.getMediaSections(i._localDescription.sdp);if(!c){f[o.candidate.sdpMLineIndex]+="a="+o.candidate.candidate+"\r\n"}else{f[o.candidate.sdpMLineIndex]+="a=end-of-candidates\r\n"}i._localDescription.sdp=n.getDescription(i._localDescription.sdp)+f.join("");var u=i.transceivers.every(function(e){return e.iceGatherer&&e.iceGatherer.state==="completed"});if(i.iceGatheringState!=="gathering"){i.iceGatheringState="gathering";i._emitGatheringStateChange()}if(!c){i._dispatchEvent("icecandidate",o)}if(u){i._dispatchEvent("icecandidate",new Event("icecandidate"));i.iceGatheringState="complete";i._emitGatheringStateChange()}};e.setTimeout(function(){o.forEach(function(e){a.onlocalcandidate(e)})},0)};p.prototype._createIceAndDtlsTransports=function(){var t=this;var r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState();t._updateConnectionState()};var n=new e.RTCDtlsTransport(r);n.ondtlsstatechange=function(){t._updateConnectionState()};n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:true});t._updateConnectionState()};return{iceTransport:r,dtlsTransport:n}};p.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;if(t){delete t.onlocalcandidate;delete this.transceivers[e].iceGatherer}var r=this.transceivers[e].iceTransport;if(r){delete r.onicestatechange;delete this.transceivers[e].iceTransport}var n=this.transceivers[e].dtlsTransport;if(n){delete n.ondtlsstatechange;delete n.onerror;delete this.transceivers[e].dtlsTransport}};p.prototype._transceive=function(e,r,i){var a=s(e.localCapabilities,e.remoteCapabilities);if(r&&e.rtpSender){a.encodings=e.sendEncodingParameters;a.rtcp={cname:n.localCName,compound:e.rtcpParameters.compound};if(e.recvEncodingParameters.length){a.rtcp.ssrc=e.recvEncodingParameters[0].ssrc}e.rtpSender.send(a)}if(i&&e.rtpReceiver&&a.codecs.length>0){if(e.kind==="video"&&e.recvEncodingParameters&&t<15019){e.recvEncodingParameters.forEach(function(e){delete e.rtx})}if(e.recvEncodingParameters.length){a.encodings=e.recvEncodingParameters}else{a.encodings=[{}]}a.rtcp={compound:e.rtcpParameters.compound};if(e.rtcpParameters.cname){a.rtcp.cname=e.rtcpParameters.cname}if(e.sendEncodingParameters.length){a.rtcp.ssrc=e.sendEncodingParameters[0].ssrc}e.rtpReceiver.receive(a)}};p.prototype.setLocalDescription=function(e){var t=this;if(["offer","answer"].indexOf(e.type)===-1){return Promise.reject(f("TypeError",'Unsupported type "'+e.type+'"'))}if(!c("setLocalDescription",e.type,t.signalingState)||t._isClosed){return Promise.reject(f("InvalidStateError","Can not set local "+e.type+" in state "+t.signalingState))}var r;var i;if(e.type==="offer"){r=n.splitSections(e.sdp);i=r.shift();r.forEach(function(e,r){var i=n.parseRtpParameters(e);t.transceivers[r].localCapabilities=i});t.transceivers.forEach(function(e,r){t._gather(e.mid,r)})}else if(e.type==="answer"){r=n.splitSections(t._remoteDescription.sdp);i=r.shift();var a=n.matchPrefix(i,"a=ice-lite").length>0;r.forEach(function(e,r){var o=t.transceivers[r];var c=o.iceGatherer;var d=o.iceTransport;var f=o.dtlsTransport;var u=o.localCapabilities;var l=o.remoteCapabilities;var p=n.isRejected(e)&&n.matchPrefix(e,"a=bundle-only").length===0;if(!p&&!o.rejected){var m=n.getIceParameters(e,i);var v=n.getDtlsParameters(e,i);if(a){v.role="server"}if(!t.usingBundle||r===0){t._gather(o.mid,r);if(d.state==="new"){d.start(c,m,a?"controlling":"controlled")}if(f.state==="new"){f.start(v)}}var h=s(u,l);t._transceive(o,h.codecs.length>0,false)}})}t._localDescription={type:e.type,sdp:e.sdp};if(e.type==="offer"){t._updateSignalingState("have-local-offer")}else{t._updateSignalingState("stable")}return Promise.resolve()};p.prototype.setRemoteDescription=function(i){var a=this;if(["offer","answer"].indexOf(i.type)===-1){return Promise.reject(f("TypeError",'Unsupported type "'+i.type+'"'))}if(!c("setRemoteDescription",i.type,a.signalingState)||a._isClosed){return Promise.reject(f("InvalidStateError","Can not set remote "+i.type+" in state "+a.signalingState))}var o={};a.remoteStreams.forEach(function(e){o[e.id]=e});var p=[];var m=n.splitSections(i.sdp);var v=m.shift();var h=n.matchPrefix(v,"a=ice-lite").length>0;var g=n.matchPrefix(v,"a=group:BUNDLE ").length>0;a.usingBundle=g;var y=n.matchPrefix(v,"a=ice-options:")[0];if(y){a.canTrickleIceCandidates=y.substr(14).split(" ").indexOf("trickle")>=0}else{a.canTrickleIceCandidates=false}m.forEach(function(c,f){var l=n.splitLines(c);var m=n.getKind(c);var y=n.isRejected(c)&&n.matchPrefix(c,"a=bundle-only").length===0;var C=l[0].substr(2).split(" ")[2];var S=n.getDirection(c,v);var R=n.parseMsid(c);var E=n.getMid(c)||n.generateIdentifier();if(y||m==="application"&&(C==="DTLS/SCTP"||C==="UDP/DTLS/SCTP")){a.transceivers[f]={mid:E,kind:m,protocol:C,rejected:true};return}if(!y&&a.transceivers[f]&&a.transceivers[f].rejected){a.transceivers[f]=a._createTransceiver(m,true)}var T;var b;var w;var P;var _;var k;var D;var O;var I;var M=n.parseRtpParameters(c);var L;var A;if(!y){L=n.getIceParameters(c,v);A=n.getDtlsParameters(c,v);A.role="client"}D=n.parseRtpEncodingParameters(c);var x=n.parseRtcpParameters(c);var N=n.matchPrefix(c,"a=end-of-candidates",v).length>0;var j=n.matchPrefix(c,"a=candidate:").map(function(e){return n.parseCandidate(e)}).filter(function(e){return e.component===1});if((i.type==="offer"||i.type==="answer")&&!y&&g&&f>0&&a.transceivers[f]){a._disposeIceAndDtlsTransports(f);a.transceivers[f].iceGatherer=a.transceivers[0].iceGatherer;a.transceivers[f].iceTransport=a.transceivers[0].iceTransport;a.transceivers[f].dtlsTransport=a.transceivers[0].dtlsTransport;if(a.transceivers[f].rtpSender){a.transceivers[f].rtpSender.setTransport(a.transceivers[0].dtlsTransport)}if(a.transceivers[f].rtpReceiver){a.transceivers[f].rtpReceiver.setTransport(a.transceivers[0].dtlsTransport)}}if(i.type==="offer"&&!y){T=a.transceivers[f]||a._createTransceiver(m);T.mid=E;if(!T.iceGatherer){T.iceGatherer=a._createIceGatherer(f,g)}if(j.length&&T.iceTransport.state==="new"){if(N&&(!g||f===0)){T.iceTransport.setRemoteCandidates(j)}else{j.forEach(function(e){d(T.iceTransport,e)})}}O=e.RTCRtpReceiver.getCapabilities(m);if(t<15019){O.codecs=O.codecs.filter(function(e){return e.name!=="rtx"})}k=T.sendEncodingParameters||[{ssrc:(2*f+2)*1001}];var V=false;if(S==="sendrecv"||S==="sendonly"){V=!T.rtpReceiver;_=T.rtpReceiver||new e.RTCRtpReceiver(T.dtlsTransport,m);if(V){var F;I=_.track;if(R&&R.stream==="-"){}else if(R){if(!o[R.stream]){o[R.stream]=new e.MediaStream;Object.defineProperty(o[R.stream],"id",{get:function e(){return R.stream}})}Object.defineProperty(I,"id",{get:function e(){return R.track}});F=o[R.stream]}else{if(!o.default){o.default=new e.MediaStream}F=o.default}if(F){r(I,F);T.associatedRemoteMediaStreams.push(F)}p.push([I,_,F])}}else if(T.rtpReceiver&&T.rtpReceiver.track){T.associatedRemoteMediaStreams.forEach(function(e){var t=e.getTracks().find(function(e){return e.id===T.rtpReceiver.track.id});if(t){u(t,e)}});T.associatedRemoteMediaStreams=[]}T.localCapabilities=O;T.remoteCapabilities=M;T.rtpReceiver=_;T.rtcpParameters=x;T.sendEncodingParameters=k;T.recvEncodingParameters=D;a._transceive(a.transceivers[f],false,V)}else if(i.type==="answer"&&!y){T=a.transceivers[f];b=T.iceGatherer;w=T.iceTransport;P=T.dtlsTransport;_=T.rtpReceiver;k=T.sendEncodingParameters;O=T.localCapabilities;a.transceivers[f].recvEncodingParameters=D;a.transceivers[f].remoteCapabilities=M;a.transceivers[f].rtcpParameters=x;if(j.length&&w.state==="new"){if((h||N)&&(!g||f===0)){w.setRemoteCandidates(j)}else{j.forEach(function(e){d(T.iceTransport,e)})}}if(!g||f===0){if(w.state==="new"){w.start(b,L,"controlling")}if(P.state==="new"){P.start(A)}}var G=s(T.localCapabilities,T.remoteCapabilities);var U=G.codecs.filter(function(e){return e.name.toLowerCase()==="rtx"}).length;if(!U&&T.sendEncodingParameters[0].rtx){delete T.sendEncodingParameters[0].rtx}a._transceive(T,S==="sendrecv"||S==="recvonly",S==="sendrecv"||S==="sendonly");if(_&&(S==="sendrecv"||S==="sendonly")){I=_.track;if(R){if(!o[R.stream]){o[R.stream]=new e.MediaStream}r(I,o[R.stream]);p.push([I,_,o[R.stream]])}else{if(!o.default){o.default=new e.MediaStream}r(I,o.default);p.push([I,_,o.default])}}else{delete T.rtpReceiver}}});if(a._dtlsRole===undefined){a._dtlsRole=i.type==="offer"?"active":"passive"}a._remoteDescription={type:i.type,sdp:i.sdp};if(i.type==="offer"){a._updateSignalingState("have-remote-offer")}else{a._updateSignalingState("stable")}Object.keys(o).forEach(function(t){var r=o[t];if(r.getTracks().length){if(a.remoteStreams.indexOf(r)===-1){a.remoteStreams.push(r);var n=new Event("addstream");n.stream=r;e.setTimeout(function(){a._dispatchEvent("addstream",n)})}p.forEach(function(e){var t=e[0];var n=e[1];if(r.id!==e[2].id){return}l(a,t,n,[r])})}});p.forEach(function(e){if(e[2]){return}l(a,e[0],e[1],[])});e.setTimeout(function(){if(!(a&&a.transceivers)){return}a.transceivers.forEach(function(e){if(e.iceTransport&&e.iceTransport.state==="new"&&e.iceTransport.getRemoteCandidates().length>0){console.warn("Timeout for addRemoteCandidate. Consider sending "+"an end-of-candidates notification");e.iceTransport.addRemoteCandidate({})}})},4e3);return Promise.resolve()};p.prototype.close=function(){this.transceivers.forEach(function(e){if(e.iceTransport){e.iceTransport.stop()}if(e.dtlsTransport){e.dtlsTransport.stop()}if(e.rtpSender){e.rtpSender.stop()}if(e.rtpReceiver){e.rtpReceiver.stop()}});this._isClosed=true;this._updateSignalingState("closed")};p.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)};p.prototype._maybeFireNegotiationNeeded=function(){var t=this;if(this.signalingState!=="stable"||this.needNegotiation===true){return}this.needNegotiation=true;e.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=false;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}},0)};p.prototype._updateIceConnectionState=function(){var e;var t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(e){if(e.iceTransport&&!e.rejected){t[e.iceTransport.state]++}});e="new";if(t.failed>0){e="failed"}else if(t.checking>0){e="checking"}else if(t.disconnected>0){e="disconnected"}else if(t.new>0){e="new"}else if(t.connected>0){e="connected"}else if(t.completed>0){e="completed"}if(e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}};p.prototype._updateConnectionState=function(){var e;var t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(e){if(e.iceTransport&&e.dtlsTransport&&!e.rejected){t[e.iceTransport.state]++;t[e.dtlsTransport.state]++}});t.connected+=t.completed;e="new";if(t.failed>0){e="failed"}else if(t.connecting>0){e="connecting"}else if(t.disconnected>0){e="disconnected"}else if(t.new>0){e="new"}else if(t.connected>0){e="connected"}if(e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r)}};p.prototype.createOffer=function(){var r=this;if(r._isClosed){return Promise.reject(f("InvalidStateError","Can not call createOffer after close"))}var i=r.transceivers.filter(function(e){return e.kind==="audio"}).length;var o=r.transceivers.filter(function(e){return e.kind==="video"}).length;var s=arguments[0];if(s){if(s.mandatory||s.optional){throw new TypeError("Legacy mandatory/optional constraints not supported.")}if(s.offerToReceiveAudio!==undefined){if(s.offerToReceiveAudio===true){i=1}else if(s.offerToReceiveAudio===false){i=0}else{i=s.offerToReceiveAudio}}if(s.offerToReceiveVideo!==undefined){if(s.offerToReceiveVideo===true){o=1}else if(s.offerToReceiveVideo===false){o=0}else{o=s.offerToReceiveVideo}}}r.transceivers.forEach(function(e){if(e.kind==="audio"){i--;if(i<0){e.wantReceive=false}}else if(e.kind==="video"){o--;if(o<0){e.wantReceive=false}}});while(i>0||o>0){if(i>0){r._createTransceiver("audio");i--}if(o>0){r._createTransceiver("video");o--}}var c=n.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach(function(i,a){var o=i.track;var s=i.kind;var c=i.mid||n.generateIdentifier();i.mid=c;if(!i.iceGatherer){i.iceGatherer=r._createIceGatherer(a,r.usingBundle)}var d=e.RTCRtpSender.getCapabilities(s);if(t<15019){d.codecs=d.codecs.filter(function(e){return e.name!=="rtx"})}d.codecs.forEach(function(e){if(e.name==="H264"&&e.parameters["level-asymmetry-allowed"]===undefined){e.parameters["level-asymmetry-allowed"]="1"}if(i.remoteCapabilities&&i.remoteCapabilities.codecs){i.remoteCapabilities.codecs.forEach(function(t){if(e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate){e.preferredPayloadType=t.payloadType}})}});d.headerExtensions.forEach(function(e){var t=i.remoteCapabilities&&i.remoteCapabilities.headerExtensions||[];t.forEach(function(t){if(e.uri===t.uri){e.id=t.id}})});var f=i.sendEncodingParameters||[{ssrc:(2*a+1)*1001}];if(o){if(t>=15019&&s==="video"&&!f[0].rtx){f[0].rtx={ssrc:f[0].ssrc+1}}}if(i.wantReceive){i.rtpReceiver=new e.RTCRtpReceiver(i.dtlsTransport,s)}i.localCapabilities=d;i.sendEncodingParameters=f});if(r._config.bundlePolicy!=="max-compat"){c+="a=group:BUNDLE "+r.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"}c+="a=ice-options:trickle\r\n";r.transceivers.forEach(function(e,t){c+=a(e,e.localCapabilities,"offer",e.stream,r._dtlsRole);c+="a=rtcp-rsize\r\n";if(e.iceGatherer&&r.iceGatheringState!=="new"&&(t===0||!r.usingBundle)){e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1;c+="a="+n.writeCandidate(e)+"\r\n"});if(e.iceGatherer.state==="completed"){c+="a=end-of-candidates\r\n"}}});var d=new e.RTCSessionDescription({type:"offer",sdp:c});return Promise.resolve(d)};p.prototype.createAnswer=function(){var r=this;if(r._isClosed){return Promise.reject(f("InvalidStateError","Can not call createAnswer after close"))}if(!(r.signalingState==="have-remote-offer"||r.signalingState==="have-local-pranswer")){return Promise.reject(f("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState))}var i=n.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);if(r.usingBundle){i+="a=group:BUNDLE "+r.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"}i+="a=ice-options:trickle\r\n";var o=n.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach(function(e,n){if(n+1>o){return}if(e.rejected){if(e.kind==="application"){if(e.protocol==="DTLS/SCTP"){i+="m=application 0 DTLS/SCTP 5000\r\n"}else{i+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n"}}else if(e.kind==="audio"){i+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\n"+"a=rtpmap:0 PCMU/8000\r\n"}else if(e.kind==="video"){i+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\n"+"a=rtpmap:120 VP8/90000\r\n"}i+="c=IN IP4 0.0.0.0\r\n"+"a=inactive\r\n"+"a=mid:"+e.mid+"\r\n";return}if(e.stream){var c;if(e.kind==="audio"){c=e.stream.getAudioTracks()[0]}else if(e.kind==="video"){c=e.stream.getVideoTracks()[0]}if(c){if(t>=15019&&e.kind==="video"&&!e.sendEncodingParameters[0].rtx){e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}}}}var d=s(e.localCapabilities,e.remoteCapabilities);var f=d.codecs.filter(function(e){return e.name.toLowerCase()==="rtx"}).length;if(!f&&e.sendEncodingParameters[0].rtx){delete e.sendEncodingParameters[0].rtx}i+=a(e,d,"answer",e.stream,r._dtlsRole);if(e.rtcpParameters&&e.rtcpParameters.reducedSize){i+="a=rtcp-rsize\r\n"}});var c=new e.RTCSessionDescription({type:"answer",sdp:i});return Promise.resolve(c)};p.prototype.addIceCandidate=function(e){var t=this;var r;if(e&&!(e.sdpMLineIndex!==undefined||e.sdpMid)){return Promise.reject(new TypeError("sdpMLineIndex or sdpMid required"))}return new Promise(function(i,a){if(!t._remoteDescription){return a(f("InvalidStateError","Can not add ICE candidate without a remote description"))}else if(!e||e.candidate===""){for(var o=0;o<t.transceivers.length;o++){if(t.transceivers[o].rejected){continue}t.transceivers[o].iceTransport.addRemoteCandidate({});r=n.getMediaSections(t._remoteDescription.sdp);r[o]+="a=end-of-candidates\r\n";t._remoteDescription.sdp=n.getDescription(t._remoteDescription.sdp)+r.join("");if(t.usingBundle){break}}}else{var s=e.sdpMLineIndex;if(e.sdpMid){for(var c=0;c<t.transceivers.length;c++){if(t.transceivers[c].mid===e.sdpMid){s=c;break}}}var u=t.transceivers[s];if(u){if(u.rejected){return i()}var l=Object.keys(e.candidate).length>0?n.parseCandidate(e.candidate):{};if(l.protocol==="tcp"&&(l.port===0||l.port===9)){return i()}if(l.component&&l.component!==1){return i()}if(s===0||s>0&&u.iceTransport!==t.transceivers[0].iceTransport){if(!d(u.iceTransport,l)){return a(f("OperationError","Can not add ICE candidate"))}}var p=e.candidate.trim();if(p.indexOf("a=")===0){p=p.substr(2)}r=n.getMediaSections(t._remoteDescription.sdp);r[s]+="a="+(l.type?p:"end-of-candidates")+"\r\n";t._remoteDescription.sdp=n.getDescription(t._remoteDescription.sdp)+r.join("")}else{return a(f("OperationError","Can not add ICE candidate"))}}i()})};p.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;this.transceivers.forEach(function(e){if(e.rtpSender&&e.rtpSender.track===t){r=e.rtpSender}else if(e.rtpReceiver&&e.rtpReceiver.track===t){r=e.rtpReceiver}});if(!r){throw f("InvalidAccessError","Invalid selector.")}return r.getStats()}var n=[];this.transceivers.forEach(function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(t){if(e[t]){n.push(e[t].getStats())}})});return Promise.all(n).then(function(e){var t=new Map;e.forEach(function(e){e.forEach(function(e){t.set(e.id,e)})});return t})};var m=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];m.forEach(function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var n=r.prototype.getStats;r.prototype.getStats=function(){return n.apply(this).then(function(e){var t=new Map;Object.keys(e).forEach(function(r){e[r].type=i(e[r]);t.set(r,e[r])});return t})}}});var v=["createOffer","createAnswer"];v.forEach(function(e){var t=p.prototype[e];p.prototype[e]=function(){var e=arguments;if(typeof e[0]==="function"||typeof e[1]==="function"){return t.apply(this,[arguments[2]]).then(function(t){if(typeof e[0]==="function"){e[0].apply(null,[t])}},function(t){if(typeof e[1]==="function"){e[1].apply(null,[t])}})}return t.apply(this,arguments)}});v=["setLocalDescription","setRemoteDescription","addIceCandidate"];v.forEach(function(e){var t=p.prototype[e];p.prototype[e]=function(){var e=arguments;if(typeof e[1]==="function"||typeof e[2]==="function"){return t.apply(this,arguments).then(function(){if(typeof e[1]==="function"){e[1].apply(null)}},function(t){if(typeof e[2]==="function"){e[2].apply(null,[t])}})}return t.apply(this,arguments)}});["getStats"].forEach(function(e){var t=p.prototype[e];p.prototype[e]=function(){var e=arguments;if(typeof e[1]==="function"){return t.apply(this,arguments).then(function(){if(typeof e[1]==="function"){e[1].apply(null)}})}return t.apply(this,arguments)}});return p}},{sdp:17}],17:[function(e,t,r){var n={};n.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)};n.localCName=n.generateIdentifier();n.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})};n.splitSections=function(e){var t=e.split("\nm=");return t.map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})};n.getDescription=function(e){var t=n.splitSections(e);return t&&t[0]};n.getMediaSections=function(e){var t=n.splitSections(e);t.shift();return t};n.matchPrefix=function(e,t){return n.splitLines(e).filter(function(e){return e.indexOf(t)===0})};n.parseCandidate=function(e){var t;if(e.indexOf("a=candidate:")===0){t=e.substring(12).split(" ")}else{t=e.substring(10).split(" ")}var r={foundation:t[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(var n=8;n<t.length;n+=2){switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1];r.usernameFragment=t[n+1];break;default:r[t[n]]=t[n+1];break}}return r};n.writeCandidate=function(e){var t=[];t.push(e.foundation);t.push(e.component);t.push(e.protocol.toUpperCase());t.push(e.priority);t.push(e.address||e.ip);t.push(e.port);var r=e.type;t.push("typ");t.push(r);if(r!=="host"&&e.relatedAddress&&e.relatedPort){t.push("raddr");t.push(e.relatedAddress);t.push("rport");t.push(e.relatedPort)}if(e.tcpType&&e.protocol.toLowerCase()==="tcp"){t.push("tcptype");t.push(e.tcpType)}if(e.usernameFragment||e.ufrag){t.push("ufrag");t.push(e.usernameFragment||e.ufrag)}return"candidate:"+t.join(" ")};n.parseIceOptions=function(e){return e.substr(14).split(" ")};n.parseRtpMap=function(e){var t=e.substr(9).split(" ");var r={payloadType:parseInt(t.shift(),10)};t=t[0].split("/");r.name=t[0];r.clockRate=parseInt(t[1],10);r.channels=t.length===3?parseInt(t[2],10):1;r.numChannels=r.channels;return r};n.writeRtpMap=function(e){var t=e.payloadType;if(e.preferredPayloadType!==undefined){t=e.preferredPayloadType}var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(r!==1?"/"+r:"")+"\r\n"};n.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}};n.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&e.direction!=="sendrecv"?"/"+e.direction:"")+" "+e.uri+"\r\n"};n.parseFmtp=function(e){var t={};var r;var n=e.substr(e.indexOf(" ")+1).split(";");for(var i=0;i<n.length;i++){r=n[i].trim().split("=");t[r[0].trim()]=r[1]}return t};n.writeFmtp=function(e){var t="";var r=e.payloadType;if(e.preferredPayloadType!==undefined){r=e.preferredPayloadType}if(e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach(function(t){if(e.parameters[t]){n.push(t+"="+e.parameters[t])}else{n.push(t)}});t+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return t};n.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}};n.writeRtcpFb=function(e){var t="";var r=e.payloadType;if(e.preferredPayloadType!==undefined){r=e.preferredPayloadType}if(e.rtcpFeedback&&e.rtcpFeedback.length){e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})}return t};n.parseSsrcMedia=function(e){var t=e.indexOf(" ");var r={ssrc:parseInt(e.substr(7,t-7),10)};var n=e.indexOf(":",t);if(n>-1){r.attribute=e.substr(t+1,n-t-1);r.value=e.substr(n+1)}else{r.attribute=e.substr(t+1)}return r};n.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}};n.getMid=function(e){var t=n.matchPrefix(e,"a=mid:")[0];if(t){return t.substr(6)}};n.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}};n.getDtlsParameters=function(e,t){var r=n.matchPrefix(e+t,"a=fingerprint:");return{role:"auto",fingerprints:r.map(n.parseFingerprint)}};n.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";e.fingerprints.forEach(function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"});return r};n.getIceParameters=function(e,t){var r=n.splitLines(e);r=r.concat(n.splitLines(t));var i={usernameFragment:r.filter(function(e){return e.indexOf("a=ice-ufrag:")===0})[0].substr(12),password:r.filter(function(e){return e.indexOf("a=ice-pwd:")===0})[0].substr(10)};return i};n.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\n"+"a=ice-pwd:"+e.password+"\r\n"};n.parseRtpParameters=function(e){var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]};var r=n.splitLines(e);var i=r[0].split(" ");for(var a=3;a<i.length;a++){var o=i[a];var s=n.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(s){var c=n.parseRtpMap(s);var d=n.matchPrefix(e,"a=fmtp:"+o+" ");c.parameters=d.length?n.parseFmtp(d[0]):{};c.rtcpFeedback=n.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(n.parseRtcpFb);t.codecs.push(c);switch(c.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(c.name.toUpperCase());break;default:break}}}n.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(n.parseExtmap(e))});return t};n.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ";r+=t.codecs.length>0?"9":"0";r+=" UDP/TLS/RTP/SAVPF ";r+=t.codecs.map(function(e){if(e.preferredPayloadType!==undefined){return e.preferredPayloadType}return e.payloadType}).join(" ")+"\r\n";r+="c=IN IP4 0.0.0.0\r\n";r+="a=rtcp:9 IN IP4 0.0.0.0\r\n";t.codecs.forEach(function(e){r+=n.writeRtpMap(e);r+=n.writeFmtp(e);r+=n.writeRtcpFb(e)});var i=0;t.codecs.forEach(function(e){if(e.maxptime>i){i=e.maxptime}});if(i>0){r+="a=maxptime:"+i+"\r\n"}r+="a=rtcp-mux\r\n";if(t.headerExtensions){t.headerExtensions.forEach(function(e){r+=n.writeExtmap(e)})}return r};n.parseRtpEncodingParameters=function(e){var t=[];var r=n.parseRtpParameters(e);var i=r.fecMechanisms.indexOf("RED")!==-1;var a=r.fecMechanisms.indexOf("ULPFEC")!==-1;var o=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return e.attribute==="cname"});var s=o.length>0&&o[0].ssrc;var c;var d=n.matchPrefix(e,"a=ssrc-group:FID").map(function(e){var t=e.substr(17).split(" ");return t.map(function(e){return parseInt(e,10)})});if(d.length>0&&d[0].length>1&&d[0][0]===s){c=d[0][1]}r.codecs.forEach(function(e){if(e.name.toUpperCase()==="RTX"&&e.parameters.apt){var r={ssrc:s,codecPayloadType:parseInt(e.parameters.apt,10)};if(s&&c){r.rtx={ssrc:c}}t.push(r);if(i){r=JSON.parse(JSON.stringify(r));r.fec={ssrc:s,mechanism:a?"red+ulpfec":"red"};t.push(r)}}});if(t.length===0&&s){t.push({ssrc:s})}var f=n.matchPrefix(e,"b=");if(f.length){if(f[0].indexOf("b=TIAS:")===0){f=parseInt(f[0].substr(7),10)}else if(f[0].indexOf("b=AS:")===0){f=parseInt(f[0].substr(5),10)*1e3*.95-50*40*8}else{f=undefined}t.forEach(function(e){e.maxBitrate=f})}return t};n.parseRtcpParameters=function(e){var t={};var r=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return e.attribute==="cname"})[0];if(r){t.cname=r.value;t.ssrc=r.ssrc}var i=n.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=i.length>0;t.compound=i.length===0;var a=n.matchPrefix(e,"a=rtcp-mux");t.mux=a.length>0;return t};n.parseMsid=function(e){var t;var r=n.matchPrefix(e,"a=msid:");if(r.length===1){t=r[0].substr(7).split(" ");return{stream:t[0],track:t[1]}}var i=n.matchPrefix(e,"a=ssrc:").map(function(e){return n.parseSsrcMedia(e)}).filter(function(e){return e.attribute==="msid"});if(i.length>0){t=i[0].value.split(" ");return{stream:t[0],track:t[1]}}};n.parseSctpDescription=function(e){var t=n.parseMLine(e);var r=n.matchPrefix(e,"a=max-message-size:");var i;if(r.length>0){i=parseInt(r[0].substr(19),10)}if(isNaN(i)){i=65536}var a=n.matchPrefix(e,"a=sctp-port:");if(a.length>0){return{port:parseInt(a[0].substr(12),10),protocol:t.fmt,maxMessageSize:i}}var o=n.matchPrefix(e,"a=sctpmap:");if(o.length>0){var s=n.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(s[0],10),protocol:s[1],maxMessageSize:i}}};n.writeSctpDescription=function(e,t){var r=[];if(e.protocol!=="DTLS/SCTP"){r=["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]}else{r=["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"]}if(t.maxMessageSize!==undefined){r.push("a=max-message-size:"+t.maxMessageSize+"\r\n")}return r.join("")};n.generateSessionId=function(){return Math.random().toString().substr(2,21)};n.writeSessionBoilerplate=function(e,t,r){var i;var a=t!==undefined?t:2;if(e){i=e}else{i=n.generateSessionId()}var o=r||"thisisadapterortc";return"v=0\r\n"+"o="+o+" "+i+" "+a+" IN IP4 127.0.0.1\r\n"+"s=-\r\n"+"t=0 0\r\n"};n.writeMediaSection=function(e,t,r,i){var a=n.writeRtpDescription(e.kind,t);a+=n.writeIceParameters(e.iceGatherer.getLocalParameters());a+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),r==="offer"?"actpass":"active");a+="a=mid:"+e.mid+"\r\n";if(e.direction){a+="a="+e.direction+"\r\n"}else if(e.rtpSender&&e.rtpReceiver){a+="a=sendrecv\r\n"}else if(e.rtpSender){a+="a=sendonly\r\n"}else if(e.rtpReceiver){a+="a=recvonly\r\n"}else{a+="a=inactive\r\n"}if(e.rtpSender){var o="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";a+="a="+o;a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o;if(e.sendEncodingParameters[0].rtx){a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o;a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n";if(e.rtpSender&&e.sendEncodingParameters[0].rtx){a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"}return a};n.getDirection=function(e,t){var r=n.splitLines(e);for(var i=0;i<r.length;i++){switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substr(2);default:}}if(t){return n.getDirection(t)}return"sendrecv"};n.getKind=function(e){var t=n.splitLines(e);var r=t[0].split(" ");return r[0].substr(2)};n.isRejected=function(e){return e.split(" ",2)[1]==="0"};n.parseMLine=function(e){var t=n.splitLines(e);var r=t[0].substr(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}};n.parseOLine=function(e){var t=n.matchPrefix(e,"o=")[0];var r=t.substr(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}};n.isValidSDP=function(e){if(typeof e!=="string"||e.length===0){return false}var t=n.splitLines(e);for(var r=0;r<t.length;r++){if(t[r].length<2||t[r].charAt(1)!=="="){return false}}return true};if(typeof t==="object"){t.exports=n}},{}]},{},[1])(1)});(function(e,t){if(typeof define==="function"&&define.amd){define("easyrtc",["easyrtc_lang","webrtc-adapter","socket.io"],t)}else if(typeof module==="object"&&module.exports){module.exports=t(require("easyrtc_lang"),require("webrtc-adapter"),require("socket.io"))}else{if(typeof window.io==="undefined"||!window.io){throw new Error("easyrtc requires socket.io")}e.easyrtc=t(window.easyrtc_lang,window.adapter,window.io)}})(this,function(e,t,r,n){var i=function i(){var a=this;var o={};var s=null;var c=0;var d=0;function f(){if(!c){return}if(s){clearTimeout(s)}if(d===1){a.showError(a.errCodes.SYSTEM_ERR,"Timed out trying to talk to the server.");a.printpeerconns();a.hangupAll();a.disconnect();return}s=setTimeout(f,20*1e3);d++;pe(null,"stillAlive",{},function(e,t){d=0},function(){})}function u(e,t){if(a.debugPrinter){a.debugPrinter(e,t)}}function l(e){if(e===null||e===n){return true}var t;for(t in e){if(e.hasOwnProperty(t)){return false}}return true}var p=true;var m=null;var v=null;var h=null;var g=null;var y=null;var C={"connect timeout":1e4,"force new connection":true};function S(e){var t;var r;r=e.getAudioTracks();for(t=0;t<r.length;t++){try{r[t].stop()}catch(n){}}r=e.getVideoTracks();for(t=0;t<r.length;t++){try{r[t].stop()}catch(n){}}if(typeof e.stop==="function"){try{e.stop()}catch(n){}}}this.setSdpFilters=function(e,t){m=e;v=t};this.setPeerClosedListener=function(e){this.onPeerClosed=e};this.setPeerOpenListener=function(e){this.onPeerOpen=e};this.setPeerFailingListener=function(e,t){this.onPeerFailing=e;this.onPeerRecovered=t};this.setIceCandidateFilter=function(e){h=e};this.setIceConnectionStateChangeListener=function(e){g=e};this.setSignalingStateChangeListener=function(e){y=e};this.setAutoInitUserMedia=function(e){p=!!e};this.format=function(e,t,r,n){var i=arguments[0];for(var a=1;a<arguments.length;a++){var o=new RegExp("\\{"+(a-1)+"\\}","gi");i=i.replace(o,arguments[a])}return i};function R(e,t){if(t.addStream){var r=t.getLocalStreams();if(r.indexOf(e)===-1){t.addStream(e)}}else{var n=t.getSenders();var i=e.getAudioTracks();var a;for(a=0;a<i.length;a++){if(n.indexOf(i[a])===-1){t.addTrack(i[a])}}i=e.getVideoTracks();for(a=0;a<i.length;a++){if(n.indexOf(i[a])===-1){t.addTrack(i[a])}}}}this.renegotiate=function(e){var t=o[e];if(!t){u("Attempt to renegotiate ice on nonexistant connection");return}var r=t.callFailureCB||a.showError;var n=t.pc;var i=function i(o){if(t.cancelled){u("renegotiate.setLocalAndSendMessage0.ignored",t.cancelled,t.sendingOffer);return}var s=function n(){t.sendingOffer=false;pe(e,"offer",o,null,r)};if(m){o.sdp=m(o.sdp)}n.setLocalDescription(o).then(s,function(e){t.sendingOffer=false;r(a.errCodes.CALL_ERR,e)})};if(t.sendingOffer){u("initiateSendOffer.setLocalAndSendMessage0.ignored",t.sendingOffer);return}t.sendingOffer=true;n.createOffer({iceRestart:true}).then(i).catch(function(e){t.sendingOffer=false;r(a.errCodes.CALL_ERR,JSON.stringify(e))})};function E(e){return e&&(e.socket&&e.socket.connected||e.connected)}var T={audio:false,video:false};this.getConstantString=function(t){if(e[t]){return e[t]}else{a.showError(a.errCodes.DEVELOPER_ERR,"Could not find key='"+t+"' in easyrtc_lang");return t}};var b={roomOccupant:true,roomOccupants:true};var w={};function P(e,t){if(typeof e!=="string"){a.showError(a.errCodes.DEVELOPER_ERR,t+" called without a string as the first argument");throw"developer error"}if(!b[e]){a.showError(a.errCodes.DEVELOPER_ERR,t+" called with a bad event name = "+e);throw"developer error"}}this.addEventListener=function(e,t){P(e,"addEventListener");if(typeof t!=="function"){a.showError(a.errCodes.DEVELOPER_ERR,"addEventListener called with a non-function for second argument");throw"developer error"}a.removeEventListener(e,t);if(!w[e]){w[e]=[]}w[e][w[e].length]=t};this.removeEventListener=function(e,t){P(e,"removeEventListener");var r=w[e];var n=0;if(r){for(n=0;n<r.length;n++){if(r[n]===t){if(n<r.length-1){r[n]=r[r.length-1]}r.length=r.length-1}}}};this.emitEvent=function(e,t){P(e,"emitEvent");var r=w[e];var n=0;if(r){for(n=0;n<r.length;n++){r[n](e,t)}}};this.errCodes={BAD_NAME:"BAD_NAME",CALL_ERR:"CALL_ERR",DEVELOPER_ERR:"DEVELOPER_ERR",SYSTEM_ERR:"SYSTEM_ERR",CONNECT_ERR:"CONNECT_ERR",MEDIA_ERR:"MEDIA_ERR",MEDIA_WARNING:"MEDIA_WARNING",INTERNAL_ERR:"INTERNAL_ERR",PEER_GONE:"PEER_GONE",ALREADY_CONNECTED:"ALREADY_CONNECTED",BAD_CREDENTIAL:"BAD_CREDENTIAL",ICECANDIDATE_ERR:"ICECANDIDATE_ERR",NOVIABLEICE:"NOVIABLEICE",SIGNAL_ERR:"SIGNAL_ERR"};this.apiVersion="1.1.1-beta";this.ackMessage={msgType:"ack"};this.usernameRegExp=/^(.){1,64}$/;this.cookieId="easyrtcsid";this.username=null;this.loggingOut=false;this.disconnecting=false;var _={};var k=[];var D={};this.enableAudioReceive=function(e){if(t&&t.browserDetails&&t.browserDetails.browser==="chrome"&&t.browserDetails.version<65){D.mandatory=D.mandatory||{};D.mandatory.OfferToReceiveAudio=e}else{D.offerToReceiveAudio=e}};this.enableVideoReceive=function(e){if(t&&t.browserDetails&&t.browserDetails.browser==="chrome"&&t.browserDetails.version<65){D.mandatory=D.mandatory||{};D.mandatory.OfferToReceiveVideo=e}else{D.offerToReceiveVideo=e}};this.enableAudioReceive(true);this.enableVideoReceive(true);function O(e,t){navigator.mediaDevices.enumerateDevices().then(function(r){var n=[];for(var i=0;i<r.length;i++){var a=r[i];if(a.kind===t){if(!a.id){a.id=a.deviceId}n.push(a)}}e(n)}).catch(function(e){u("Unable to enumerate devices ("+e+")")})}this.setAudioOutput=function(e,t){if(typeof e.sinkId!=="undefined"){e.setSinkId(t).then(function(){u("Success, audio output device attached: "+t+" to "+"element with "+e.title+" as source.")}).catch(function(e){var t=e;if(e.name==="SecurityError"){t="You need to use HTTPS for selecting audio output "+"device: "+e}u(t)})}else{u("Browser does not support output device selection.")}};this.getAudioSinkList=function(e){O(e,"audiooutput")};this.getAudioSourceList=function(e){O(e,"audioinput")};this.getVideoSourceList=function(e){O(e,"videoinput")};var I="dc";var M={};var L={};var A=null;a.audioEnabled=true;a.videoEnabled=true;this.debugPrinter=null;this.myEasyrtcid="";this.nativeVideoHeight=0;this.maxP2PMessageLength=1e3;this.nativeVideoWidth=0;this.roomJoin={};this.isNameValid=function(e){return a.usernameRegExp.test(e)};this.setCookieId=function(e){a.cookieId=e};this._desiredVideoProperties={};this.setVideoSource=function(e){a._desiredVideoProperties.videoSrcId=e};this.setScreenCapture=function(e,r){if(e){a._presetMediaConstraints={video:{mozMediaSource:"screen",chromeMediaSource:"screen",mediaSource:"screen",mediaSourceId:"screen:0",maxWidth:screen.width,maxHeight:screen.height,minWidth:screen.width,minHeight:screen.height,minFrameRate:1,maxFrameRate:15},audio:false};if(r){if(t&&t.browserDetails&&t.browserDetails.browser==="chrome"){var n=a._presetMediaConstraints.video;n.chromeMediaSource="desktop";n.chromeMediaSourceId=r;a._presetMediaConstraints.video={mandatory:n,optional:[{googTemporalLayeredScreencast:true}]}}else{a._presetMediaConstraints.video.mediaSourceId=r}}}else{delete a._presetMediaConstraints}};this._desiredAudioProperties={};this.setAudioSource=function(e){a._desiredAudioProperties.audioSrcId=e};this.setVideoDims=function(e,t,r){a._desiredVideoProperties.width=e;a._desiredVideoProperties.height=t;if(r!==n){a._desiredVideoProperties.frameRate=r}};a.getUserMediaConstraints=function(){var e={};if(a._presetMediaConstraints){e=a._presetMediaConstraints;delete a._presetMediaConstraints;return e}else if(!a.videoEnabled){e.video=false}else{if(t&&t.browserDetails&&(t.browserDetails.browser==="firefox"||t.browserDetails.browser==="edge")){e.video={};if(a._desiredVideoProperties.width){e.video.width=a._desiredVideoProperties.width}if(a._desiredVideoProperties.height){e.video.height=a._desiredVideoProperties.height}if(a._desiredVideoProperties.frameRate){e.video.frameRate={minFrameRate:a._desiredVideoProperties.frameRate,maxFrameRate:a._desiredVideoProperties.frameRate}}if(a._desiredVideoProperties.videoSrcId){e.video.deviceId=a._desiredVideoProperties.videoSrcId}}else{e.video={};if(a._desiredVideoProperties.width){e.video.width={max:a._desiredVideoProperties.width,min:a._desiredVideoProperties.width,ideal:a._desiredVideoProperties.width}}if(a._desiredVideoProperties.height){e.video.height={max:a._desiredVideoProperties.height,min:a._desiredVideoProperties.height,ideal:a._desiredVideoProperties.height}}if(a._desiredVideoProperties.frameRate){e.video.frameRate={max:a._desiredVideoProperties.frameRate,ideal:a._desiredVideoProperties.frameRate}}if(a._desiredVideoProperties.videoSrcId){e.video.deviceId=a._desiredVideoProperties.videoSrcId}if(Object.keys(e.video).length===0){e.video=true}}}if(!a.audioEnabled){e.audio=false}else{e.audio={};if(a._desiredAudioProperties.audioSrcId){e.audio.deviceId=a._desiredAudioProperties.audioSrcId}}return e};this.setApplicationName=function(e){a.applicationName=e};this.enableDebug=function(e){if(e){a.debugPrinter=function(e,t){var r=(new Date).toISOString();var n=(new Error).stack;var i="location unknown";if(n){var a=n.split("\n");i="";if(a.length>=5){i=a[4]}}console.log("debug "+r+" : "+e+" ["+i+"]");if(typeof t!=="undefined"){console.log("debug "+r+" : ",t)}}}else{a.debugPrinter=null}};this.supportsGetUserMedia=function(){return navigator.mediaDevices&&typeof navigator.mediaDevices.getUserMedia!=="undefined"};this.supportsPeerConnections=function(){return typeof RTCPeerConnection!=="undefined"};this.supportsDataChannels=function(){var e=false;if(a.supportsPeerConnections()){try{var t=new RTCPeerConnection({iceServers:[]},{});e=typeof t.createDataChannel!=="undefined";t.close()}catch(r){}}return e};this.supportsStatistics=function(){var e=false;if(a.supportsPeerConnections()){try{var t=new RTCPeerConnection({iceServers:[]},{});e=typeof t.getStats!=="undefined";t.close()}catch(r){}}return e};this.createRTCPeerConnection=function(e,t){if(a.supportsPeerConnections()){return new RTCPeerConnection(e,t)}else{throw"Your browser doesn't support webRTC (RTCPeerConnection)"}};this.getDatachannelConstraints=function(){return{reliable:t&&t.browserDetails&&t.browserDetails.browser!=="chrome"&&t.browserDetails.version<31}};T={audio:false,video:false};var x=false;var N=null;var j=null;var V=null;var F=null;var G={};var U={msgTypes:{}};var B=null;var J=function e(){};this.printpeerconns=function(){console.log("peerconns = ",o)};var W={};this.acceptCheck=function(e,t){t(true)};this.streamAcceptor=function(e,t){};this.onStreamClosed=function(e){};this.callCancelled=function(e){};this.getPeerConnectionByUserId=function(e){if(o&&o[e]){return o[e].pc}return null};var z=[{googTransmitBitrate:"transmitBitRate",googActualEncBitrate:"encodeRate",googAvailableSendBandwidth:"availableSendRate"},{googCodecName:"audioCodec",googTypingNoiseState:"typingNoise",packetsSent:"audioPacketsSent",bytesSent:"audioBytesSent"},{googCodecName:"videoCodec",googFrameRateSent:"outFrameRate",packetsSent:"videoPacketsSent",bytesSent:"videoBytesSent"},{packetsLost:"videoPacketsLost",packetsReceived:"videoPacketsReceived",bytesReceived:"videoBytesReceived",googFrameRateOutput:"frameRateOut"},{packetsLost:"audioPacketsLost",packetsReceived:"audioPacketsReceived",bytesReceived:"audioBytesReceived",audioOutputLevel:"audioOutputLevel"},{googRemoteAddress:"remoteAddress",googActiveConnection:"activeConnection"},{audioInputLevel:"audioInputLevel"}];var H={"outboundrtp_audio.bytesSent":"audioBytesSent","outboundrtp_video.bytesSent":"videoBytesSent","inboundrtp_video.bytesReceived":"videoBytesReceived","inboundrtp_audio.bytesReceived":"audioBytesReceived","outboundrtp_audio.packetsSent":"audioPacketsSent","outboundrtp_video.packetsSent":"videoPacketsSent","inboundrtp_video.packetsReceived":"videoPacketsReceived","inboundrtp_audio.packetsReceived":"audioPacketsReceived","inboundrtp_video.packetsLost":"videoPacketsLost","inboundrtp_audio.packetsLost":"audioPacketsLost",firefoxRemoteAddress:"remoteAddress"};this.standardStatsFilter=t&&t.browserDetails&&t.browserDetails.browser==="firefox"?H:z;function q(e,t,r){if(!o[e]){t(e,{connected:false})}else if(o[e].pc.getStats){o[e].pc.getStats(null).then(function(n){var i={};var a={};var o=null;var s;if(n){n.forEach(function(e){var t;var r;if(e.type.match(/boundrtp/)){if(e.id.match(/audio/)){t=e.type+"_audio"}else if(e.id.match(/video/)){t=e.type+"_video"}else{return}for(r in e){if(e.hasOwnProperty(r)){i[t+"."+r]=e[r]}}}else{if(e.hasOwnProperty("ipAddress")&&e.id){a[e.id]=e.ipAddress+":"+e.portNumber}else if(e.hasOwnProperty("selected")&&e.hasOwnProperty("remoteCandidateId")&&e.selected){o=e.remoteCandidateId}}})}if(o){i.firefoxRemoteAddress=a[o]}if(!r){t(e,i)}else{var c={};for(s in r){if(r.hasOwnProperty(s)&&i.hasOwnProperty(s)){c[r[s]]=i[s]}}t(e,c)}},function(e){u("unable to get statistics")})}else{t(e,{statistics:a.getConstantString("statsNotSupported")})}}function Y(e,t,r){if(!o[e]){t(e,{connected:false})}else if(o[e].pc.getStats){o[e].pc.getStats().then(function(n){var i={};var o,s=n.result();var c,d;var f;var u;var l;var p;var m=[];var v;var h=0;var g;var y=null;var C,S;var R,E;if(!r){for(c=0;c<s.length;c++){l=s[c].names();for(d=0;d<l.length;d++){u=l[d];i[s[c].id+"."+u]=s[c].stat(u)}}}else{for(c=0;c<s.length;c++){m[c]={};l=s[c].names();for(d=0;d<l.length;d++){m[c][l[d]]=true}if(m[c].googRemoteAddress&&m[c].googActiveConnection){C=s[c].stat("googActiveConnection");if(C===true||C==="true"){S=parseInt(s[c].stat("bytesReceived"))+parseInt(s[c].stat("bytesSent"));if(S>h){g=c;h=S}}}}for(c=0;c<s.length;c++){if(m[c].googActiveConnection){if(c!==g){m[c]={}}else{R=s[c].stat("googLocalAddress").split(":")[0];E=s[c].stat("googRemoteAddress").split(":")[0];if(a.isTurnServer(R)){y=R}else if(a.isTurnServer(E)){y=E}}}}for(c=0;c<r.length;c++){f=r[c];v=[];o=null;for(d=0;d<s.length;d++){var T=true;for(u in f){if(f.hasOwnProperty(u)&&!m[d][u]){T=false;break}}if(T&&s[d]){v.push(s[d])}}if(v.length===1){for(d=0;d<v.length;d++){o=v[d];if(o){for(u in f){if(f.hasOwnProperty(u)){p=f[u];i[p]=o.stat(u)}}}}}else if(v.length>1){for(u in f){if(f.hasOwnProperty(u)){i[f[u]]=[]}}for(d=0;d<v.length;d++){o=v[d];for(u in f){if(f.hasOwnProperty(u)){p=f[u];i[p].push(o.stat(u))}}}}}}if(i.remoteAddress&&y){i.remoteAddress=y}t(e,i)})}else{t(e,{statistics:a.getConstantString("statsNotSupported")})}}this.getPeerStatistics=function(e,r,n){if(t&&t.browserDetails&&t.browserDetails.browser==="firefox"){q(e,r,n)}else{Y(e,r,n)}};function K(e,t){var r=JSON.stringify(t);JSON.parse(r);var n={msgType:"setRoomApiField",msgData:{setRoomApiField:{roomName:e,field:t}}};a.webSocket.json.emit("easyrtcCmd",n,function(e){if(e.msgType==="error"){a.showError(e.msgData.errorCode,e.msgData.errorText)}})}a._roomApiFieldTimer={};function $(e){if(a._roomApiFieldTimer[e]){clearTimeout(a._roomApiFieldTimer[e])}a._roomApiFieldTimer[e]=setTimeout(function(){var t=a._roomApiFields[e];if(t){K(e,t)}a._roomApiFieldTimer[e]=null},10)}this.setRoomApiField=function(e,t,r){if(!a._roomApiFields){a._roomApiFields={}}if(!t&&!r){clearTimeout(a._roomApiFieldTimer[e]);delete a._roomApiFields[e]}else{if(!a._roomApiFields[e]){a._roomApiFields[e]={}}if(r!==n&&r!==null){if(typeof r==="object"){try{JSON.stringify(r)}catch(i){a.showError(a.errCodes.DEVELOPER_ERR,"easyrtc.setRoomApiField passed bad object ");return}}a._roomApiFields[e][t]={fieldName:t,fieldValue:r}}else{delete a._roomApiFields[e][t]}if(a.webSocketConnected){$(e)}}};this.showError=function(e,t){a.onError({errorCode:e,errorText:t})};var X;this.setErrorListener=function(e){X=e};this.onError=function(e){u("saw error "+e.errorText);if(X){u("Using custom error handler");X(e);return}var t=document.getElementById("easyrtcErrorDialog");var r;if(!t){t=document.createElement("div");t.id="easyrtcErrorDialog";var n=document.createElement("div");n.innerHTML="Error messages";n.className="easyrtcErrorDialog_title";t.appendChild(n);r=document.createElement("div");r.id="easyrtcErrorDialog_body";t.appendChild(r);var i=document.createElement("button");i.appendChild(document.createTextNode("Okay"));i.className="easyrtcErrorDialog_okayButton";i.onclick=function(){r.innerHTML="";t.style.display="none"};t.appendChild(i);document.body.appendChild(t)}r=document.getElementById("easyrtcErrorDialog_body");var a=document.createElement("div");a.className="easyrtcErrorDialog_element";a.appendChild(document.createTextNode(e.errorText));r.appendChild(a);t.style.display="block"};this.createObjectURL=function(e){var t;if(window.URL&&window.URL.createObjectURL){return window.URL.createObjectURL(e)}else if(window.webkitURL&&window.webkitURL.createObjectURL){return window.webkit.createObjectURL(e)}else{t="Your browsers does not support URL.createObjectURL.";u("saw exception "+t);throw t}};this.cleanId=function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;"};if(!e){return""}return e.replace(/[&<>]/g,function(e){return t[e]})};a.setRoomEntryListener=function(e){a.roomEntryListener=e};a.setRoomOccupantListener=function(e){j=e};this.setDataChannelOpenListener=function(e){V=e};this.setDataChannelCloseListener=function(e){F=e};this.getConnectionCount=function(){var e=0;var t;for(t in o){if(o.hasOwnProperty(t)){if(a.getConnectStatus(t)===a.IS_CONNECTED){e++}}}return e};this.setMaxP2PMessageLength=function(e){this.maxP2PMessageLength=e};this.enableAudio=function(e){a.audioEnabled=e};this.enableVideo=function(e){a.videoEnabled=e};this.enableDataChannels=function(e){x=e};function Q(e,t){var r;if(t){for(r=0;r<t.length;r++){var n=t[r];n.enabled=e}}}function Z(e){if(!e){e="default"}if(_.hasOwnProperty(e)){return _[e]}else{return null}}this.getLocalMediaIds=function(){return Object.keys(_)};function ee(){var e={};var t;for(t in _){if(_.hasOwnProperty(t)){e[t]=_[t].id||"default"}}return e}function te(e,t){var r;if(!t){t="default"}e.streamName=t;_[t]=e;if(t!=="default"){var n=ee(),i=a.roomData;for(r in i){if(i.hasOwnProperty(r)){a.setRoomApiField(r,"mediaIds",n)}}}}this.register3rdPartyLocalMediaStream=function(e,t){return te(e,t)};function re(e,r){var i;var s;var c;if(!r){r="default"}if(o[e]){c=o[e].remoteStreamIdToName[r];if(c){return c}}for(i in a.roomData){if(a.roomData.hasOwnProperty(i)){s=a.getRoomApiField(i,e,"mediaIds");if(!s){continue}for(c in s){if(s.hasOwnProperty(c)&&(s[c]===r||r.indexOf(s[c])===0||s[c].indexOf(r)===0)){return c}}if(t&&t.browserDetails&&t.browserDetails.browser==="firefox"){if(s["default"]){return"default"}for(var d in s){if(s.hasOwnProperty(d)){return d}}}}}return n}this.getNameOfRemoteStream=function(e,t){if(typeof t==="string"){return re(e,t)}else if(t.id){return re(e,t.id)}};function ne(e){if(!e){e="default"}var t=a.getLocalStream(e);if(!t){return}var r=t.id||"default";var n;var i;if(_[e]){for(n in o){if(o.hasOwnProperty(n)){try{o[n].pc.removeStream(t)}catch(c){}a.sendPeerMessage(n,"__closingMediaStream",{streamId:r,streamName:e})}}S(_[e]);delete _[e];if(e!=="default"){var s=ee();for(i in a.roomData){if(a.roomData.hasOwnProperty(i)){a.setRoomApiField(i,"mediaIds",s)}}}}}this.closeLocalMediaStream=function(e){return ne(e)};this.closeLocalStream=this.closeLocalMediaStream;this.enableCamera=function(e,t){var r=Z(t);if(r&&r.getVideoTracks){Q(e,r.getVideoTracks())}};this.enableMicrophone=function(e,t){var r=Z(t);if(r&&r.getAudioTracks){Q(e,r.getAudioTracks())}};this.muteVideoObject=function(e,t){var r;if(typeof e==="string"){r=document.getElementById(e);if(!r){throw"Unknown video object "+e}}else if(!e){throw"muteVideoObject passed a null"}else{r=e}r.muted=!!t};a.getLocalStreamAsUrl=function(e){var t=Z(e);if(t===null){throw"Developer error: attempt to get a MediaStream without invoking easyrtc.initMediaSource successfully"}return a.createObjectURL(t)};this.getLocalStream=function(e){return Z(e)||null};this.clearMediaStream=function(e){if(e&&e.pause){e.pause()}if(typeof e.srcObject!=="undefined"){e.srcObject=null}else if(typeof e.mozSrcObject!=="undefined"){e.mozSrcObject=null}else if(typeof e.src!=="undefined"){e.src=""}};this.setVideoObjectSrc=function(e,t){if(t&&t!==""){e.autoplay=true;if(typeof e.srcObject!=="undefined"){e.srcObject=t}else if(typeof e.mozSrcObject!=="undefined"){e.mozSrcObject=a.createObjectURL(t)}else if(typeof e.src!=="undefined"){e.src=a.createObjectURL(t)}}else{a.clearMediaStream(e)}};this.buildLocalMediaStream=function(e,t,r){var n;if(typeof e!=="string"){a.showError(a.errCodes.DEVELOPER_ERR,"easyrtc.buildLocalMediaStream not supplied a stream name");return null}var i=null;for(var s in _){if(_.hasOwnProperty(s)){i=_[s];if(i){break}}}if(!i){for(s in o){if(o.hasOwnProperty(s)){var c=o[s].pc.getRemoteStreams();if(c&&c.length>0){i=c[0]}}}}if(!i){a.showError(a.errCodes.DEVELOPER_ERR,"Attempt to create a mediastream without one to clone from");return null}var d=i.clone();var f=d.getTracks();if(t){for(n=0;n<t.length;n++){d.addTrack(t[n].clone())}}if(r){for(n=0;n<r.length;n++){d.addTrack(r[n].clone())}}for(n=0;n<f.length;n++){d.removeTrack(f[n])}te(d,e);return d};this.loadStylesheet=function(){var e=document.getElementsByTagName("link");var t,r;for(t in e){if(e.hasOwnProperty(t)){r=e[t];if(r.href&&r.href.match(/\/easyrtc.css/)){return}}}var n=document.createElement("link");n.setAttribute("rel","stylesheet");n.setAttribute("type","text/css");n.setAttribute("href","/easyrtc/easyrtc.css");var i=document.getElementsByTagName("head")[0];var a=i.childNodes[0];i.insertBefore(n,a)};this.formatError=function(e){var t,r;if(e===null||typeof e==="undefined"){return"null"}if(typeof e==="string"){return e}else if(e.type&&e.description){return e.type+" : "+e.description}else if(typeof e==="object"){try{return JSON.stringify(e)}catch(n){r="{";for(t in e){if(e.hasOwnProperty(t)){if(typeof e[t]==="string"){r=r+t+"='"+e[t]+"' "}}}r=r+"}";return r}}else{return"Strange case"}};this.initMediaSource=function(e,t,r){u("about to request local media");if(!r){r="default"}T={audio:a.audioEnabled,video:a.videoEnabled};if(!t){t=function e(t,r){var n="easyrtc.initMediaSource: "+a.formatError(r);u(n);a.showError(a.errCodes.MEDIA_ERR,n)}}if(!a.supportsGetUserMedia()){t(a.errCodes.MEDIA_ERR,a.getConstantString("noWebrtcSupport"));return}if(!e){a.showError(a.errCodes.DEVELOPER_ERR,"easyrtc.initMediaSource not supplied a successCallback");return}var n=a.getUserMediaConstraints();var i=function t(n){u("getUserMedia success callback entered");u("successfully got local media");n.streamName=r;te(n,r);var i,o,s;if(T.video){i=document.createElement("video");i.style.display="none";document.body.appendChild(i);i.muted=true;o=30;s=function t(){if(i.videoWidth>0||o<0){a.nativeVideoWidth=i.videoWidth;a.nativeVideoHeight=i.videoHeight;if(a._desiredVideoProperties.height&&(a.nativeVideoHeight!==a._desiredVideoProperties.height||a.nativeVideoWidth!==a._desiredVideoProperties.width)){a.showError(a.errCodes.MEDIA_WARNING,a.format(a.getConstantString("resolutionWarning"),a._desiredVideoProperties.width,a._desiredVideoProperties.height,a.nativeVideoWidth,a.nativeVideoHeight))}a.clearMediaStream(i);if(i.removeNode){i.removeNode(true)}else{document.body.removeChild(i)}J();if(e){e(n)}}else{o-=1;setTimeout(s,300)}};a.setVideoObjectSrc(i,n);s()}else{J();if(e){e(n)}}};var o=function e(n){u("getusermedia failed");u("failed to get local media");var i;if(typeof n==="string"){i=n}else if(n.name){i=n.name}else{i="Unknown"}if(t){u("invoking error callback",i);t(a.errCodes.MEDIA_ERR,a.format(a.getConstantString("gumFailed"),i))}ne(r);T={audio:false,video:false};J()};if(!a.audioEnabled&&!a.videoEnabled){o(a.getConstantString("requireAudioOrVideo"));return}function s(){return(new Date).getTime()}var c;function d(e){var t=s();if(t<c+1e3){u("Trying getUserMedia a second time");navigator.mediaDevices.getUserMedia(n).then(i).catch(o)}else{o(e)}}c=s();navigator.mediaDevices.getUserMedia(n).then(i).catch(d)};this.setAcceptChecker=function(e){a.acceptCheck=e};this.setStreamAcceptor=function(e){a.streamAcceptor=e};a.setOnError=function(e){a.onError=e};this.setCallCancelled=function(e){a.callCancelled=e};this.setOnStreamClosed=function(e){a.onStreamClosed=e};this.setPeerListener=function(e,t,r){if(!t){U.cb=e}else{if(!U.msgTypes[t]){U.msgTypes[t]={sources:{}}}if(!r){U.msgTypes[t].cb=e}else{U.msgTypes[t].sources[r]={cb:e}}}};this.receivePeerDistribute=function(e,t,r){var n=t.msgType;var i=t.msgData;if(!n){u("received peer message without msgType",t);return}if(U.msgTypes[n]){if(U.msgTypes[n].sources[e]&&U.msgTypes[n].sources[e].cb){U.msgTypes[n].sources[e].cb(e,n,i,r);return}if(U.msgTypes[n].cb){U.msgTypes[n].cb(e,n,i,r);return}}if(U.cb){U.cb(e,n,i,r)}};this.setServerListener=function(e){B=e};this.setSocketUrl=function(e,t){u("WebRTC signaling server URL set to "+e);N=e;if(t){C=t}};this.setUsername=function(e){if(a.myEasyrtcid){a.showError(a.errCodes.DEVELOPER_ERR,"easyrtc.setUsername called after authentication");return false}else if(a.isNameValid(e)){a.username=e;return true}else{a.showError(a.errCodes.BAD_NAME,a.format(a.getConstantString("badUserName"),e));return false}};this.usernameToIds=function(e,t){var r=[];var n,i;for(i in G){if(!G.hasOwnProperty(i)){continue}if(t&&i!==t){continue}for(n in G[i]){if(!G[i].hasOwnProperty(n)){continue}if(G[i][n].username===e){r.push({easyrtcid:n,roomName:i})}}}return r};this.getRoomApiField=function(e,t,r){if(G[e]&&G[e][t]&&G[e][t].apiField&&G[e][t].apiField[r]){return G[e][t].apiField[r].fieldValue}else{return n}};this.setCredential=function(e){try{JSON.stringify(e);A=e;return true}catch(t){a.showError(a.errCodes.BAD_CREDENTIAL,"easyrtc.setCredential passed a non-JSON-able object");throw"easyrtc.setCredential passed a non-JSON-able object"}};this.setDisconnectListener=function(e){a.disconnectListener=e};this.idToName=function(e){var t;for(t in G){if(!G.hasOwnProperty(t)){continue}if(G[t][e]){if(G[t][e].username){return G[t][e].username}}}return e};this.webSocket=null;var ie={};var ae=null;var oe=false;this.setUseFreshIceEachPeerConnection=function(e){oe=e};this.getServerIce=function(){return ie};this.setIceUsedInCalls=function(e){if(!e.iceServers){a.showError(a.errCodes.DEVELOPER_ERR,"Bad ice configuration passed to easyrtc.setIceUsedInCalls")}else{ae=e}};function se(e,t,r){var n=null;var i=e.pc.getRemoteStreams();if(!r){r="default"}if(r==="default"){if(i.length>0){return i[0]}else{return null}}for(var o in a.roomData){if(a.roomData.hasOwnProperty(o)){var s=a.getRoomApiField(o,t,"mediaIds");n=s?s[r]:null;if(n){break}}}if(!n){a.showError(a.errCodes.DEVELOPER_ERR,"remote peer does not have media stream called "+r)}for(var c=0;c<i.length;c++){var d;if(i[c].id){d=i[c].id}else{d="default"}if(!n||d===n||d.indexOf(n)===0){return i[c]}}return null}function ce(e,t,r){var n,i;if(!e){n=Z(r)}else{i=o[e];if(!i){a.showError(a.errCodes.DEVELOPER_ERR,"haveTracks called about a peer you don't have a connection to");return false}n=se(o[e],e,r)}if(!n){return false}var s;try{if(t){s=n.getAudioTracks()}else{s=n.getVideoTracks()}}catch(c){return true}if(!s){return false}return s.length>0}this.haveAudioTrack=function(e,t){return ce(e,true,t)};this.haveVideoTrack=function(e,t){return ce(e,false,t)};this.getRoomField=function(e,t){var r=a.getRoomFields(e);return!r||!r[t]?n:r[t].fieldValue};var de=null;var fe=null;var ue=null;function le(){var e;a.loggingOut=true;L={};W={};a.disconnecting=true;ue=a.webSocket;if(s){clearTimeout(s);s=null}if(a.webSocket){if(!fe){a.webSocket.close()}}a.webSocketConnected=false;a.webSocket=0;a.hangupAll();if(j){for(e in G){if(G.hasOwnProperty(e)){j(e,{},false);a.setRoomApiField(e)}}}G={};a.emitEvent("roomOccupant",{});a.roomData={};a.roomJoin={};a.loggingOut=false;a.myEasyrtcid=null;a.disconnecting=false;M={};if(a.disconnectListener){a.disconnectListener()}}this.disconnect=function(){u("attempt to disconnect from WebRTC signalling server");a.disconnecting=true;a.hangupAll();a.loggingOut=true;setTimeout(le,250)};function pe(e,t,r,n,i){if(!a.webSocket){throw"Attempt to send message without a valid connection to the server."}else{var o={msgType:t};if(e){o.targetEasyrtcid=e}if(r){o.msgData=r}u("sending socket message "+JSON.stringify(o));a.webSocket.json.emit("easyrtcCmd",o,function(e){if(e.msgType!=="error"){if(!e.hasOwnProperty("msgData")){e.msgData=null}if(n){n(e.msgType,e.msgData)}}else{if(i){i(e.msgData.errorCode,e.msgData.errorText)}else{a.showError(e.msgData.errorCode,e.msgData.errorText)}}})}}var me=0;function ve(e,t){var r=e+"-"+me++;var n,i,s,c,d;var f=Math.ceil(t.length/a.maxP2PMessageLength);s={transfer:"start",transferId:r,parts:f};d={transfer:"end",transferId:r};o[e].dataChannelS.send(JSON.stringify(s));for(n=0,i=t.length;n<i;n+=a.maxP2PMessageLength){c={transferId:r,data:t.substr(n,a.maxP2PMessageLength),transfer:"chunk"};o[e].dataChannelS.send(JSON.stringify(c))}o[e].dataChannelS.send(JSON.stringify(d))}this.sendDataP2P=function(e,t,r){var n=JSON.stringify({msgType:t,msgData:r});u("sending p2p message to "+e+" with data="+JSON.stringify(n));if(!o[e]){a.showError(a.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without a connection to "+e+" first.")}else if(!o[e].dataChannelS){a.showError(a.errCodes.DEVELOPER_ERR,"Attempt to send data peer to peer without establishing a data channel to "+e+" first.")}else if(!o[e].dataChannelReady){a.showError(a.errCodes.DEVELOPER_ERR,"Attempt to use data channel to "+e+" before it's ready to send.")}else{try{if(n.length>a.maxP2PMessageLength){ve(e,n)}else{o[e].dataChannelS.send(n)}}catch(i){u("sendDataP2P error: ",i);throw i}}};this.sendDataWS=function(e,t,r,n){u("sending client message via websockets to "+e+" with data="+JSON.stringify(r));if(!n){n=function e(t){if(t.msgType==="error"){a.showError(t.msgData.errorCode,t.msgData.errorText)}}}var i={msgType:t,msgData:r};if(e){if(typeof e==="string"){i.targetEasyrtcid=e}else if(typeof e==="object"){if(e.targetEasyrtcid){i.targetEasyrtcid=e.targetEasyrtcid}if(e.targetRoom){i.targetRoom=e.targetRoom}if(e.targetGroup){i.targetGroup=e.targetGroup}}}if(a.webSocket){a.webSocket.json.emit("easyrtcMsg",i,n)}else{u("websocket failed because no connection to server");throw"Attempt to send message without a valid connection to the server."}};this.sendData=function(e,t,r,n){if(o[e]&&o[e].dataChannelReady){a.sendDataP2P(e,t,r)}else{a.sendDataWS(e,t,r,n)}};this.sendPeerMessage=function(e,t,r,n,i){if(!e){a.showError(a.errCodes.DEVELOPER_ERR,"destination was null in sendPeerMessage")}u("sending peer message "+JSON.stringify(r));function o(e){if(e.msgType==="error"){if(i){i(e.msgData.errorCode,e.msgData.errorText)}}else{if(n){n(e.msgType,e.msgData?e.msgData:null)}}}a.sendDataWS(e,t,r,o)};this.sendServerMessage=function(e,t,r,n){var i={msgType:e,msgData:t};u("sending server message "+JSON.stringify(i));function o(e){if(e.msgType==="error"){if(n){n(e.msgData.errorCode,e.msgData.errorText)}}else{if(r){r(e.msgType,e.msgData?e.msgData:null)}}}a.sendDataWS(null,e,t,o)};this.getRoomList=function(e,t){pe(null,"getRoomList",null,function(t,r){e(r.roomList)},function(e,r){if(t){t(e,r)}else{a.showError(e,r)}})};this.NOT_CONNECTED="not connected";this.BECOMING_CONNECTED="connection in progress to us.";this.IS_CONNECTED="is connected";this.getConnectStatus=function(e){if(!o.hasOwnProperty(e)){return a.NOT_CONNECTED}var t=o[e];if((t.sharingAudio||t.sharingVideo)&&!t.startedAV){return a.BECOMING_CONNECTED}else if(t.sharingData&&!t.dataChannelReady){return a.BECOMING_CONNECTED}else{return a.IS_CONNECTED}};function he(){var e=[];e.push({DtlsSrtpKeyAgreement:"true"});return{optional:e}}function ge(e,t,r){var n;for(n=0;n<o[e].candidatesToSend.length;n++){pe(e,"candidate",o[e].candidatesToSend[n],t,r)}}function ye(e,t){if(!o[e]){return}var r=t.id||"default",n=re(e,r)||"default";if(o[e].liveRemoteStreams[n]){delete o[e].liveRemoteStreams[n];if(a.onStreamClosed){a.onStreamClosed(e,t,n)}}delete o[e].remoteStreamIdToName[r]}function Ce(e,t){if(o[e]){ye(e,t);J();if(o[e].pc){try{o[e].pc.removeStream(t)}catch(r){}}}}function Se(e,t){function r(e){var t;for(t in e){if(e.hasOwnProperty(t)){return true}}return false}var n={};if(r(e)){n.added=e}if(r(t)){n.deleted=t}if(r(n)){return n}else{return null}}function Re(e,t){var r;var n={},i={};var a;for(r in t){if(t.hasOwnProperty(r)){if(e===null||typeof e[r]==="undefined"){n[r]=t[r]}else if(typeof t[r]==="object"){a=Re(e[r],t[r]);if(a!==null){n[r]=t[r]}}else if(t[r]!==e[r]){n[r]=t[r]}}}for(r in e){if(t.hasOwnProperty(r)){if(typeof t[r]==="undefined"){i[r]=e[r]}}}return Se(n,i)}function Ee(){var e={};var t;for(t in o){if(!o.hasOwnProperty(t)){continue}e[t]={connectTime:o[t].connectTime,isInitiator:!!o[t].isInitiator}}var r={userSettings:{sharingAudio:!!T.audio,sharingVideo:!!T.video,sharingData:!!x,nativeVideoWidth:a.nativeVideoWidth,nativeVideoHeight:a.nativeVideoHeight,windowWidth:window.innerWidth,windowHeight:window.innerHeight,screenWidth:window.screen.width,screenHeight:window.screen.height,cookieEnabled:navigator.cookieEnabled,os:navigator.oscpu,language:navigator.language}};if(!l(e)){r.p2pList=e}return r}function Te(){var e=Ee(false);var t=function t(){var r=Re(M,e);if(r){u("cfg="+JSON.stringify(r.added));if(a.webSocket){pe(null,"setUserCfg",{setUserCfg:r.added},null,null)}}M=e};if(M==={}){t()}else{setTimeout(t,100)}}function be(e){var t="";t+=e>>24;t+=" | ";t+=e>>8&65535;t+=" | ";t+=e&255;return t}function we(e){var t="candidate:";var r=e.indexOf(t)+t.length;var n=e.substr(r).split(" ");return{component:n[1],type:n[7],foundation:n[0],protocol:n[2],address:n[4],port:n[5],priority:be(n[3])}}function Pe(e){a._candidates=a._candidates||[];a._candidates.push(we(e))}function _e(e,t){if(!o[e]||o[e].cancelled){return}var r=o[e];if(!r.startedAV){r.startedAV=true;r.sharingAudio=T.audio;r.sharingVideo=T.video;r.connectTime=(new Date).getTime();if(r.callSuccessCB){if(r.sharingAudio||r.sharingVideo){r.callSuccessCB(e,"audiovideo")}}if(a.audioEnabled||a.videoEnabled){Te()}}var n=t.id||"default";var i=re(e,n)||"default";if(!r.liveRemoteStreams[i]){r.remoteStreamIdToName[n]=i;r.liveRemoteStreams[i]=true;t.streamName=i;var s=t.getTracks();t.addEventListener("removetrack",function(r){var n=s.indexOf(r.track);if(n!==-1){s.splice(n,1)}if(s.length===0){ye(e,t)}});if(a.streamAcceptor){a.streamAcceptor(e,t,i);a.sendDataWS(e,"easyrtc_streamReceived",{streamName:i},function(){})}}else{u("remove stream "+i+" already exist")}}function ke(e,t){if(!o[e]||o[e].cancelled){return}var r=o[e];r.trackTimers=r.trackTimers||{};for(var n=0,i=t.length;n<i;n++){var a=t[n],s=a.id||"default";clearTimeout(r.trackTimers[s]);r.trackTimers[s]=setTimeout(_e.bind(null,e,a),100)}}function De(e,t,r,n){var i;var s;var c;var d=ae?ae:ie;u("building peer connection to "+e);try{i=a.createRTCPeerConnection(d,he());if(!i){s="Unable to create PeerConnection object, check your ice configuration("+JSON.stringify(d)+")";u(s);throw Error(s)}if(x&&typeof i.createDataChannel==="undefined"){x=false}i.onnegotiationneeded=function(t){var r=t.currentTarget||t.target||i,n=r.signalingState||"unknown";u("onnegotiationneeded",n);if(o[e]&&o[e].enableNegotiateListener){Le(e)}};i.onsignalingstatechange=function(){var t=P.currentTarget||P.target||i,r=t.signalingState||"unknown";u("onsignalingstatechange",r);if(y){y(e,t,r)}};i.oniceconnectionstatechange=function(t){var n=t.currentTarget||t.target||i,s=n.iceConnectionState||"unknown";u("onsignalingstatechange",s);if(g){g(e,n,s)}switch(s){case"connected":if(a.onPeerOpen){a.onPeerOpen(e)}if(o[e]&&o[e].callSuccessCB){o[e].callSuccessCB(e,"connection")}break;case"failed":if(r){r(a.errCodes.NOVIABLEICE,"No usable STUN/TURN path")}delete o[e];break;case"disconnected":if(a.onPeerFailing){a.onPeerFailing(e)}if(o[e]){o[e].failing=Date.now()}break;case"closed":if(a.onPeerClosed){a.onPeerClosed(e)}break;case"completed":if(o[e]){if(o[e].failing&&a.onPeerRecovered){a.onPeerRecovered(e,o[e].failing,Date.now())}delete o[e].failing}break}};i.onconnection=function(){u("onconnection called prematurely")};c={pc:i,candidatesToSend:[],startedAV:false,connectionAccepted:false,isInitiator:t,remoteStreamIdToName:{},streamsAddedAcks:{},liveRemoteStreams:{},supportHalfTrickleIce:false};i.onicecandidate=function(t){if(o[e]&&o[e].cancelled){return}var n;if(t.candidate&&o[e]){n={type:"candidate",label:t.candidate.sdpMLineIndex,id:t.candidate.sdpMid,candidate:t.candidate.candidate};if(h){n=h(n,false);if(!n){return}}Pe(t.candidate.candidate);if(o[e].connectionAccepted||o[e].supportHalfTrickleIce){pe(e,"candidate",n,null,function(){r(a.errCodes.PEER_GONE,"Candidate disappeared")})}else{o[e].candidatesToSend.push(n)}}};i.ontrack=function(t){u("saw ontrack method invoked, which is expected");ke(e,t.streams)};i.onaddstream=function(t){u("empty onaddstream method invoked, which is expected");_e(e,t.stream)};i.onremovestream=function(t){u("saw remove on remote media stream");Ce(e,t.stream)};o[e]=c}catch(E){u("buildPeerConnection error",E);r(a.errCodes.SYSTEM_ERR,E.message);return null}var f,l;if(n){for(f=0;f<n.length;f++){l=Z(n[f]);if(l){R(l,i)}else{u("Developer error, attempt to access unknown local media stream "+n[f])}}}else if(p&&(a.videoEnabled||a.audioEnabled)){l=a.getLocalStream();R(l,i)}var m={};function v(t){u("saw dataChannel.onmessage event: ",t.data);if(t.data==="dataChannelPrimed"){a.sendDataWS(e,"dataChannelPrimed","")}else{var r;try{r=JSON.parse(t.data)}catch(o){u("Developer error, unable to parse event data")}if(r){if(r.transfer&&r.transferId){if(r.transfer==="start"){u("start transfer #"+r.transferId);var n=parseInt(r.parts);m={chunks:[],parts:n,transferId:r.transferId}}else if(r.transfer==="chunk"){u("got chunk for transfer #"+r.transferId);if(!(typeof r.data==="string"&&r.data.length<=a.maxP2PMessageLength)){u("Developer error, invalid data")}else if(!m){u("Developer error, unexpected chunk")}else if(r.transferId!==m.transferId){u("Developer error, invalid transfer id")}else if(m.chunks.length+1>m.parts){u("Developer error, received too many chunks")}else{m.chunks.push(r.data)}}else if(r.transfer==="end"){u("end of transfer #"+r.transferId);if(!m){u("Developer error, unexpected end of transfer")}else if(r.transferId!==m.transferId){u("Developer error, invalid transfer id")}else if(m.chunks.length!==m.parts){u("Developer error, received wrong number of chunks")}else{var i;try{i=JSON.parse(m.chunks.join(""))}catch(o){u("Developer error, unable to parse message")}if(i){a.receivePeerDistribute(e,i,null)}}m={}}else{u("Developer error, got an unknown transfer message"+r.transfer)}}else{a.receivePeerDistribute(e,r,null)}}}}function C(e){u("saw initOutgoingChannel call");var t=i.createDataChannel(I,a.getDatachannelConstraints());o[e].dataChannelS=t;o[e].dataChannelR=t;t.onmessage=v;t.onopen=function(r){u("saw dataChannel.onopen event");if(o[e]){t.send("dataChannelPrimed")}};t.onclose=function(t){u("saw dataChannelS.onclose event");if(o[e]){o[e].dataChannelReady=false;delete o[e].dataChannelS}if(F){F(e)}J()}}function S(e){u("initializing incoming channel handler for "+e);o[e].pc.ondatachannel=function(t){u("saw incoming data channel");var r=t.channel;o[e].dataChannelR=r;o[e].dataChannelS=r;o[e].dataChannelReady=true;r.onmessage=v;r.onclose=function(t){u("saw dataChannelR.onclose event");if(o[e]){o[e].dataChannelReady=false;delete o[e].dataChannelR}if(F){F(e)}J()};r.onopen=function(t){u("saw dataChannel.onopen event");if(o[e]){r.send("dataChannelPrimed")}}}}if(x){a.setPeerListener(function(){if(o[e]){o[e].dataChannelReady=true;if(o[e].callSuccessCB){o[e].callSuccessCB(e,"datachannel")}if(V){V(e,true)}J()}else{u("failed to setup outgoing channel listener")}},"dataChannelPrimed",e);if(t){try{C(e)}catch(T){u("failed to init outgoing channel");r(a.errCodes.SYSTEM_ERR,a.formatError(T))}}if(!t){S(e)}}i.onconnection=function(){u("setup pc.onconnection ")};a.setPeerListener(function(e,t,r,n){if(c.streamsAddedAcks[r.streamName]){c.streamsAddedAcks[r.streamName](e,r.streamName);delete c.streamsAddedAcks[r.streamName]}},"easyrtc_streamReceived",e);return i}function Oe(e,t,r){if(!o[e]){De(e,false,function(e){a.showError(a.errCodes.SYSTEM_ERR,e)},r)}var n=o[e];var i=n.pc;if(!i){u("buildPeerConnection failed. Call not answered");return}var s=function t(r){if(n.cancelled){return}var s=function t(){u("sending answer");function s(){u("sending success")}function c(t,r){u("sending error");delete o[e];a.showError(t,r)}n.pendingAwnser=false;pe(e,"answer",r,s,c);o[e].connectionAccepted=true;ge(e,s,c);if(i.connectDataConnection){u("calling connectDataConnection(5002,5001)");i.connectDataConnection(5002,5001)}};if(m){r.sdp=m(r.sdp)}i.setLocalDescription(r).then(s,function(e){n.pendingAwnser=false;a.showError(a.errCodes.INTERNAL_ERR,"setLocalDescription: "+e)})};var c=new RTCSessionDescription(t);if(!c){throw"Could not create the RTCSessionDescription"}u("sdp ||  "+JSON.stringify(c));var d=function e(){if(n.cancelled){u("invokeCreateAnswer.canceled",i.signalingState);return}if(n.pendingAwnser){u("invokeCreateAnswer.pending",i.signalingState)}u("invokeCreateAnswer",i.signalingState);n.pendingAwnser=true;i.createAnswer(D).then(s).catch(function(e){n.pendingAwnser=false;a.showError(a.errCodes.INTERNAL_ERR,"create-answer: "+e)})};u("about to call setRemoteDescription in doAnswer");try{if(v){c=new RTCSessionDescription({type:c.type,sdp:v(c.sdp)})}u("sdp ||  "+JSON.stringify(c));i.setRemoteDescription(c).then(d,function(e){a.showError(a.errCodes.INTERNAL_ERR,"doAnswerBody setRemoteDescription failed: "+e)})}catch(f){u("set remote description failed");a.showError(a.errCodes.INTERNAL_ERR,"doAnswerBody setRemoteDescription error: "+f.message)}}function Ie(e,t,r){if(!r&&p){var n=a.getLocalStream();if(!n&&(a.videoEnabled||a.audioEnabled)){a.initMediaSource(function(){Ie(e,t)},function(e,t){a.showError(a.errCodes.MEDIA_ERR,a.format(a.getConstantString("localMediaError")))});return}}if(oe){a.getFreshIceConfig(function(n){if(n){Oe(e,t,r)}else{a.showError(a.errCodes.CALL_ERR,"Failed to get fresh ice config")}})}else{Oe(e,t,r)}}function Me(e,t,r,n,i){W[e]=true;var a=De(e,true,r,i);var s;if(!a){s="buildPeerConnection failed, call not completed";u(s);throw s}o[e].callSuccessCB=t;o[e].callFailureCB=r;o[e].wasAcceptedCB=n;Le(e)}function Le(e){var t=o[e];if(!t){u("message attempt to send offer for nonexistent peer connection "+e);return}var r=t.pc;var n=t.callFailureCB||a.showError;var i=function i(o){if(t.cancelled){u("initiateSendOffer.setLocalAndSendMessage0.ignored",t.cancelled,t.sendingOffer);return}var s=function r(){t.sendingOffer=false;pe(e,"offer",o,null,t.callFailureCB)};if(m){o.sdp=m(o.sdp)}r.setLocalDescription(o).then(s,function(e){t.sendingOffer=false;n(a.errCodes.CALL_ERR,e)})};if(t.sendingOffer){u("initiateSendOffer.setLocalAndSendMessage0.ignored",t.sendingOffer);return}t.sendingOffer=true;r.createOffer(D).then(i).catch(function(e){t.sendingOffer=false;n(a.errCodes.CALL_ERR,JSON.stringify(e))})}this.call=function(e,t,r,n,i){if(i){if(typeof i==="string"){i=[i]}else if(typeof i.length==="undefined"){a.showError(a.errCodes.DEVELOPER_ERR,"easyrtc.call passed bad streamNames");return}}u("initiating peer to peer call to "+e+" audio="+a.audioEnabled+" video="+a.videoEnabled+" data="+x);if(!a.supportsPeerConnections()){r(a.errCodes.CALL_ERR,a.getConstantString("noWebrtcSupport"));return}var o;if(!i&&p){var s=a.getLocalStream();if(!s&&(a.audioEnabled||a.videoEnabled)){a.initMediaSource(function(){a.call(e,t,r,n)},r);return}}if(!a.webSocket){o="Attempt to make a call prior to connecting to service";u(o);throw o}if(L[e]){n(true,e);Ie(e,L[e],i);a.callCancelled(e,false)}else if(typeof W[e]!=="undefined"){o="Call already pending acceptance";u(o);r(a.errCodes.ALREADY_CONNECTED,o)}else if(oe){a.getFreshIceConfig(function(o){if(o){Me(e,t,r,n,i)}else{r(a.errCodes.CALL_ERR,"Attempt to get fresh ice configuration failed")}})}else{Me(e,t,r,n,i)}};function Ae(e){var t;if(e.active===true||e.ended===false){t=true}else{t=e.getTracks().reduce(function(e){return e.enabled})}return t}var xe={};function Ne(e){xe[e]={candidates:[]}}function je(e){if(W[e]){delete W[e]}if(L[e]){delete L[e]}if(!o[e].cancelled&&o[e].pc){try{o[e].cancelled=true;var t=o[e].pc.getRemoteStreams();for(var r=0;r<t.length;r++){if(Ae(t[r])){ye(e,t[r]);S(t[r])}}o[e].pc.close();u("peer closed")}catch(n){u("peer "+e+" close failed:"+n)}finally{if(a.onPeerClosed){a.onPeerClosed(e)}}}}function Ve(e){u("Hanging up on "+e);Ne(e);if(o[e]){if(o[e].pc){je(e)}if(o[e]){delete o[e]}J();if(a.webSocket){pe(e,"hangup",null,function(){u("hangup succeeds")},function(e,t){u("hangup failed:"+t);a.showError(e,t)})}}}this.hangup=function(e){Ve(e);J()};this.hangupAll=function(){var e=false;for(var t in o){if(!o.hasOwnProperty(t)){continue}e=true;Ve(t)}if(e){J()}};this.doesDataChannelWork=function(e){if(!o[e]){return false}return!!o[e].dataChannelReady};this.getRemoteStream=function(e,t){if(!o[e]){a.showError(a.errCodes.DEVELOPER_ERR,"attempt to get stream of uncalled party");throw"Developer err: no such stream"}else{return se(o[e],e,t)}};this.makeLocalStreamFromRemoteStream=function(e,t,r){var n;if(o[e].pc){n=se(o[e],e,t);if(n){te(n,r)}else{throw"Developer err: no such stream"}}else{throw"Developer err: no such peer "}};this.addStreamToCall=function(e,t,r){if(!t){t="default"}var n=Z(t);if(!n){u("attempt to add nonexistent stream "+t)}else if(!o[e]||!o[e].pc){u("Can't add stream before a call has started.")}else{var i=o[e].pc;o[e].enableNegotiateListener=true;R(n,i);if(r){o[e].streamsAddedAcks[t]=r}}};this.removeStreamFromCall=function(e,t){if(!t){t="default"}var r=Z(t);if(!r){u("attempt to remove nonexistent stream "+t)}else if(!o[e]||!o[e].pc){u("Can't remove stream before a call has started.")}else{var n=o[e].pc;o[e].enableNegotiateListener=true;n.removeStream(r)}};this.dumpPeerConnectionInfo=function(){var e;for(var t in o){if(o.hasOwnProperty(t)){var r=o[t].pc;var n=r.getRemoteStreams();var i=[];for(e=0;e<n.length;e++){i.push(n[e].id)}var a=r.getLocalStreams();var s=[];for(e=0;e<a.length;e++){s.push(a[e].id)}u("For peer "+t);u("    "+JSON.stringify({local:s,remote:i}))}}};function Fe(e){u("Saw onRemote hangup event");Ne(e);if(o[e]){if(o[e].pc){je(e)}else{if(a.callCancelled){a.callCancelled(e,true)}}if(o[e]){delete o[e]}}else{if(a.callCancelled){a.callCancelled(e,true)}}}function Ge(e){var t;for(t in G){if(!G.hasOwnProperty(t)){continue}if(G[t][e]){return true}}return false}this.isPeerInAnyRoom=function(e){return Ge(e)};function Ue(e){var t;for(t in o){if(o.hasOwnProperty(t)&&typeof e[t]==="undefined"){if(!Ge(t)){if(o[t].pc||o[t].isInitiator){Fe(t)}delete L[t];delete W[t];Ne(t)}}}for(t in L){if(L.hasOwnProperty(t)&&!Ge(t)){Fe(t);Ne(t);delete L[t];delete W[t]}}for(t in W){if(W.hasOwnProperty(t)&&!Ge(t)){Fe(t);Ne(t);delete W[t]}}}var Be={};function Je(e,t,r){if(!r){r=100}var n=0;if(Be[e]){clearTimeout(Be[e].timer);n=Be[e].counter}if(n>20){delete Be[e];t()}else{Be[e]={counter:n+1};Be[e].timer=setTimeout(function(){delete Be[e];t()},r)}}function We(e,t){var r=null;var n={};var i;for(i in t){if(t.hasOwnProperty(i)){if(i===a.myEasyrtcid){r=t[i]}else{n[i]=t[i]}}}Ue(n);Je("roomOccupants&"+e,function(){if(j){j(e,n,r)}a.emitEvent("roomOccupants",{roomName:e,occupants:G})},100)}function ze(e,t){var r={};if(t){t(a.ackMessage)}if(e.targetEasyrtcid){r.targetEasyrtcid=e.targetEasyrtcid}if(e.targetRoom){r.targetRoom=e.targetRoom}if(e.targetGroup){r.targetGroup=e.targetGroup}if(e.senderEasyrtcid){a.receivePeerDistribute(e.senderEasyrtcid,e,r)}else{if(B){B(e.msgType,e.msgData,r)}else{u("Unhandled server message "+JSON.stringify(e))}}}function He(e){var t;if(e.indexOf("turn:")===0||e.indexOf("turns:")===0){t=e.split(/[@:&]/g)[1];a._turnServers[t]=true}else if(e.indexOf("stun:")===0||e.indexOf("stuns:")===0){t=e.split(/[@:&]/g)[1];a._stunServers[t]=true}}function qe(e){var t,r,n;ie={iceServers:[]};a._turnServers={};a._stunServers={};if(!e||!e.iceServers||typeof e.iceServers.length==="undefined"){a.showError(a.errCodes.DEVELOPER_ERR,"iceConfig received from server didn't have an array called iceServers, ignoring it")}else{ie={iceServers:e.iceServers}}for(t=0;t<e.iceServers.length;t++){n=e.iceServers[t];if(n.urls&&n.urls.length){if(typeof n.urls==="string"){He(n.urls)}else if(n.urls instanceof Array){for(r=0;r<n.urls.length;r++){He(n.urls[r])}}}else if(n.url){He(n.url)}}}function Ye(e){if(e){if(e.easyrtcsid){a.easyrtcsid=e.easyrtcsid}if(e.field){k=e.field}}}function Ke(e){a.roomData=e;var t,r,n,i,o,s;for(r in a.roomData){if(!a.roomData.hasOwnProperty(r)){continue}if(e[r].roomStatus==="join"){if(!a.roomJoin[r]){a.roomJoin[r]=e[r]}var c=ee();if(c!=={}){a.setRoomApiField(r,"mediaIds",c)}}else if(e[r].roomStatus==="leave"){if(a.roomEntryListener){a.roomEntryListener(false,r)}delete a.roomJoin[r];delete G[r];continue}if(e[r].clientList){G[r]=e[r].clientList}else if(e[r].clientListDelta){i=e[r].clientListDelta.updateClient;if(i){for(o in i){if(!i.hasOwnProperty(o)){continue}if(!G[r]){G[r]=[]}if(!G[r][o]){G[r][o]=i[o]}for(t in i[o]){if(t==="apiField"||t==="presence"){G[r][o][t]=i[o][t]}}}}n=e[r].clientListDelta.removeClient;if(n&&G[r]){for(s in n){if(n.hasOwnProperty(s)){delete G[r][s]}}}}if(a.roomJoin[r]&&e[r].field){de.rooms[r]=e[r].field}if(e[r].roomStatus==="join"){if(a.roomEntryListener){a.roomEntryListener(true,r)}}We(r,G[r])}a.emitEvent("roomOccupant",G)}var $e=function e(t,r){if(!o[t]){return}if(h){r=h(r,true);if(!r){return}}var n=new RTCIceCandidate({sdpMLineIndex:r.label,sdpMid:r.id,candidate:r.candidate});var i=o[t].pc;function s(){u("iceAddSuccess: "+JSON.stringify(r));Pe(r.candidate)}function c(e){a.showError(a.errCodes.ICECANDIDATE_ERR,"bad ice candidate ("+e.name+"): "+JSON.stringify(r))}i.addIceCandidate(n,s,c)};var Xe=function e(t){var r;if(xe[t]){for(r=0;r<xe[t].candidates.length;r++){$e(t,xe[t].candidates[r])}delete xe[t]}};var Qe=function e(t,r){if(o[t]){Ie(t,r,[]);return}var i=function e(i,o){if(o){if(typeof o==="string"){o=[o]}else if(o.length===n){a.showError(a.errCodes.DEVELOPER_ERR,"accept callback passed invalid streamNames");return}}u("offer accept="+i);delete L[t];if(i){if(!a.supportsPeerConnections()){a.showError(a.errCodes.CALL_ERR,a.getConstantString("noWebrtcSupport"));return}Ie(t,r,o);Xe(t)}else{pe(t,"reject",null,null,null);Ne(t)}};if(W[t]&&t<a.myEasyrtcid){delete W[t];if(xe[t]){delete xe[t]}if(o[t]){if(o[t].wasAcceptedCB){o[t].wasAcceptedCB(true,t)}delete o[t]}i(true);return}L[t]=r;if(!a.acceptCheck){i(true)}else{a.acceptCheck(t,i)}};function Ze(e){delete W[e];if(xe[e]){delete xe[e]}if(o[e]){if(o[e].wasAcceptedCB){o[e].wasAcceptedCB(false,e)}delete o[e]}}function et(e,t){delete W[e];if(!o[e]){return}var r=!o[e].connectionAccepted;if(r){o[e].connectionAccepted=true;if(o[e].wasAcceptedCB){o[e].wasAcceptedCB(true,e)}}var n=function e(){};var i=function t(r,n){if(o[e]){delete o[e]}a.showError(r,n)};ge(e,n,i);var s=o[e].pc;var c;try{if(v){c=v(t.sdp)}else{c=t.sdp}}catch(f){a.showError(a.errCodes.DEVELOPER_ERR,"sdpRemoteFilter failed case: "+f)}var d=new RTCSessionDescription({type:t.type,sdp:c});if(!d){throw"Could not create the RTCSessionDescription"}u("about to call initiating setRemoteDescription");try{if(v){d=new RTCSessionDescription({type:d.type,sdp:v(d.sdp)})}u("sdp ||  "+JSON.stringify(d));s.setRemoteDescription(d).then(function(){if(s.connectDataConnection){u("calling connectDataConnection(5001,5002)");if(r){s.connectDataConnection(5001,5002)}try{var t;var n=o[e].streamsAddedAcks||{};for(t in n){if(n.hasOwnProperty(t)){n[t](e,t)}}o[e].streamsAddedAcks={}}catch(f){a.showError(a.errCodes.DEVELOPER_ERR,"streamAdded receipt function failed")}}},function(e){u("processAnswer setRemoteDescription failed: ",e)})}catch(l){u("processAnswer setRemoteDescription error: ",l)}Xe(e)}function tt(e,t){if(o[e]&&o[e].pc){$e(e,t)}else{if(!o[e]){xe[e]={candidates:[]}}xe[e].candidates.push(t)}}function rt(e,t){var r=e.senderEasyrtcid;var n=e.msgType;var i=e.msgData;u("received message of type "+n);if(typeof xe[r]==="undefined"){Ne(r)}switch(n){case"sessionData":Ye(i.sessionData);break;case"roomData":Ke(i.roomData);break;case"iceConfig":qe(i.iceConfig);break;case"forwardToUrl":if(i.newWindow){window.open(i.forwardToUrl.url)}else{window.location.href=i.forwardToUrl.url}break;case"offer":Qe(r,i);break;case"reject":Ze(r);break;case"answer":et(r,i);break;case"candidate":tt(r,i);break;case"hangup":Fe(r);Ne(r);break;case"error":a.showError(i.errorCode,i.errorText);break;default:a.showError(a.errCodes.DEVELOPER_ERR,"received unknown message type from server, msgType is "+n);return}if(t){t(a.ackMessage)}}this.updatePresence=function(e,t){a.presenceShow=e;a.presenceStatus=t;if(a.webSocketConnected){pe(null,"setPresence",{setPresence:{show:a.presenceShow,status:a.presenceStatus}},null)}};this.getSessionFields=function(){return k};this.getSessionField=function(e){if(k[e]){return k[e].fieldValue}else{return n}};this.getRoomOccupantsAsArray=function(e){if(!G[e]){return null}else{return Object.keys(G[e])}};this.getRoomOccupantsAsMap=function(e){return G[e]};this.isTurnServer=function(e){return!!a._turnServers[e]};this.isStunServer=function(e){return!!a._stunServers[e]};this.getFreshIceConfig=function(e){var t={msgType:"getIceConfig",msgData:{}};if(!e){e=function e(){}}a.webSocket.json.emit("easyrtcCmd",t,function(t){if(t.msgType==="iceConfig"){qe(t.msgData.iceConfig);e(true)}else{a.showError(t.msgData.errorCode,t.msgData.errorText);e(false)}})};this.joinRoom=function(e,t,r,n){if(a.roomJoin[e]){a.showError(a.errCodes.DEVELOPER_ERR,"Attempt to join room "+e+" which you are already in.");return}var i={roomName:e};if(t){try{JSON.stringify(t)}catch(l){a.showError(a.errCodes.DEVELOPER_ERR,"non-jsonable parameter to easyrtc.joinRoom");throw"Developer error, see application error messages"}var o={};for(var s in t){if(t.hasOwnProperty(s)){o[s]=t[s]}}i.roomParameter=o}var c={roomJoin:{}};var d;var f,u;if(a.webSocket){c.roomJoin[e]=i;f=function t(n,o){d=o.roomData;a.roomJoin[e]=i;if(r){r(e)}Ke(d)};u=function t(r,i){if(n){n(r,i,e)}else{a.showError(r,a.format(a.getConstantString("unableToEnterRoom"),e,i))}};pe(null,"roomJoin",c,f,u)}else{a.roomJoin[e]=i}};this.leaveRoom=function(e,t,r){var n;if(a.roomJoin[e]){if(!a.webSocket){delete a.roomJoin[e]}else{a.setRoomApiField(e);n={};n[e]={roomName:e};pe(null,"roomLeave",{roomLeave:n},function(r,n){var i=n.roomData;Ke(i);if(t){t(e)}},function(t,n){if(r){r(t,n,e)}})}}};this.getRoomsJoined=function(){var e={};var t;for(t in a.roomJoin){if(a.roomJoin.hasOwnProperty(t)){e[t]=true}}return e};this.getRoomFields=function(e){return!de||!de.rooms||!de.rooms[e]?n:de.rooms[e]};this.getApplicationFields=function(){return de.application};this.getConnectionFields=function(){return de.connection};this.useThisSocketConnection=function(e){fe=e};function nt(e){var t=e.msgData;u("entered process token");if(t.easyrtcid){a.myEasyrtcid=t.easyrtcid}if(t.field){de.connection=t.field}if(t.iceConfig){qe(t.iceConfig)}if(t.stillAliveInterval){c=t.stillAliveInterval;if(c>0){f()}}if(t.sessionData){Ye(t.sessionData)}if(t.roomData){Ke(t.roomData)}if(t.application.field){de.application=t.application.field}}function it(e,t){var r,n,i;var o=null;if(a.cookieId&&document.cookie){r=document.cookie.split(/[; ]/g);n=a.cookieId+"=";for(i=0;i<r.length;i++){if(r[i].indexOf(n)===0){o=r[i].substring(n.length)}}}var s={apiVersion:a.apiVersion,applicationName:a.applicationName,setUserCfg:Ee(true)};if(!a.roomJoin){a.roomJoin={}}if(a.presenceShow){s.setPresence={show:a.presenceShow,status:a.presenceStatus}}if(a.username){s.username=a.username}if(a.roomJoin&&!l(a.roomJoin)){s.roomJoin=a.roomJoin}if(o){s.easyrtcsid=o}if(A){s.credential=A}a.webSocket.json.emit("easyrtcAuth",{msgType:"authenticate",msgData:s},function(r){var n;if(r.msgType==="error"){t(r.msgData.errorCode,r.msgData.errorText);a.roomJoin={}}else{nt(r);if(a._roomApiFields){for(n in a._roomApiFields){if(a._roomApiFields.hasOwnProperty(n)){$(n)}}}if(e){e(a.myEasyrtcid)}}})}function at(e,t){var n;if(fe){a.webSocket=fe}else if(!a.webSocket){try{C["force new connection"]=true;a.webSocket=r.connect(N,C);if(!a.webSocket){throw"io.connect failed"}}catch(c){a.webSocket=0;t(a.errCodes.SYSTEM_ERROR,c.toString());return}}else{for(n in a.websocketListeners){if(!a.websocketListeners.hasOwnProperty(n)){continue}a.webSocket.removeEventListener(a.websocketListeners[n].event,a.websocketListeners[n].handler)}}a.websocketListeners=[];function i(e,t){a.webSocket.on(e,t);a.websocketListeners.push({event:e,handler:t})}i("close",function(e){u("the web socket closed")});function o(){if(a.myEasyrtcid){if(E(a.webSocket)){a.showError(a.errCodes.SIGNAL_ERR,a.getConstantString("miscSignalError"))}else{t(a.errCodes.CONNECT_ERR,a.getConstantString("noServer"))}}else{t(a.errCodes.CONNECT_ERR,a.getConstantString("noServer"))}}i("error",o);if(C.reconnection!==false)i("reconnect_failed",o);else i("connect_error",o);function s(r){if(!a.webSocket){a.showError(a.errCodes.CONNECT_ERR,a.getConstantString("badsocket"))}a.webSocketConnected=true;d=0;u("saw socket-server onconnect event");if(a.webSocketConnected){it(e,t)}else{t(a.errCodes.SIGNAL_ERR,a.getConstantString("icf"))}}if(E(fe)){s(null)}else{i("connect",s)}i("easyrtcMsg",ze);i("easyrtcCmd",rt);i("disconnect",function(){a.webSocketConnected=false;J=function e(){};M={};le()})}function ot(e){u("entered checkIceGatheringState");if(o[e]&&o[e].pc&&o[e].pc.iceGatheringState){if(o[e].pc.iceGatheringState==="complete"){a.sendPeerMessage(e,"iceGatheringDone",{});u("sent iceGatherDone message to ",e)}else{setTimeout(function(){ot(e)},500)}}else{u("checkIceGatherState: leaving")}}this.connect=function(e,t,n){if(!r){a.showError(a.errCodes.DEVELOPER_ERR,"Your HTML has not included the socket.io.js library")}if(!fe&&a.webSocket){a.showError(a.errCodes.DEVELOPER_ERR,"Attempt to connect when already connected to socket server");return}ie={};ue=null;M={};xe={};a.applicationName=e;de={rooms:{},application:{},connection:{}};u("attempt to connect to WebRTC signalling server with application name="+e);if(n===null){n=function e(t,r){a.showError(t,r)}}a.setPeerListener(function(e,t,r,n){u("received request to supportHalfIceTrickle");if(o[e]){o[e].supportHalfTrickleIce=true;Xe(e);ot(e)}},"supportHalfTrickleIce");at(t,n)}};return new i});(function(e,t){if(typeof define==="function"&&define.amd){define("easyrtc_app",["easyrtc"],t)}else if(typeof module==="object"&&module.exports){module.exports=t(require("easyrtc"))}else{if(typeof window.easyrtc!=="object"||!window.easyrtc){throw new Error("easyrtc_app requires easyrtc")}e.easyrtc=t(window.easyrtc)}})(this,function(e,t){"use strict";var r=true;e.dontAddCloseButtons=function(){r=false};function n(n,i){var a=i||[],o=i.length,s={},c=null,d=null;function f(t,r){var n;if(t&&!document.getElementById(t)){e.showError(e.errCodes.DEVELOPER_ERR,"The monitor video id passed to easyApp was bad, saw "+t);return false}for(n in r){if(!r.hasOwnProperty(n)){continue}var i=r[n];if(!document.getElementById(i)){e.showError(e.errCodes.DEVELOPER_ERR,"The caller video id '"+i+"' passed to easyApp was bad.");return false}}return true}function u(e){return s[e.id]}function l(e,t){s[e.id]=t}function p(e){var r=u(e);return r===""||r===null||r===t}function m(e){if(a[e]){return document.getElementById(a[e])}else{return null}}function v(t,r){e.setVideoObjectSrc(t,r);if(t.style.visibility){t.style.visibility="hidden"}}function h(t){e.setVideoObjectSrc(t,"");t.style.visibility="hidden"}if(!f(n,a)){throw"bad video element id"}if(n){document.getElementById(n).muted="muted"}e.addEventListener("roomOccupants",function(t,r){var n;for(n=0;n<o;n++){var i=m(n);if(!p(i)){if(!e.isPeerInAnyRoom(u(i))){if(d){d(u(i),n)}l(i,null)}}}});e.setOnCall=function(e){c=e};e.setOnHangup=function(e){d=e};e.getIthCaller=function(e){if(e<0||e>=a.length){return null}var t=m(e);return u(t)};e.getSlotOfCaller=function(t){var r;for(r=0;r<o;r++){if(e.getIthCaller(r)===t){return r}}return-1};e.setOnStreamClosed(function(e){var t;for(t=0;t<o;t++){var r=m(t);if(u(r)===e){h(r);l(r,"");if(d){d(e,t)}}}});e.setAcceptChecker(function(e,t){var r;for(r=0;r<o;r++){var n=m(r);if(p(n)){t(true);return}}t(false)});e.setStreamAcceptor(function(t,r){var n;if(e.debugPrinter){e.debugPrinter("stream acceptor called")}var i;for(n=0;n<o;n++){i=m(n);if(u(i)===t){v(i,r);if(c){c(t,n)}return}}for(n=0;n<o;n++){i=m(n);if(p(i)){l(i,t);if(c){c(t,n)}v(i,r);return}}i=m(0);if(i){e.hangup(u(i));v(i,r);if(c){c(t,0)}}l(i,t)});var g,y,C,S;if(r){g=function t(r){y=r.parentNode;l(r,"");C=document.createElement("div");C.className="easyrtc_closeButton";C.onclick=function(){if(u(r)){e.hangup(u(r));h(r);l(r,"")}};y.appendChild(C)};for(S=0;S<o;S++){g(m(S))}}var R=null;if(e.videoEnabled&&n!==null){R=document.getElementById(n);if(!R){console.error("Programmer error: no object called "+n);return}R.muted="muted";R.defaultMuted=true}}e.easyApp=function(t,r,i,a,o){var s=null,c=null;n(r,i);e.setGotMedia=function(e){s=e};e.setPeerClosedListener(function(t){setTimeout(function(){if(e.getSlotOfCaller(t)>=0&&e.isPeerInAnyRoom(t)){e.call(t,function(){},function(){},function(){})}},1e3)});e.setGotConnection=function(e){c=e};function d(){if(c){c(true,"")}a(e.myEasyrtcid)}function f(){if(s){s(true,null)}if(r!==null){e.setVideoObjectSrc(document.getElementById(r),e.getLocalStream())}function n(t,r){if(c){c(false,r)}else if(o){o(e.errCodes.CONNECT_ERR,r)}else{e.showError(e.errCodes.CONNECT_ERR,r)}}e.connect(t,d,n)}var u=e.getLocalStream(null);if(u){f()}else{e.initMediaSource(f,function(t,r){if(s){s(false,r)}else if(o){o(e.errCodes.MEDIA_ERR,r)}else{e.showError(e.errCodes.MEDIA_ERR,r)}},null)}};return e});